function getQueryStringParams(t){if(null==t)var e=window.location.search.substr(1);else if(t=t.split("?"),null!=t[1])var e=t[1];else var e="";for(var a=e.split("&"),i={},r=0;r<a.length;r++){var n=a[r].split("=");i[n[0]]=Url.decode(n[1])}return i}function convertImageToCanvas(t,e){var a=document.createElement("canvas"),i=t.naturalWidth,r=t.naturalHeight,n=1;return e&&(n=i>r?e/i:e/r),n<1&&(i=parseInt(i*n),r=parseInt(r*n)),a.width=i,a.height=r,a.getContext("2d").drawImage(t,0,0,i,r),a}function convertCanvasToImage(t,e,a){var i=new Image;return i.src=t.toDataURL("image/"+e,a),i}function twoDigits(t){return 0<=t&&t<10?"0"+t.toString():-10<t&&t<0?"-0"+(-1*t).toString():t.toString()}function renderRecaptchas(){chat.captcha.ready()}var $d=$("document"),$b=null,$h=null;$d.ready(function(){$b=$("body"),$h=$("html")}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){for(var a=e||0,i=this.length;a<i;a++)if(this[a]===t)return a;return-1});var supportPunycode=new function(){function t(t){return t-48<10?t-22:t-65<26?t-65:t-97<26?t-97:o}function e(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function a(t,e,a){var i;for(t=a?Math.floor(t/c):t>>1,t+=Math.floor(t/e),i=0;t>(o-l)*h>>1;i+=o)t=Math.floor(t/(o-l));return Math.floor(i+(o-l+1)*t/(t+d))}function i(t,e){return t-=(t-97<26)<<5,t+((!e&&t-65<26)<<5)}this.utf16={decode:function(t){for(var e,a,i=[],r=0,n=t.length;r<n;){if(e=t.charCodeAt(r++),55296===(63488&e)){if(a=t.charCodeAt(r++),55296!==(64512&e)||56320!==(64512&a))throw new RangeError("UTF-16(decode): Illegal UTF-16 sequence");e=((1023&e)<<10)+(1023&a)+65536}i.push(e)}return i},encode:function(t){for(var e,a=[],i=0,r=t.length;i<r;){if(e=t[i++],55296===(63488&e))throw new RangeError("UTF-16(encode): Illegal UTF-16 value");e>65535&&(e-=65536,a.push(String.fromCharCode(e>>>10&1023|55296)),e=56320|1023&e),a.push(String.fromCharCode(e))}return a.join("")}};var r=128,n=72,s="-",o=36,c=700,l=1,h=26,d=38,u=2147483647;this.decode=function(e,i){var c,d,p,f,m,g,v,y,b,w,C,$,k,T=[],P=[],S=e.length;for(c=r,p=0,f=n,m=e.lastIndexOf(s),m<0&&(m=0),g=0;g<m;++g){if(i&&(P[T.length]=e.charCodeAt(g)-65<26),e.charCodeAt(g)>=128)throw new RangeError("Illegal input >= 0x80");T.push(e.charCodeAt(g))}for(v=m>0?m+1:0;v<S;){for(y=p,b=1,w=o;;w+=o){if(v>=S)throw RangeError("punycode_bad_input(1)");if(C=t(e.charCodeAt(v++)),C>=o)throw RangeError("punycode_bad_input(2)");if(C>Math.floor((u-p)/b))throw RangeError("punycode_overflow(1)");if(p+=C*b,$=w<=f?l:w>=f+h?h:w-f,C<$)break;if(b>Math.floor(u/(o-$)))throw RangeError("punycode_overflow(2)");b*=o-$}if(d=T.length+1,f=a(p-y,d,0===y),Math.floor(p/d)>u-c)throw RangeError("punycode_overflow(3)");c+=Math.floor(p/d),p%=d,i&&P.splice(p,0,e.charCodeAt(v-1)-65<26),T.splice(p,0,c),p++}if(i)for(p=0,k=T.length;p<k;p++)P[p]&&(T[p]=String.fromCharCode(T[p]).toUpperCase().charCodeAt(0));return this.utf16.encode(T)},this.encode=function(t,c){var d,p,f,m,g,v,y,b,w,C,$,k;c&&(k=this.utf16.decode(t)),t=this.utf16.decode(t.toLowerCase());var T=t.length;if(c)for(v=0;v<T;v++)k[v]=t[v]!=k[v];var P=[];for(d=r,p=0,g=n,v=0;v<T;++v)t[v]<128&&P.push(String.fromCharCode(k?i(t[v],k[v]):t[v]));for(f=m=P.length,m>0&&P.push(s);f<T;){for(y=u,v=0;v<T;++v)$=t[v],$>=d&&$<y&&(y=$);if(y-d>Math.floor((u-p)/(f+1)))throw RangeError("punycode_overflow (1)");for(p+=(y-d)*(f+1),d=y,v=0;v<T;++v){if($=t[v],$<d&&++p>u)return Error("punycode_overflow(2)");if($==d){for(b=p,w=o;C=w<=g?l:w>=g+h?h:w-g,!(b<C);w+=o)P.push(String.fromCharCode(e(C+(b-C)%(o-C),0))),b=Math.floor((b-C)/(o-C));P.push(String.fromCharCode(e(b,c&&k[v]?1:0))),g=a(p,f+1,f==m),p=0,++f}}++p,++d}return P.join("")},this.ToASCII=function(t){for(var e=t.split("."),a=[],i=0;i<e.length;++i){var r=e[i];a.push(r.match(/[^A-Za-z0-9-]/)?"xn--"+supportPunycode.encode(r):r)}return a.join(".")},this.ToUnicode=function(t){for(var e=t.split("."),a=[],i=0;i<e.length;++i){var r=e[i];a.push(r.match(/^xn--/)?supportPunycode.decode(r.slice(4)):r)}return a.join(".")}},chat={loadDelayedSrc:function(){$.each($(".delayed-src"),function(){$(this).removeClass("delayed-src").attr("src",$(this).attr("delayed-src"))})},windowResizeFunctions:[],windowResize:function(){for(var t=0;t<this.windowResizeFunctions.length;t++)this.windowResizeFunctions[t]()},isOpened:function(){return $h.hasClass("supportOpened")},instanceID:!1,type:"support",server:"",staticDomain:"//static.me-talk.ru",siteParams:null,now:function(){return(new Date).getTime()},liteModeDisabledKey:function(){return chat.siteParams?chat.siteParams.id+"::"+chat.siteParams.talkID+"::liteModeDisabled":"liteModeDisabled"},isLiteModeEnabled:function(){return!(storeWithExpiration.get(this.liteModeDisabledKey())||!chat.siteParams||!parseInt(chat.siteParams.params.liteMode))},disableLiteMode:function(){var t=this.isLiteModeEnabled();storeWithExpiration.set(this.liteModeDisabledKey(),1,864e5),t&&chat.activity.start()},prepareHTML:function(t){if(t){var e=$("<div></div>").html(t),a=document.createElement("a");$.each(e.find("img"),function(){var t=$(this);a.href=t.attr("src"),a.href.indexOf(window.location.host)>-1&&t.attr("src",chat.staticDomain+""+t.attr("src"))}),t=e.html()}return t},nodeAjax:{sendedList:{},callback:function(t,e){if(null!=this.callbacks[t])return this.callbacks[t](e),delete this.callbacks[t],!0},notifyAboutCallback:function(t,e){supportStorage.set("websocketAjaxResult",{callbackID:t,data:e}),supportStorage.remove("websocketAjaxResult")},callbacks:{},checkWasSended:function(t){var e=null!=this.sendedList[t];return delete this.sendedList[t],e},wasSended:function(t){null!=this.callbacks[t]&&(this.sendedList[t]=1)},sended:function(t){this.wasSended(t),supportStorage.set("websocketAjaxSended",t,!0),supportStorage.remove("websocketAjaxSended",!0)},sendToSocket:function(t){var e=this;if(chat.listen.websocketAvailable()){if(chat.listen.ws&&1==chat.listen.ws.readyState)return"object"==typeof t.data&&(t.data=JSON.stringify(t.data)),chat.listen.ws.send(JSON.stringify({action:"ajax",data:t})),void this.sended(t.callbackID);if(!t.retry||t.retry<200)return t.retry||(t.retry=0),t.retry++,setTimeout(function(){e.sendToSocket(t)},10)}this.sended(t.callbackID),this.sendByHttp(t,function(a){e.callback(t.callbackID,a)||e.notifyAboutCallback(t.callbackID,a)})},sendByHttp:function(t,e){$.ajax({url:t.url,data:t.data,type:t.method,dataType:"html",headers:t.headers,success:function(t){e&&e(t)}})},sendIfMainListener:function(t){var e=!1;return chat.listen.isMainListener()&&(this.sendToSocket(t),e=!0),e},send:function(t,e){var a=this;if(null==t&&(t={}),t.method||(t.method="GET"),!store.disabled&&"support"==chat.type&&chat.listen.websocketAvailable()){t.callbackID=chat.generateCode(10),t.channel="main",a.callbacks[t.callbackID]=e,t.simpleQuery?a.sendByHttp(t,function(e){a.callback(t.callbackID,e)}):this.sendIfMainListener(t)||(supportStorage.set("websocketAjax",t,!0),supportStorage.remove("websocketAjax",!0),setTimeout(function(){a.checkWasSended(t.callbackID)||a.sendByHttp(t,function(e){a.callback(t.callbackID,e)})},2e3))}else this.sendByHttp(t,e)}},testUrl:function(){return""},copyObject:function(t){return JSON.parse(JSON.stringify(t))},clickOnClose:function(){$(".operatorsSelectBlock:visible").length?chat.operators.closeChangeDialog():RPC.post("close",{})},shortMonthDescrArray:["","янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"],shortMonthDescr:function(t){var e="";return t=parseInt(t),null!=this.shortMonthDescrArray[t]&&(e=this.shortMonthDescrArray[t]),e},contactTypes:{phone:{id:"email",descr:"Мобильный телефон"},email:{id:"email",descr:"Email"},skype:{id:"skype",descr:"Skype"}},client:{data:{},updated:!1,keys:["phone","email","descr","skype","inLcab","haveNoAnswer","customData"],init:function(){var t=this,e=chat.tabs.getClientInfoCache();null!=e?t.data=e:$.each(t.keys,function(){t.data[this]=!1})},update:function(t){if(t){var e=this,a=!1;$.each(e.keys,function(){var i=this;null!=t[i]&&t[i]!=e.data[i]&&(e.data[i]=t[i],chat.actions.listeners.queue("clientField_"+i),a=!0)}),a&&(e.updated=!0,RPC.actions.getContacts(!0),supportStorage.set(chat.tabs.clientInfoKey(),e.data)),chat.tabs.insertClientFeedbackInfo()}},get:function(t){var e=!1,a=null;return null!=this.data[t]?a=this.data:null!=this.data.customData&&null!=this.data.customData[t]&&(a=this.data.customData),null==a||"string"==typeof a[t]&&!a[t].length||(e=a[t]),e}},mute:!1,chatMode:"online",mobile:!1,device:null,defaultAvatar:"/images/support/noavatar.png?3",log:function(t){"undefined"!=typeof console&&console.log(t)},emoji:{init:function(t){if(parseInt(chat.siteParams.params.siteChatOptions.emoji)){var e=$("#emoji-dropdown"),a=e.children("ul"),i=e.children(".tabs");e.bind("dropdown-show",function(){a.children("li.selected").length||a.children("li:first").click()}),$("#emoji-dropdown > .tabs > div > div > img").live("click",function(){$("#chatTextarea").append($(this).clone()).keyup()});for(var r=0;r<emojiList.length;r++)!function(t){var e=$("<li></li>").data("id","emoji_"+t.id).append("<span class='icon "+t.icon+"'></span>").bind("click",function(){var e=$("#"+$(this).data("id"));if(!e.data("init")){e.data("init",!0);for(var a=$("<div></div>"),i=0;i<t.list.length;i++){var r=$(emojione.unicodeToImage(t.list[i]));r.data("emoji",emojione.toShort(t.list[i])),r.appendTo(a)}$(e).html(a)}});a.append(e);var r=$("<div></div>").attr("id","emoji_"+t.id);i.append(r)}(emojiList[r])}else $(".emojiDropdownTrigger").remove()}},browser:{comet:function(t,e){RPC.post("browser",e)},send:{make:function(t,e){if(e={action:"browser",data:e},t.length){var a=encodeURIComponent(t.join("/")),i="/cometPublish?operators="+a+"&cid="+a,r=JSON.stringify(e);chat.nodeAjax.send({url:i,data:r,method:"POST"},function(){"changes"==e.data.action&&RPC.post("browser",{action:"sendChanges"})}),RPC.post("cometPublish",{url:i,data:r})}}},rpcActions:{sendInitialHTMLToOperator:function(t){chat.browser.send.make(t.channels,t)},send:function(t){t=t.data,chat.browser.send.make(t.channels,t)}}},init:function(t){this.type=t,RPC.socket=new easyXDM.Socket({onReady:function(){RPC.post("init",{})},onMessage:RPC.get})},copyrightDisplayed:function(){return!(null==chat.siteParams||null==chat.siteParams.params.copyright||!chat.siteParams.params.copyright.img||!chat.siteParams.params.copyright.img.dark)&&chat.siteParams.params.copyright.show},getInnerCopyrightImage:function(){if(null!=chat.siteParams&&null!=chat.siteParams.params.copyright)return chat.siteParams.params.copyright.img.dark+"?r="+chat.siteParams.dtChange},getPostParams:function(t,e){return e.orgID=chat.siteParams.orgID,e.siteID=chat.siteParams.id,e.talkID=chat.siteParams.talkID,{method:t,lang:chat.siteParams.lang,p:JSON.stringify(e)}},getHeaders:function(t,e){if(null==e&&(e={}),e.action=t,null!=chat.siteParams.currentTitle&&chat.siteParams.currentTitle.length)var a=chat.siteParams.currentTitle.split("\n").join("");else var a=chat.siteParams.currentUrl;var i={"X-Metalk-Action":encodeURIComponent(JSON.stringify(e)),"X-Metalk-Talkid":chat.siteParams.talkID,"X-Metalk-Url":encodeURIComponent(chat.siteParams.currentUrl),"X-Metalk-Org":chat.siteParams.orgID,"X-Metalk-Site":chat.siteParams.id,"X-Metalk-Pageid":encodeURIComponent(chat.activity.pageID)};return a&&a.length&&(i["X-Metalk-Title"]=encodeURIComponent(a.substr(0,300))),chat.siteParams.referrer&&(i["X-Metalk-Referrer"]=chat.siteParams.referrer),null!=chat.siteParams.lcab_session&&chat.siteParams.lcab_session.length&&(i["X-Metalk-Ls"]=chat.siteParams.lcab_session),i},fixFeedbackFormHeight:function(){var t=$("div.supportTabs > .current");t.children(".tabInner").length&&(t=t.children(".tabInner"));var e=t.find(".feedbackContainer:visible"),a="classic"==chat.siteParams.style?2:0;if(e.length&&t.length){var i=t.outerHeight(),r=e.outerHeight(!0)+e.position().top+parseInt(e.children(":visible").last().css("margin-bottom")),n=i-r-a,s=t.find("textarea:visible");if(n>0){if(s.length){var o=parseInt(s.height())+n;o<40&&(o=40),s.css("height",o)}}else if(n<0){if(s.length&&s.height()>40){var o=s.height();return o+=n,o<40&&(o=40),s.height(o),chat.fixFeedbackFormHeight()}chat.initMinSize({width:!1,height:parseInt($b.height())+n*-1,heightWithoutPadding:!0,store:!1})}}if(t.length&&t[0].scrollHeight>t.outerHeight()){var c=$b.height()+t[0].scrollHeight-t.outerHeight()+a;chat.initMinSize({width:!1,height:c,heightWithoutPadding:!0,store:!1})}chat.captcha.fix()},captcha:{isReady:!1,ready:function(){this.isReady=!0,this.render()},selectsImg:[],selectImgDisplayed:function(){for(var t=0;t<this.selectsImg.length;t++)if("visible"==this.selectsImg[t].css("visibility"))return!0;return!1},render:function(){if(this.isReady){var t=$(".g-recaptcha:not(.rendered)");t.length&&($.each(t,function(){$(this).addClass("rendered");var t=$(this).data("form-class-name"),e=grecaptcha.render(this,{sitekey:"6Lc1ICAUAAAAAD81Urqtpo5L0rXIKLbkx6GZ3jHo"});$(this).data("captchaID",e),$(this).find("[name=g-recaptcha-response]").addClass(t)}),this.fix())}},fix:function(){var t=this,e=$(".g-recaptcha:visible");$.each(e,function(){var t=$(this),e=t.children("div").width(),a=t.parent().width()+2,i=a/e;e>a&&t.css({transform:"scale("+i+")","-webkit-transform":"scale("+i+")","transform-origin":"0 0"})}),chat.form.resize(),setTimeout(function(){t.selectsImg=[],$.each($("iframe"),function(){var e=$(this).attr("src");e&&e.indexOf("bframe")!=-1&&t.selectsImg.push($(this).parent().parent())})},2e3)},append:function(t,e){var a=$(t);a.children(".g-recaptcha").length||(a.append($('<div class="g-recaptcha"></div>').data("form-class-name",e)),this.render())},reset:function(t){null==t&&(t=":visible"),$.each($(".g-recaptcha"),function(){if(!t||$(this).is(t)){var e=$(this).data("captchaID");null!=e&&null!=window.grecaptcha&&grecaptcha.reset(e)}})}},onlineChatDisplayed:function(){return!$(".onlineSupport").hasClass("none")},setSupportTitle:function(t){var e=$(".offlineSupport"),a=$(".onlineSupport"),i="none";"offline"==t?(e.removeClass(i),a.addClass(i)):(e.addClass(i),a.removeClass(i));var r={online:$("a.a_chat").children("span.descr").text(),offline:chat.siteParams.params.leadGen.tabTitle},n={desktop:1,tablet:1,mobile:1};for(device in n){var s=chat.siteParams.params.trigger[device];if(null!=s&&"classic"==s.triggerType){r.online=s.onlineText,r.offline=s.offlineText;break}}var o=r[t];$(".supportTitle").children("div").html(o),chat.operators.avatarUpdated()},showOfflineSupport:function(){var t=this;$d.ready(function(){chat.chatMode="offline",$h.addClass("offline").removeClass("online");var e=$(".supportTabs");if(e.children("li.current").hasClass("hideWhenOffline")&&chat.tabs.open(e.children("li:visible").first()),t.toggleDownloadChatButton(),"pmForm"==chat.siteParams.params.leadGen.mode||"html"==chat.siteParams.params.leadGen.mode){chat.operators.closeChangeDialog(),chat.setSupportTitle("offline");var a=$("a.a_chat").children("span.descr"),i=a.html(),r=chat.siteParams.params.leadGen.tabTitle;r&&r.length||(r="Задать вопрос"),i!=r&&(a.data("online-title",i),a.html(r)),chat.initMinSize(),$(".meTalkPM.text").placeholder();var n=$("textarea:visible[name=text]");if(n.length){var s=n.val();null==s||s.length||n.val($(".onlineChat[name=text]").val())}}else if("simulation"==chat.siteParams.params.leadGen.mode){chat.setSupportTitle("online");var o=chat.operators.getCurrent();if(!o||!chat.operators.get(o)){var c=chat.siteParams.defaultOperator;if(c&&chat.operators.get(c))o=c;else{var l=[],h=chat.operators.get();for(var o in h)l.push(o);if(!l.length)return;l=chat.shuffle(l),o=l[0]}}chat.operators.select({operator:o,force:!0})}else t.hideSupportTrigger();chat.windowResize()})},hideSupportTrigger:function(){var t=$("a.a_chat").parent();t.hasClass("none")||(t.addClass("none"),t.hasClass("current")&&$(".supportTabs li:visible:first a").click()),chat.closeSupport(),RPC.post("hideSupportTrigger",{})},showSupportTrigger:function(){$("a.a_chat").parent(".none").removeClass("none").children().click(),RPC.post("showSupportTrigger",{})},toggleDownloadChatButton:function(){var t=$(".download-chat");"online"==chat.chatMode&&chat.messages.history.getIdList().length&&chat.siteParams.params.siteChatOptions.exportByClientAllowed?(chat.copyrightDisplayed()&&$(".descr",t).remove(),t.addClass("show"),$h.addClass("downloadButtonDisplayed")):($h.removeClass("downloadButtonDisplayed"),t.removeClass("show"))},showOnlineSupport:function(){var t=this;$d.ready(function(){$h.addClass("online").removeClass("offline"),chat.setSupportTitle("online"),$(".onlineSupport").removeClass("none"),$(".offlineSupport").addClass("none");var e=chat.siteParams.params.leadGen.mode,a=$("a.a_chat").children("span.descr"),i=a.data("online-title");i&&a.html(i),"simulation"==e&&(chat.operatorAway.away||(chat.onlineSimulation.resetStoreKey(),chat.onlineSimulation.stop())),chat.chatMode="online",t.showSupportTrigger(),t.toggleDownloadChatButton(),chat.initMinSize(),chat.windowResize()})},openSupport:function(){RPC.post("open",{})},closeSupport:function(){RPC.post("close",{})},notifications:{displayed:!1,show:function(t){if(this.displayed)return this.close(function(){chat.notifications.show(t)});var e=$(".chat"),a=$(".chatInner"),i=(a.outerHeight(),e.scrollTop());this.displayed=!0,$(".newNotification .inner").html(t.html);var r=a.children(".newNotification");r.find("textarea,input,select").removeAttr("class").show(),e.scrollTop(i+r.outerHeight());var n=setInterval(function(){chat.messages.updatePaddings()},10);$(".onlineSupport > .newNotification").slideDown(200,function(){clearInterval(n)});var s=$(".newNotification .close");s.unbind("click"),null!=t.onClose&&s.bind("click",t.onClose),chat.windowResize(),chat.messages.updatePaddings()},close:function(t){this.displayed=!1;var e=setInterval(function(){chat.messages.updatePaddings()},10),a=$(".newNotification");a.slideUp(200,function(){clearInterval(e),"absolute"==$(this).css("position")&&(a.children(".inner").empty(),null!=t&&t(),chat.messages.updatePaddings())})}},onlineSimulation:{storeKey:function(){return chat.siteParams.id+"::"+chat.siteParams.talkID+"::startOnlineSimulation"},resetStoreKey:function(){storeWithExpiration.remove(this.storeKey())},started:!1,start:function(){if(!this.started&&"simulation"==chat.siteParams.params.leadGen.mode&&null!=chat.siteParams.params.leadGen.simulation.typingTime){var t=this.storeKey();null==storeWithExpiration.get(t)&&(storeWithExpiration.set(t,1,36e5),this.started=!0,chat.onlineSimulation.askForContacts())}},stop:function(){var t=chat.onlineSimulation;t.onSendMessage=function(){},t.started=!1},onSendMessage:function(){},isOnline:function(){return chat.operators.isOnline(chat.operators.getCurrent())},getCheckContacts:function(){return parseInt(this.isOnline()?chat.siteParams.params.leadGen.simulation.checkContacts:chat.siteParams.params.leadGen.offlineSimulation.checkContacts)},askForContacts:function(){var t=chat.onlineSimulation;t.simulateMessage("askContacts",function(e){1==e.code&&setTimeout(function(){t.onSendMessage=function(e){var a=e.text.indexOf("@")!=-1||e.text.replace(/[^0-9]/g,"").length>=5;!t.getCheckContacts()||e.contacts||a?(a&&RPC.actions.changeContacts({contacts:e.text}),t.started&&(t.simulateMessage("afterContacts"),t.stop()),t.onSendMessage=function(t){chat.operatorAway.getActivity()||RPC.actions.changeContacts({contacts:t.text})}):chat.messages.operatorTyping(chat.operators.getCurrent(),!1)}},300)})},simulateMessage:function(t,e){var a=this;setTimeout(function(){var i=chat.operators.getCurrent();chat.messages.operatorTyping(i,!1),setTimeout(function(){$.post("/LAPI/me-talk/api.php",chat.getPostParams("askForSimulateMessage",{type:t,operator:chat.operators.getCurrent(),online:a.isOnline()?1:0}),function(t){1==t.alreadyHaveContacts&&a.stop(),chat.listen.start({cid:"main"}),null!=e&&e(t)})},1e3*chat.siteParams.params.leadGen.simulation.typingTime)},1e3*chat.siteParams.params.leadGen.simulation.waitForTyping)}},operatorAway:{timeout:null,activityKey:function(){return"operator::activity::"+chat.siteParams.id},getActivity:function(){var t=this.activityKey(),e=storeWithExpiration.get(t);return e=null!=e},setActivity:function(){var t=this.activityKey();storeWithExpiration.set(t,1,9e5),this.stop()},away:!1,start:function(t){var e=this,a=parseInt(chat.siteParams.params.leadGen.simulation.delay);a>0&&(clearTimeout(this.timeout),this.away||this.getActivity()||(t||(a*=1e3),this.timeout=setTimeout(function(){e.away=!0,chat.siteParams.params.leadGen.mode="simulation",chat.operators.refresh(""),chat.fixFeedbackFormHeight(),chat.onlineSimulation.start()},a)))},stop:function(){this.away=!1,clearTimeout(this.timeout),chat.showOnlineSupport()}},triggerBadge:{getIDList:function(){var t=supportStorage.get("badge::"+chat.siteParams.id);null==t&&(t={});for(var e in t){var a=parseInt(e.substr(2));null==chat.messages.history.get(a)&&delete t[e]}return t},setIDList:function(t){supportStorage.set("badge::"+chat.siteParams.id,t),this.updated()},getCount:function(){var t=this.getIDList(),e=0;for(var a in t)e++;return e},incr:function(t){var e=this.getIDList();e["id"+t]=1,this.setIDList(e),this.updated()},empty:function(){var t=this.getIDList();clearInterval(this.emptyInterval),this.setIDList({});var e=0;for(var a in t){var i=parseInt(a.substr(2));i>e&&(e=i)}e&&chat.messages.sendMessageStatus(e,"readed")},emptyInterval:null,updated:function(){var t=this,e=t.getCount();e>0&&($b.bind("mousemove touchstart",t.mousemove),clearInterval(t.emptyInterval),t.emptyInterval=setInterval(function(){0==t.getCount()&&t.mousemove()},3e3)),RPC.post("badgeUpdated",{value:e})},mousemove:function(){chat.triggerBadge.empty(),$b.unbind("mousemove touchstart",chat.triggerBadge.mousemove)}},actions:{actionsQueue:[],available:function(){return!0},init:function(){this.available()&&(this.listeners.init(),this.filters.init(),chat.siteParams.params.actionBlocks&&this.initQueue.make())},initQueue:{filtersToArray:function(t){var e=[];if(t)for(var a in t)for(var i in t[a])e.push({name:a,operation:i,value:chat.actions.filters.initialPrepareValues(chat.actions.filters.getType(a),t[a][i])});return e},make:function(){var t=chat.actions,e=[],a=chat.siteParams.params.actionBlocks;for(i=0;i<a.length;i++)for(var r=a[i],n=this.filtersToArray(r.filters),s=r.subFilters,o=0;o<s.length;o++){var c={};if(r.filters)for(var l in r.filters)c[l]=!0;var h=s[o];h.filterGroupsThatMustNotMatch=[];var d=this.filtersToArray(h.filters);if(d.length)for(var u=0;u<d.length;u++){var p=d[u].name;if(c[p]=!0,"scrollToElement"==p)for(var f=0;f<d[u].value.length;f++)e.push(d[u].value[f])}else for(var m=0;m<s.length;m++)if(s[m].filters){for(var l in s[m].filters)c[l]=!0;var g=this.filtersToArray(s[m].filters);g.length&&h.filterGroupsThatMustNotMatch.push(g)}for(var v in h.actionTypes){var y=h.actionTypes[v];y.filterGroupsThatMustNotMatch=h.filterGroupsThatMustNotMatch,y.filters=n.concat(d);for(var b in c)t.listeners.add(b,y);y.repeat&&"afterTime"==y.repeat[0]&&t.listeners.add("timeOnPage",y),t.listeners.add("zero",y);for(var w=0;w<y.actions.length;w++)y.actions[w].type=v}}e.length&&RPC.post("initScrollToElementSelectors",{selectors:e})}},run:{now:0,start:function(t){this.now=parseInt(chat.now()/1e3),this.prepareRunTimeForActionsList(t.actions);for(var e=[],a=0;a<t.actions.length;a++)this.canRun.check(t.actions[a],t)&&e.push(t.actions[a]);if(e.length){if(null!=t.repeat){this.setRunTime(t.actions,this.now),e=chat.shuffle(e);var i=[e[0]]}else var i=e;this.make(i,t)}},make:function(t,e){for(var a=this,i=(a.now,0),r=[],n=!1,s=[],o=0;o<t.length;o++)!function(o){var c=chat.generateCode(10),l=t[o];n=l.type;var h=null;if(null!=a.types[l.type]&&(h=a.types[l.type](l,e,o)),h){h.queue||(h.queue=[h]);for(var d=0;d<h.queue.length;d++)!function(t){var e=h.queue[t];e.actionID=l.id,e.runID=c;var a=e.regAutoAction;if(a.type=l.type,a.actionID=l.id,a.timeout=e.timeout,s.push(a),delete e.regAutoAction,e.action){r.push(e);var n=e.timeout;n+=1*t,n<=0&&(n=.001),e.timeout+=e.simulateTyping,setTimeout(function(){chat.listen.writeCometToCacheMain([e])},1e3*n),i=e.timeout}}(d)}}(o);s.length>0&&("sendTextMessageToClient"==n&&(chat.actions.filters.incr("autoMessageToClientCount"),chat.actions.filters.incr("autoMessageToClientCountAtVisit")),s.length>0&&chat.onReady(function(){chat.nodeAjax.send({url:"/regAutoAction",method:"POST",data:JSON.stringify({talkID:chat.siteParams.talkID,orgID:chat.siteParams.orgID,siteID:chat.siteParams.id,actions:s})},function(t){})},"liteMode"))},types:{showTabMouseMove:function(){clearTimeout(chat.autoCloseTimeout),$b.unbind("mousemove touchstart",chat.actions.run.types.showTabMouseMove)},showTab:function(t){var e=this,a=chat.isOpened(),i=!1;if("object"==typeof t.tabID){var r=t.tabID[0];t.tabID[1]&&t.tabID[1].showReviewsForm&&(i=parseInt(t.tabID[1].showReviewsForm))}else var r=t.tabID;var n=chat.tabs.getTabParams(r);if(n){if(!chat.isOpened()&&t.sound&&t.sound.length&&chat.playSound(t.sound),chat.listen.actions.showTab({tabID:r}),i?chat.rate.showForm():chat.rate.hideForm(),!a){var s=parseInt(t.autoClose);clearTimeout(chat.autoCloseTimeout),s&&(chat.autoCloseTimeout=setTimeout(function(){chat.closeSupport(),e.showTabMouseMove()},1e3*s),$b.bind("mousemove touchstart",e.showTabMouseMove))}return{regAutoAction:{}}}},setTarget:function(t){var e=chat.targetClient.send([t.reason]);if(e)return{regAutoAction:{}}},hideTrigger:function(t){RPC.post("hideTrigger",{reason:"autoAction"})},showTrigger:function(t){RPC.post("showTrigger",{reason:"autoAction"})},toggleTabVisible:function(t,e){for(var a=0;a<t.tabID.length;a++)chat.tabs.setTabVisible(t.tabID[a],e)},setTabInvisible:function(t){this.toggleTabVisible(t,0)},setTabVisible:function(t){this.toggleTabVisible(t,1)},toggleOperatorsGroup:function(t,e){for(var a=0;a<t.groupID.length;a++){var i=t.groupID[a];if(i){var r=chat.operators.getGroup(i);if(r){var n=e?0:1;n!=r.hidden&&(r.hidden=n,chat.operators.refreshWithLastData())}}}},showOperatorsGroup:function(t,e){this.toggleOperatorsGroup(t,1)},hideOperatorsGroup:function(t,e){this.toggleOperatorsGroup(t,0)},toggleOperator:function(t,e){for(var a=0;a<t.operator.length;a++){var i=t.operator[a];if(i){var i=chat.operators.get(i);if(i){var r=e?0:1;null!=i.hiddenOnThisPage&&r==i.hiddenOnThisPage||(i.hiddenOnThisPage=r,chat.operators.refreshWithLastData())}}}},showOperator:function(t,e){this.toggleOperator(t,1)},hideOperator:function(t,e){this.toggleOperator(t,0)},getTextForSendTextMessageToClient:function(t){for(var e=[],a=0;a<t.text.length;a++){var i=t.text[a].type,r=t.text[a].text;"html"==i&&(t.text[a].notInBubble&&(r="%block%"+r),r="%html%"+r);var n=this.getVariablesForText();for(var s in n)if(!n[s]&&r.indexOf("["+s+"]")>-1)return!1;var o=this.getVariablesForText();for(s in o)r=r.split("["+s+"]").join(o[s]);var c=a>0?t.text[a].delay:0,l=0;l=a>0?c:t.typing?3:0,e.push({text:r,type:i,typing:l,delay:0==a?0:c})}return e},getVariablesForText:function(){var t=chat.actions.filters;return{searchKeyword:t.get("searchKeyword"),city:t.get("city_lang"),ip:t.get("ip"),name:chat.client.get("descr")}},sendTextMessageToClient:function(t,e,a){var i=this.getTextForSendTextMessageToClient(t);if(i){var r=0;if("online"==chat.chatMode||"simulation"==chat.siteParams.params.leadGen.mode){var n={queue:[]},s=!1;if(null!=t.priorityOperators)for(var o=0;o<t.priorityOperators.length;o++){var c=t.priorityOperators[o];if(chat.operators.isOnlineAndVisible(c)){s=c;break}}s||(s=chat.operators.current),s||(s=chat.shuffle(chat.operators.getOnlineList())[0]),$.each($(".autoMessage_"+t.id),function(){var t=$(this).data("id");if(t){var e=chat.messages.history.get(t);e&&e.answered||chat.messages.history.remove(t)}});for(var l=0;l<i.length;l++){var h=i[l],d=h.typing,u=h.delay;h=h.text;var p=chat.messages.maxID+1;chat.messages.maxID<p&&(chat.messages.maxID=p);var f="autoMessage";if(chat.messages.history.removeByText(h,f),chat.actions.filters.set("timeFromLastAutoMessageToClient"),s){var m={operator:chat.operators.getOperatorDisplayParams(s).name};for(key in m)h=h.split("["+key+"]").join(m[key]);var g=!1,v=t.notify;if(v&&v.length){var y=chat.actions.filters.get("device");g="desktop"==y&&v.indexOf("silentDesktop")>-1||"desktop"!=y&&v.indexOf("silentMobile")>-1}g&&(d=0);var b=new Date;b.setHours(b.getHours()-chat.messages.timeOffset()),"any"!=t.senderType&&(RPC.actions.setOperator({login:s}),"onlyOperator"==e.senderType&&chat.operators.balancer.disable()),1!=l||r||(r+=u);n.queue.push({timeout:r,action:"message",dt:b.toMysqlFormat(),text:h,from:s,id:p,silent:g,messageType:f,fromCache:g,other:{stackWithPrevious:l>0?1:0,autoMessageID:t.id},instanceID:chat.instanceID,simulateTyping:t.typing?d:0,delayMinus:d,regAutoAction:{operator:s,text:h}}),r+=d}}return n}if("pmForm"==chat.siteParams.params.leadGen.mode){chat.actions.filters.set("timeFromLastAutoMessageToClient");for(var h=[],o=0;o<i.length;o++)h.push(i[o].text);return chat.tabs.drawPmUserHTML(chat.prepareHTML(h.join("<br />"))),chat.tabs.openByType("chat"),chat.openSupport(),{regAutoAction:{}}}}}},prepareRunTimeForActionsList:function(t){for(var e=null,a=0;a<t.length;a++){var i=this.getRunTime(t[a]);i>e&&(e=i)}for(var a=0;a<t.length;a++)t[a].runTime=e},clearRunAtThisPage:function(){for(var t=0;t<chat.actions.actionsQueue.length;t++)for(var e=0;e<chat.actions.actionsQueue[t].list.length;e++)chat.actions.actionsQueue[t].list[e].runAtThisPage=null},setRunTime:function(t,e){for(var a=0;a<t.length;a++)t[a].runAtThisPage=!0,t[a].runTime=e,supportStorage.set("art::"+t[a].id,e),this.setRunAtThisVisit(t[a].id)},getRunTime:function(t){var e=supportStorage.get("art::"+t.id);return null!=e&&(e=parseInt(e)),e},setRunAtThisVisit:function(t){var e=supportStorage.get("visitID");e||(e=chat.initVisitID()),supportStorage.set("r_a_v::"+t,e)},canRun:{isRunAtThisVisit:function(t){var e=supportStorage.get("visitID");return e||(e=chat.initVisitID()),supportStorage.get("r_a_v::"+t)==e},check:function(t,e){var a=t.runTime,i=chat.actions.run.now,r=!0;if(a&&null!=e.repeat)if("afterTime"==e.repeat[0]){var n=chat.actions.filters.secondsToInt(e.repeat[1].repeatSeconds);i-a<n&&(r=!1)}else"newPage"==e.repeat[0]?1==t.runAtThisPage&&(r=!1):"newVisit"==e.repeat[0]?this.isRunAtThisVisit(t.id)&&(r=!1):r=!1;if(r&&null!=this[t.type]&&(r=this[t.type](t)),null!=t.senderType){if(null==t.priorityOperators){t.priorityOperators=[];var s=t.senderType;if("onlyOperator"==s||"priorityOperator"==s)t.priorityOperators.push(t.sender);else if("onlyGroup"==s||"priorityGroup"==s){for(var o=chat.operators.getOperatorsOfGroup(t.sender),c=0;c<o.length;c++)t.priorityOperators.push(o[c].username);t.priorityOperators=chat.shuffle(t.priorityOperators)}"onlyOperator"!=s&&"onlyGroup"!=s||(t.operatorsNeedOnline=t.priorityOperators)}t.operatorsNeedOnline&&(chat.actions.filters.check("operatorOnline","=",t.operatorsNeedOnline)||(r=!1))}return r},sendTextMessageToClient:function(t){return 0!=chat.actions.run.types.getTextForSendTextMessageToClient(t)}}},listeners:{listeners:{},_queue:[],started:!1,lock:{dontRunTime:!1,key:function(){return"actions::lock::"+chat.siteParams.id},interval:!1,make:function(){supportStorage.set(this.key(),JSON.stringify({id:chat.instanceID,time:chat.now()}),!0)},keep:function(){var t=this;clearInterval(this.interval),this.interval=setInterval(function(){t.make()},1e3)},set:function(t){var e=this;if(e.dontRunTime){var a=e.dontRunTime-chat.now();if(a>0)return setTimeout(function(){e.set(t)},a)}var i=chat.now(),r=supportStorage.get(this.key());r&&(r=JSON.parse(r)),r&&i-r.time>2e3&&(r=!1),r?r.id!=chat.instanceID?setTimeout(function(){e.set(t)},50):(e.keep(),t()):(e.make(),setTimeout(function(){e.set(t)},50))},unset:function(t){var e=this;this.set(function(){clearInterval(e.interval),e.dontRunTime=chat.now()+300,supportStorage.remove(e.key(),!0),t()})}},init:function(){},start:function(){return!this.started&&(this.started=!0,!0)},stop:function(){this.started=!1,this._queue.length&&this.make()},enabled:!0,enable:function(){if(store.disabled)return!1;var t=this;if(!chat.operators.isInited())return setTimeout(function(){t.enable()},200);this.enabled=!0;for(var e in this.listeners)this.queue(e)},disable:function(){
this.enabled=!1},queue:function(t){this.enabled&&this.listeners[t]&&this._queue.indexOf(t)==-1&&(this._queue.push(t),this.make())},get:function(t){return this.listeners[t]?this.listeners[t]:[]},checkFilters:function(t){for(var e=!0,a=0;a<t.length;a++){var i=chat.actions.filters.check(t[a].name,t[a].operation,t[a].value);if(!i){e=!1;break}}return e},make:function(){var t=this;t._queue.length&&t.start()&&t.lock.set(function(){for(;filterName=t._queue.shift();)for(var e=t.get(filterName),a=0;a<e.length;a++){var i=e[a],r=t.checkFilters(i.filters);if(r){if(i.filterGroupsThatMustNotMatch&&i.filterGroupsThatMustNotMatch.length){r=!0;for(var n=0;n<i.filterGroupsThatMustNotMatch.length&&(r=!t.checkFilters(i.filterGroupsThatMustNotMatch[n]),r);n++);}r&&chat.actions.run.start(i)}}t.lock.unset(function(){t.stop()})})},add:function(t,e){null==this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].indexOf(e)==-1&&this.listeners[t].push(e)}},filters:{localFilters:{date:!0,timeOnPage:!0,mouseLeavePage:!0,scrollPercentage:!0,scrollPX:!0,scrollToElement:!0,device:!0,url:!0,currentPageTitle:!0,device:!0,searchKeyword:!0,referer:!0,dayOfWeek:!0,timeRange:!0,colOperatorsOnline:!0,operatorOnline:!0,newMessageFromClient:!0},timeFilters:{timeFromLastAutoMessageToClient:!0,timeOnPage:!0,timeFromLastMessage:!0,visitStartTime:!0},timeRangeFilters:{timeRange:!0},notEmptyFilters:{ip:!0,city:!0,country:!0,region:!0,colOperatorsOnline:!0,windowWidth:!0,windowHeight:!0},values:{},secondsToInt:function(t){return parseInt(t.seconds)*parseInt(t.multiply)},getType:function(t){var e=chat.siteParams.filterTypes[t];return null==e&&(e="text"),e},timeToInt:function(t,e,a){return 3600*parseInt(t)+60*parseInt(e)+parseInt(a)},check:function(t,e,a){if("zero"==t)return!0;var i=this.getType(t),r="";null==i&&(i="text");var n="int"==i||"seconds"==i||"date"==i,s="text"==i;n&&(r=0),this.isNotEmptyFilter(t)&&(r=null);var o=this.get(t,r),c=!1;if("object"==typeof o&&null!=o)var l=o;else var l=[o];if(n){for(var h in l)l[h]=parseInt(l[h]);for(var h in a)"date"==i&&"string"==typeof a[h]?a[h]=this.prepareDate(a[h]):a[h]=parseInt(a[h])}else if(s){for(var h in l)"string"==typeof l[h]&&(l[h]=l[h].toLowerCase());for(var h in a)"string"==typeof a[h]&&(a[h]=a[h].toLowerCase())}for(var d=0,u=0;u<l.length;u++){var p=l[u];if(null==p&&this.isNotEmptyFilter(t))break;if("="==e)if("timeRange"==i){var f=this.timeToInt(p[3],p[4],p[5]),m=this.timeToInt(a[0][0][0],a[0][0][1],a[0][0][2]),g=this.timeToInt(a[0][1][0],a[0][1][1],a[0][1][2]);if(g>m)f>=m&&f<=g&&d++;else if(m>g){var v=this.timeToInt(23,59,59),y=0;(f>=m&&f<=v||f>=y&&f<=g)&&d++}}else"searchKeyword"==t?chat.searchKeyword.check(p)&&d++:a.indexOf(p)!=-1&&d++;else if("!="==e)if("searchKeyword"==t){if(chat.searchKeyword.check(p))return!1;d++}else{if(a.indexOf(p)!=-1)return!1;d++}else{if("empty"==e||"not empty"==e){var b=null!=p&&0!=p&&p.toString().length;return"not empty"==e&&b||"empty"==e&&!b}for(var h in a)if("like"==e)p.indexOf(a[h])!=-1&&d++;else if("not like"==e){var w=p.indexOf(a[h])==-1;if(!w)return!1;d++}else if(">"==e)p>a[h]&&d++;else if("<"==e)p<a[h]&&d++;else if("beginWith"==e)0==p.indexOf(a[h])&&d++;else if("notBeginWith"==e){if(0==p.indexOf(a[h]))return!1;d++}else if("endWith"==e){var C=p.lastIndexOf(a[h]);C!=-1&&p.lastIndexOf(a[h])==p.length-a[h].length&&d++}else if("notEndWith"==e){var C=p.lastIndexOf(a[h]);if(C!=-1&&p.lastIndexOf(a[h])==p.length-a[h].length)return!1;d++}}}return c=d>0},incr:function(t,e){null==e&&(e=1);var a=parseInt(this.get(t,0));return a+=e,this.set(t,a),a},decr:function(t,e){return null==e&&(e=-1),this.incr(t,e)},isLocalFilter:function(t){return null!=this.localFilters[t]},isTimeFilter:function(t){return null!=this.timeFilters[t]},isNotEmptyFilter:function(t){return null!=this.notEmptyFilters[t]},set:function(t,e){var a=this;if(!this.getFiltersFromStorageDone){var i=this.getFiltersFromStorage();if(null==i)return void setTimeout(function(){a.set(t,e)},100)}if(this.isTimeFilter(t)&&(e=this.now()),this.values[t]!=e){if(this.values[t]=e,!this.isLocalFilter(t)){var r=$.extend({},this.values);for(var n in r)this.isLocalFilter(n)&&delete r[n];supportStorage.set("fv::"+chat.siteParams.id,JSON.stringify(r))}chat.actions.listeners.queue(t)}},now:function(){return parseInt(chat.now()/1e3)},prepareDate:function(t){if("string"==typeof t){var e=t.split(".");e=[[parseInt(e[2]),parseInt(e[1]),parseInt(e[0])]]}else var e=this.getTimeRangeValueFromDateObject(t);return e[0][1]<10&&(e[0][1]="0"+e[0][1]),e[0][2]<10&&(e[0][2]="0"+e[0][2]),parseInt(e[0][0]+""+e[0][1]+e[0][2])},nowDate:function(){return this.prepareDate(new Date)},get:function(t,e){if(this.getFiltersFromStorageDone||this.getFiltersFromStorage(),0==t.indexOf("clientField_")){t=t.split("clientField_")[1];var a=chat.client.get(t);return a}var a=this.values[t];if(null!=a)var i=a;else var i=e;if(this.isTimeFilter(t)){var r=this.now();i=r-parseInt(i)}return i},getTimeRangeValueFromDateObject:function(t){return[[t.getFullYear(),t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds()]]},initDate:function(){this.set("date",this.nowDate())},initDayOfWeek:function(){var t=new Date,e=t.getDay();0==e&&(e=7);var a=[e.toString()];e<6?a.push("12345"):a.push("67"),this.set("dayOfWeek",a),this.set("timeRange",this.getTimeRangeValueFromDateObject(t))},timeEventsInterval:null,getFiltersFromStorageDone:!1,getFiltersFromStorage:function(){if(!chat.siteParams)return null;var t=supportStorage.get("fv::"+chat.siteParams.id);t=t?JSON.parse(t):{};for(var e in t)this.isLocalFilter(e)?delete t[e]:chat.actions.listeners.queue(e);return this.values||(this.values={}),this.values=$.extend({},this.values,t),this.getFiltersFromStorageDone=!0,t},init:function(){var t=this;this.getFiltersFromStorage(),t.initDayOfWeek(),clearInterval(this.timeEventsInterval),this.timeEventsInterval=setInterval(function(){t.initDayOfWeek(),t.initDate();for(var e in t.timeFilters)chat.actions.listeners.queue(e);chat.actions.listeners.queue("zero")},1e3)},initialPrepareValues:function(t,e){for(var a in e)if("seconds"==t)"object"==typeof e[a]&&(e[a]=chat.actions.filters.secondsToInt(e[a]));else if("timeRange"==t)for(var i in e[a])if("string"==typeof e[a][i]){var r=e[a][i].split(":");e[a][i]=[parseInt(r[0]),parseInt(r[1]),parseInt(r[2])]}return e}}},messages:{maxID:0,chatTextareaValue:function(t){var e=$("#chatTextarea");if(null==t){var t=$("<div></div>").html(e.html());return $.each($(".emojione",t),function(){var t=$(this);t.after(t.attr("alt")),t.remove()}),t.text()}e.html(t).keyup().trigger("textchange")},cometTypePublishTimeout:null,count:0,receiveCount:0,sendCount:0,getLastDiv:function(){return $(".chatInner").children(".message,.chatInfoBlock").filter(":last")},dateFromString:function(t){if("string"==typeof t){t=t.split(" "),t[0]=t[0].split("-"),t[1]=t[1].split(":");var e=new Date(t[0][0],t[0][1]-1,t[0][2],t[1][0],t[1][1],t[1][2]);return e}return t},timeOffsetCache:null,timeOffset:function(){if(null!=this.timeOffsetCache)return this.timeOffsetCache;var t=new Date,e=-t.getTimezoneOffset()/60-3;return this.timeOffsetCache=e,e},sendMessageStatus:function(t,e){chat.onReady(function(){chat.nodeAjax.send({url:"/setMeTalkMessageStatus",method:"POST",data:JSON.stringify({status:e,id:t}),headers:{"X-Metalk-Org":chat.siteParams.orgID,"X-Metalk-Site":chat.siteParams.id,"X-Metalk-Talkid":chat.siteParams.talkID}},function(t){})},"liteMode")},newRealMessageInChat:function(){chat.actions.filters.set("timeFromLastMessage")},receive:function(t){chat.tabs.openByType("chat");var e=this.timeOffset();if("object"==typeof t.dt)var a=t.dt;else{var a=this.dateFromString(t.dt);a.setHours(a.getHours()+e)}t.type||this.count++;var i=!0;null!=t.type&&"autoMessage"==t.type||this.receiveCount++,null!=t.sound&&(i=t.sound),"simulated"==t.type&&(chat.onlineSimulation.started=!0),t.type||(chat.operators.balancer.disable(),chat.operatorAway.setActivity(),this.newRealMessageInChat()),this.removeOperatorTyping(null,0),chat.operators.closeChangeDialog();var r="forward"!=t.type;t.type||chat.operators.setTalkWithOperator(t.operator,r),chat.operators.getCurrent()!=t.operator&&chat.operators.select({operator:t.operator,force:!0,remember:!0}),t.deliveryReport&&this.sendMessageStatus(t.id,"delivered");var n={from:t.operator,text:t.text,dt:a,id:t.id,type:t.type,other:t.other};this.history.add(n),n.receiveNow=!0,this.show(n),t.id>0&&"autoMessage"!=t.type&&chat.lastReceiveMessageID.set(t.id);var s=chat.operators.getOperatorDisplayParams(t.operator);if(t.avatar=s.avatar,t.operatorName=s.name,RPC.post("receiveMessage",t),!t.silent){chat.triggerBadge.incr(t.id),i&&chat.playSound(chat.siteParams.params.newMessageNotification.sound);var o=chat.siteParams.params.newMessageNotification.action,c=this.formatText(t.text,"operator",t.type,t.other);if("html"==c.type&&(chat.siteParams.mobile?c.text="Новое сообщение от консультанта":o="open"),"open"==o)chat.openSupport(),RPC.post("startPulsate",{});else{var l={},h=$("<div></div>").html(emojione.toImage(c.text));$.each($(h).find(".emojione"),function(){var t=$(this);l[t.attr("alt")]=t.clone().wrap("<div>").parent().html()}),RPC.post("showNewMessage",{message:$("<div></div>").html(c.text).text(),textType:c.type,name:s.name,avatar:s.avatar,emoji:l})}}},getContactsBeforeChat:{ask:function(t,e){if($(".askForContactsType_contacts").html(chat.siteParams.params.online.collectContactsBeforeStartMessage),$(".askForContactsType").hide(),$(".askForContactsType_"+e).show().addClass("lastVisible"),"questionCategory"==e)$(".askForContactsForm > .contacts:not(.none)").hide();else{var a=!1;for(var i in chat.siteParams.params.online.collectContacts){a=!0;break}a||$(".askForContactsForm.contacts").remove(),$(".askForContactsForm > .contacts:not(.none)").show()}$(".askForContactsForm[name=type]").val(e),$(".askForContactsForm[name=text]").val(t),$(".onlineSupportChatArea,.me-talk-copyright-chat").hide(),$(".askForContacts").show(),chat.fixFeedbackFormHeight()},send:function(t){var e=this;$(t).attr("disabled","disabled");var a=$.form.get("askForContactsForm",!1);a.requireContacts="contacts"==a.type?1:0,$.post("/LAPI/me-talk/api.php",chat.getPostParams("setClientContacts",a),function(a){if(1==a.code){supportStorage.set("cbc_"+chat.siteParams.id,1),chat.client.update(a.info),chat.messages.send(),$(".askForContacts").hide(),$(".onlineSupportChatArea,.me-talk-copyright-chat").show();var i=$("#chatTextarea").data("resize");null!=i&&i()}else $(t).removeAttr("disabled"),a.retry=function(){e.send(t)},chat.alert.show(a)},"json")}},contactsNotificationCallback:function(){var t=this,e={contact:$.form.get("contactsNotification",!1)};e.descr=e.contact.descr,e.important=0,$(".contactsNotification[name=eulaAgreement]").length&&!e.contact.eulaAgreement?chat.alert.show({code:801,descr:"Требуется согласие на обработку персональных данных",retry:function(){t.contactsNotificationCallback()}}):($.post("/LAPI/me-talk/api.php",chat.getPostParams("changeClientContacts",e),function(t){1==t.code&&chat.client.update(t.info)},"json"),chat.siteParams.refuseEnterName=1,RPC.post("refuseEnterName",{}),chat.notifications.close())},send:function(t,e,a){var i=this;if(!chat.siteParams)return setTimeout(function(){i.send(t)},1e3);i.removeOperatorTyping(null,0),i.clearTyping(),chat.listen.start({cid:"main"});var r=!1;if(null==t){var t=chat.messages.chatTextareaValue();r=!0}if(t=$.trim(t),t.length&&t!=$("#chatTextarea").attr("placeholder")){if(!supportStorage.get("cbc_"+chat.siteParams.id,1)&&chat.actions.filters.check("timeFromLastMessage",">",[3600])){var n=chat.siteParams.params.leadGen.questionCategories;if("beforeStart"==chat.siteParams.params.online.collectContactsMode)return this.getContactsBeforeChat.ask(t,"contacts");if(n.ask&&n.list.length&&!chat.operatorAway.getActivity())return this.getContactsBeforeChat.ask(t,"questionCategory")}r&&chat.messages.chatTextareaValue("");var s=chat.operators.getCurrent();a||RPC.post("clientSendMessage",{text:t,operator:s});var o=new Date;if(t=emojione.shortnameToUnicode(t),!e)var c={from:"client",text:t,dt:o},l=i.show(c);chat.operators.setTalkWithOperator(s),chat.operators.balancer.isEnabled(function(a){var r=-1;"online"==chat.chatMode||chat.onlineSimulation.started?r=chat.siteParams.params.leadGen.simulation.delay:"offline"==chat.chatMode&&"simulation"==chat.siteParams.params.leadGen.mode&&(r=8),chat.disableLiteMode(),$.post("/LAPI/me-talk/api.php",chat.getPostParams("sendMessageToOperator",{text:t,operator:s,messages:i.count,url:chat.siteParams.currentUrl,operatorActivity:chat.operatorAway.getActivity()?1:0,chatMode:chat.chatMode,forceOfflineModeDelay:r,systemMessage:!1,simulationStarted:chat.onlineSimulation.started?1:0,needBalance:a?1:0,selectedGroup:chat.operators.getCurrentGroup(),messageType:!!e&&e}),function(a){if(!e){if(chat.siteParams.params.siteChatOptions.disallowSiteInIframe){var r=new Date;r.setTime(r.getTime()+36e5);var n=r.toGMTString();chat.cookie.set("openSupportAtNewPage",1,n)}if(1==a.code){if(i.newRealMessageInChat(),a.balancedOperator&&(chat.operators.balancer.disable(),chat.operators.select({operator:a.balancedOperator})),chat.lastReceiveMessageID.set(a.id),a.contacts=parseInt(a.contacts),chat.onlineSimulation.onSendMessage({text:t,contacts:a.contacts}),!i.receiveCount&&a.phoneSupport&&chat.siteParams.params.phoneSupport.waitMessage.length&&(i.receiveCount++,i.show({from:chat.operators.getCurrent(),dt:r,text:chat.siteParams.params.phoneSupport.waitMessage})),c.id=a.id,$("#text_"+l).attr("id","text_"+c.id),i.history.add(c),supportStorage.set("sendMessage",chat.now()),"afterStart"==chat.siteParams.params.online.collectContactsMode){var s=[];for(key in chat.siteParams.params.online.collectContacts)chat.client.get(key)||s.push(key);if(s.length&&!a.enterName&&null==chat.siteParams.refuseEnterName&&!chat.notifications.displayed){var o=$("#contactsNotification").detach();o.find("input").bind("keyup",function(t){13==t.keyCode&&i.contactsNotificationCallback()}),o.find("button").bind("click",function(){i.contactsNotificationCallback()});for(var h in chat.siteParams.params.online.collectContacts)o.find(".row."+h).removeClass("none");chat.notifications.show({html:o,onClose:function(){chat.siteParams.refuseEnterName=1,RPC.post("refuseEnterName",{})}})}}"offline"==chat.chatMode?setTimeout(function(){chat.onlineSimulation.start()},8e3):chat.operatorAway.start(),setTimeout(function(){chat.actions.filters.set("newMessageFromClient",t),setTimeout(function(){chat.actions.filters.get("newMessageFromClient")==t&&chat.actions.filters.set("newMessageFromClient",null)},2e3)},1e3)}else 599==a.code&&chat.listen.actions.setBan({ban:1})}},"json")})}this.count++,this.sendCount++},history:{clear:function(){for(var t=this.getIdList(),e=0;e<t.length;e++)this.remove(t[e]);chat.messages.showHistory()},idListKey:function(){return chat.siteParams.id+"::"+chat.siteParams.talkID+"::history"},messageKey:function(t){return chat.siteParams.id+"::"+chat.siteParams.talkID+"::message::"+t},getIdList:function(t){null==t&&(t={});var e=storeWithExpiration.get(this.idListKey());if(null==e?e=[]:"number"==typeof e&&(e=[e]),null!=t.last){var a=0;e=e.reverse();var i=[];for(key in e){if(a==t.last)break;i.push(e[key]),a++}e=i.reverse()}return e},edit:function(t,e){var a=this.get(t);a&&(a.text=e,supportStorage.set(this.messageKey(t),a))},removeFromMemory:function(t){t=parseInt(t);var e=this.getIdList(),a=e.indexOf(t);a!=-1&&(e.splice(a,1),supportStorage.remove(this.messageKey(t)),this.saveIdList(e),supportStorage.set("removeMessage",t))},remove:function(t){this.removeFromMemory(t),this.removeFromHTML(t)},removeFromHTML:function(t){var e=$("#text_"+t),a=$(e).parent();a.children(".text").length<2?a.remove():e.remove(),chat.messages.scrollBottom()},showOneMoreMessage:function(){var t=$(".message > .text",".chatInner").length;t?t++:t=1,chat.messages.showHistory({last:t,append:!0})},removeByText:function(t,e){var a=0,r=this.idListKey(),n=storeWithExpiration.get(r);null==n&&(n=[]);for(i in n){var s=this.get(n[i]);s&&s.text==t&&s.type==e&&!s.answered&&(chat.messages.history.remove(n[i]),a++)}return a},removeAutoMessagesWithoutAnswer:function(t){for(var e=this.getIdList(),a=0;a<e.length;a++)if(e[a+1]){var i=e[a],r=this.get(i);r&&("autoMessage"!=r.type||r.answered||t==r.other.autoMessageID||(r.pageID==chat.activity.pageID?this.removeFromMemory(r.id):this.remove(r.id)))}},add:function(t){var e=!1;if(null!=t.id&&null==this.get(t.id)){var a=this.getIdList();if(t.pageID=chat.activity.pageID,"client"==t.from&&!t.type)for(var i=!1,r=a.length-1;r>=0;r--){var n=a[r],s=this.get(n);if(!s||"autoMessage"!=s.type||i&&(!s.other||s.other.autoMessageID!=i))break;if(s.answered=1,supportStorage.set(this.messageKey(n),s),!s.other||!s.other.autoMessageID)break;i=s.other.autoMessageID}"autoMessage"==t.type&&this.removeByText(t.text,t.type)&&(e=!0),a.push(t.id),this.saveIdList(a),supportStorage.set(this.messageKey(t.id),t),"autoMessage"==t.type&&this.removeAutoMessagesWithoutAnswer(t.other.autoMessageID)}e&&this.showOneMoreMessage()},saveIdList:function(t){var e=this.idListKey(),a=parseInt(chat.siteParams.params.siteChatOptions.forgetHistory);storeWithExpiration.set(e,t,1e3*a)},get:function(t){return supportStorage.get(this.messageKey(t))}},showHistory:function(t){t||(t={});var e=$(".chatInner"),a=$(".chat"),i=e.height(),r=a.scrollTop(),n=this.history.getIdList(t),s=[".newNotification",".me-talk-copyright"];t.last&&s.push(".userHTML"),t.append||e.children(":not("+s.join(",")+")").remove();for(key in n)this.show(this.history.get(n[key]));var o=e.height();a.scrollTop(r+(o-i))},requestSnippet:function(t,e){chat.onReady(function(){chat.nodeAjax.send({url:"/requestSnippet",method:"POST",data:JSON.stringify({url:t,id:e}),headers:{"X-Metalk-Org":chat.siteParams.orgID,"X-Metalk-Site":chat.siteParams.id,"X-Metalk-Talkid":chat.siteParams.talkID}},function(t){})},"liteMode")},linkify:function(t){var e,a,i,r=this;a=/(https?:\/\/([-\wА-ЯЁ\.]+)+(:\d+)?(\/?([\wА-ЯЁ\/_\%\+\-\.\,\#\=]*((\?|&)\S+)?)?)?)/gim,e=t.replace(a,'<a href="$1" class="linkified" onClick="chat.messages.clickOnLink(this);" target="_blank">[shorten_link]$1[/shorten_link]</a>');var n=e.match(/\[shorten_link\](.*?)\[\/shorten_link\]/gim);for(var s in n)if("string"==typeof n[s]&&0==n[s].indexOf("[shorten_link]")){var o=n[s].replace("[shorten_link]","").replace("[/shorten_link]","");o.length>20&&(o=o.substr(0,30)+"..."),e=e.replace(n[s],o)}var c=$("<div></div>").html(e);return $.each($("a.linkified",c),function(){var t=$(this),e=t.attr("href");e=$.trim(e),t.attr("href",e);var a=chat.generateCode(10);t.addClass("snippet_"+a+" waitingForSnippet"),r.requestSnippet(e,a)}),e=c.html(),i=/([a-zA-Z0-9._-]+@[a-zA-Zа-яА-Я0-9._-]+\.[а-яА-Яa-zA-Z0-9]+)/gim,e=e.replace(i,'<a onClick="chat.messages.clickOnLink(this);" href="mailto:$1">$1</a>')},clickOnLink:function(t){$.post("/LAPI/me-talk/api.php",chat.getPostParams("clientClickOnLink",{link:$(t).attr("href")}),function(t){},"html")},show:function(t){if(!(null==t||t.id&&$("#text_"+t.id).length)){chat.toggleDownloadChatButton();var e=this,a=$(".chatInner"),i=!1;if(t.id?parseInt(t.id)>chat.messages.maxID&&(chat.messages.maxID=parseInt(t.id)):t.id=chat.generateCode(10),null!=t.text&&t.text){null==t.other&&(t.other={}),t.other.receiveNow=t.receiveNow;var r=this.formatText(t.text,t.from,t.type,t.other),n=r.text;if(r.empty)return void $b.append("<div class='none'>"+n+"</div>");i=r.block;var n="<div class='text' id='text_"+t.id+"'>"+n+"</div>"}else var n="";if(n=emojione.unicodeToImage(n),"client"==t.from)var s="client",o="Вы";else{var c=chat.operators.get(t.from);if(c)var o=c.fio;else var o="Оператор";var s="operator"}if(i)i=$("<div />").addClass("chatInfoBlock").css({position:"relative",paddingBottom:"15px",paddingTop:"15px"}).html(n).appendTo(a),i.data("id",t.id),t.other&&t.other.authMessageID&&i.addClass("autoMessage_"+t.other.autoMessageID);else{var l=$("<div />");l.attr("from",t.from),l.data("id",t.id),l.attr("type",t.type?t.type:""),l.addClass("message from_"+s);var h=$("<div />").addClass("username "+s).html(o),d=!1;if(null!=t.dt&&0!=t.dt)u=this.formatDT(t.dt),d=this.getDateFromDT(t.dt),u=$("<div class='date c'>"+u+"</div>");else var u="";l.data("date",d);var p=!(!t.other||!parseInt(t.other.stackWithPrevious)),f=this.getLastDiv();f.attr("from")==t.from&&f.data("date")==d&&("autoMessage"!=t.type&&"autoMessage"!=f.attr("type")||p)?("classic"!=chat.siteParams.style&&(u=""),f.append("<div class='clear'></div>").append(u).append(n)):(l.append(h).append(u).append(n).appendTo(a),l.find(".text").addClass("first")),$(".afterMessageFiller").remove(),$("<div class='afterMessageFiller none'>&nbsp;</div>").appendTo(a),this.count>=3&&"online"==chat.chatMode&&this.showRateNotification(),t.other&&t.other.autoMessageID&&l.addClass("autoMessage_"+t.other.autoMessageID)}return a.find(".message, .chatInfoBlock").first().addClass("first"),a.find(".message.last:not(:last)").removeClass("last"),a.find(".message:last").addClass("last"),this.updatePaddings(),setTimeout(function(){e.scrollBottom(t.receiveNow)},100),t.id}},showRateNotification:function(t){if(null==chat.siteParams.refuseSendRate&&$("div[id^='tab'][data-type=reviews]:not(.hiddenTab)").length){var e=$("<div />"),a=$("<p></p>").text("Оцените нашу работу"),i=function(t){chat.notifications.close(),RPC.actions.openReviewsTab(),chat.rate.refuseSendRate(),$(".rateOperator[name=rate]").val(t)};if("2"==chat.siteParams.params.rate.values)$("<i class='icon-thumbs-up greenText'></i>").bind("click",function(){i("good")}).appendTo(a),$("<i class='icon-thumbs-down redText icon-rotate-180'></i>").bind("click",function(){i("bad")}).appendTo(a);else if("5"==chat.siteParams.params.rate.values)for(var r=1;r<=5;r++){var n=$("<i class='star star-"+r+" icon-star-o' data-value='"+r+"'></i>").bind("mouseover",function(){for(var t=parseInt($(this).data("value")),e=1;e<=t;e++)$(".star-"+e).addClass("icon-star star-hover").removeClass("icon-star-o")}).bind("mouseout",function(){$(".star").removeClass("icon-star star-hover").addClass("icon-star-o")}).bind("click",function(){i($(this).data("value")+"/5")});n.appendTo(a)}e.append(a),chat.notifications.displayed&&!t||chat.notifications.show({html:e,onClose:function(){chat.rate.refuseSendRate()}})}},updatePaddings:function(){if("support"==chat.type){var t=$(".chat"),e=$(".chatInner"),a=parseInt(t.height());"classic"==chat.siteParams.style&&(a-=parseInt(t.css("padding-top"))+parseInt(t.css("padding-bottom")));var i=e.css("padding-top");i||(i=0),i=parseInt(i);var r=i,n=parseInt(e.outerHeight());a>=n?i+=a-n:i-=n-a,i<0&&(i=0);var s=e.scrollTop(),o=i-r;e.css("padding-top",i).scrollTop(s-o),t.perfectScrollbar("update")}},getDateObjectFromDt:function(t){if("string"==typeof t){var e=t.substr(0,4),a=t.substr(5,2)-1,i=t.substr(8,2),r=parseInt(t.substr(11,2))+3+chat.messages.timeOffset(),n=t.substr(14,2),s=t.substr(17,2);t=new Date(e,a,i,r,n,s)}return"object"==typeof t&&null==t.getHours&&(t=new Date),t},getDateFromDT:function(t){t=this.getDateObjectFromDt(t);var e=t.getFullYear(),a=t.getMonth(),i=t.getDate();return a<10&&(a="0"+a),i<10&&(i="0"+i),e+"-"+a+"-"+i},formatDT:function(t,e){t=this.getDateObjectFromDt(t);var a=new Date,i=t.getHours(),r=t.getMinutes(),n=t.getMonth()+1,s=t.getDate(),o=t.getFullYear();if(i<10&&(i="0"+i),r<10&&(r="0"+r),n<10&&(n="0"+n),s<10&&(s="0"+s),a.toDateString()==t.toDateString())var t=i+":"+r;else if(e)var t=s+"."+n+"."+o+" "+i+":"+r;else var t=i+":"+r+"<div class='date_sub fs9'>"+s+" "+chat.shortMonthDescr(n)+"</div>";return t},formatDate:function(t){t=this.getDateObjectFromDt(t);var e=t.getMonth()+1,a=t.getDate(),i=t.getFullYear();e<10&&(e="0"+e),a<10&&(a="0"+a);var t=a+"."+e+"."+i;return t},formatText:function(t,e,a,i){if("tab"==a&&i&&("string"==typeof i&&(i=JSON.parse(i)),null!=i.tab)){var r=i.tab.button?i.tab.button:"Просмотреть";t="%html%%block%<div class='infoMessageInChat'><div class='title mb10'>"+i.tab.title+"</div><button onClick='chat.tabs.showTab("+JSON.stringify(i.tab)+")' class='b'>"+r+"</button></div>",i.receiveNow&&"show"==i.tab.showType&&chat.tabs.showTab(i.tab)}"string"!=typeof t&&(t=t.toString()),e||(e="client");var n="text",s=0;"client"!=e&&0==t.indexOf("%html%")&&(n="html");var o=0;if("text"==n){t=$("<div/>").text(t).html(),t=t.split("\n").join("\n<br />");var c=t.substr(-6,-1);"<br />"==c&&(t=t.substr(0,-6)),t=this.linkify(t)}else{t=t.substr(6),0==t.indexOf("%block%")&&(t=t.substr(7),s=1);try{var l=$("<div />").html(t)}catch(t){var l=$("<div></div>")}l.find("a[href],form").attr("target","_blank");var h=l.find("img");h.css({"max-width":"100%",height:"auto"}).attr("onload","chat.messages.updatePaddings();"),t=l.html(),t=chat.prepareHTML(t),l.text().length||h.length||(s=1,o=1)}return{text:t,block:s,type:n,empty:o}},scrollBottom:function(t){chat.messages.updatePaddings();var e=$(".chat");if(e.length){var a=e.height(),i=e[0].scrollHeight-a;if(t&&a){var r=$(".chatInner").children(".message,.chatInfoBlock").last().children(".text").last();if(r.length){var n=r.position().top+r.parent().position().top;i=n;var s=$(".me-talk-copyright-chat");s.is(":visible")&&(i-=s.height()+5)}}e.stop().animate({scrollTop:i},400)}},clearTyping:function(){clearTimeout(this.cometTypePublishTimeout),this.cometTypePublishTimeout=null},operatorTypingTimeout:{},operatorTyping:function(t,e,a){a||(a=5e3),null==e&&(e=!1),e&&chat.operatorAway.setActivity();var i=chat.siteParams.params.siteChatOptions.hideOperatorTyping;if(i&&(i=parseInt(i)),!i){var r=chat.operators.getOperatorDisplayParams(t);r&&RPC.post("operatorTyping",{operator:r,typing:1,text:"Печатает сообщение"});var n=this,s=this.getLastDiv(),o=$(".operatorTyping.typing_"+t);if(!o.length){if(o=$(".operatorTyping.temp").clone().removeClass("temp").addClass("typing_"+t),s.attr("from")==t)s.append(o);else{this.show({from:t});var s=this.getLastDiv();s.append(o)}o.show(),this.scrollBottom()}clearTimeout(this.operatorTypingTimeout[t]),this.operatorTypingTimeout[t]=setTimeout(function(){n.removeOperatorTyping(t)},a)}},removeOperatorTyping:function(t,e){if(clearTimeout(this.operatorTypingTimeout[t]),null==e&&(e=200),null!=t)var a=$(".typing_"+t);else var a=$(".operatorTyping:not(.temp)");if(RPC.post("operatorTyping",{typing:0}),a.length){a.hide();var i=a.parent().children(".text");0==i.length?a.parent().remove():(a.remove(),i.filter(":first").addClass("first")),chat.messages.updatePaddings()}}},pm:{show:function(t){},lcab:{send:function(t){var e=this;$(t).attr("disabled","disabled");var a=$.form.get("lcabPM",!1);chat.disableLiteMode(),$.post("/LAPI/me-talk/api.php",chat.getPostParams("sendLcabPM",a),function(i){i.retry=function(){e.send(t)},chat.alert.show(i),1==i.code&&($(t).removeAttr("disabled"),$("textarea.lcabPM").attr("value",""),chat.pm.show(a.text))},"json")}},metalk:{send:function(t){var e=this,a=$("#metalkPmSend"),i=$.form.get("meTalkPM",!1);return $(".allowSms:visible").length&&!i.allowSms?void chat.alert.show({code:1,descr:"Пожалуйста, подтвердите возможность отправки сообщений для Вас"}):(a.attr("disabled","disabled"),chat.disableLiteMode(),void $.post("/LAPI/me-talk/api.php",chat.getPostParams("sendLcabMetalk",i),function(r){r.retry=function(){e.send(t)},chat.alert.show(r),a.removeAttr("disabled"),1==r.code&&(chat.captcha.reset(),chat.messages.newRealMessageInChat(),chat.client.update(r.info),$("textarea.meTalkPM").attr("value",""),t||RPC.post("clientSendMessage",{text:i.text,operator:!1}),chat.pm.show(i.text))},"json"))}}},listen:{ws:null,started:{},getListenNowKey:function(t){if(null!=chat.siteParams)var e="listennow::"+chat.siteParams.id+"::"+chat.siteParams.talkID+"::"+t;else var e="listennow::"+t;return e},isListeningNow:function(t){if(store.disabled)return!1;var e=storeWithExpiration.get(this.getListenNowKey(t));return e},isMainListener:function(){return this.isListeningNow("main")==chat.instanceID},setListenNow:function(t,e,a,i){if(!chat.isLiteModeEnabled()){var r=this;if(store.disabled)return!a||a(!0);null==e&&(e=4e3);var n=r.isListeningNow(t);if(!n||i&&n==chat.instanceID)return storeWithExpiration.set(r.getListenNowKey(t),chat.instanceID,e,!0),!!a&&setTimeout(function(){a(r.isListeningNow(t)==chat.instanceID)},30)}return!!a&&a(!1)},stop:function(t,e){if(this.started[t]=!1,!e){if(store.disabled)return!1;var a=this.isListeningNow(t);a==chat.instanceID&&storeWithExpiration.remove(this.getListenNowKey(t),!0)}},getCometCacheKey:function(t){return null!=chat.siteParams?"cometcache::"+chat.siteParams.id+"::"+t:"cometcache::"+t},writeCometToCacheMain:function(t){var e=chat.siteParams.channelDate;null==e&&(e=1),e=parseInt(e),e+=1;var a=chat.siteParams.channelEtag;null==a&&(a=0),a++,this.writeCometToCache("main",e,a,t),this.listenMainCacheIntervalCallback()},writeCometToCache:function(t,e,a,i){if(store.disabled)return!1;var r=this.getCometCacheKey(t),n=storeWithExpiration.get(r);null==n&&(n=[]),n.push({date:e,etag:a,data:i}),storeWithExpiration.set(r,n,6e4,!0)},getCometFromCache:function(t,e,a){if(store.disabled)return!1;e||(e=0),a||(a=0);var i=[],r=!1,n=!1,e=parseInt(e),s=storeWithExpiration.get(this.getCometCacheKey(t));for(var o in s){var c=parseInt(s[o].date);if(null==e||c>e){r=s[o].etag,n=s[o].date;for(var l in s[o].data){if("string"==typeof s[o].data[l])try{s[o].data[l]=JSON.parse(s[o].data[l])}catch(t){}s[o].data[l]&&null!=s[o].data[l].action&&(s[o].data[l].fromCache=null==s[o].data[l].instanceID||s[o].data[l].instanceID!=chat.instanceID,i.push(s[o].data[l]))}}}return!!i.length&&{data:i,etag:r,date:n}},currentChannelDate:{},currentChannelEtag:{},callback:function(t,e,a,i,r,n){var s=chat.listen;if(null!=e)if(r||s.writeCometToCache(t,e,a,i),"main"==t){chat.siteParams.channelEtag=a,chat.siteParams.channelDate=e;var o=chat.siteParams.id+"::date",c=chat.siteParams.id+"::etag";(!r||supportStorage.get(o)<e||supportStorage.get(o)==e&&supportStorage.get(c)<a)&&(supportStorage.set(o,e),supportStorage.set(c,a),RPC.post("channelUpdate",{etag:a,date:e}))}else s.currentChannelDate[t]=e,s.currentChannelEtag[t]=a,r||(supportStorage.set(t+"::date",e),supportStorage.set(t+"::etag",a));for(var l=0;l<i.length;l++){var h={};if("string"==typeof i[l]&&i[l].length)var h=JSON.parse(i[l]);else if("object"==typeof i[l])var h=i[l];null!=h.action&&("function"!=n?s.receiveMessage(h):n(h))}},listentMainCacheInterval:null,listenMainCacheIntervalCallback:function(){},websocketAvailable:function(){return!chat.siteParams.mobile&&null!=window.WebSocket&&!storeWithExpiration.get("disallowWebsocket")},start:function(t){$this=this;chat.generateCode(10);if(!chat.siteParams)return setTimeout(function(){$this.start(t)},5);var e=this.websocketAvailable(),a=t.cid,i=t.once;t.callback;if(null==a&&(a="main"),"main"==a&&null==this.listenMainCacheInterval&&(this.listenMainCacheIntervalCallback=function(){var e=$this.getCometFromCache(a,chat.siteParams.channelDate,chat.siteParams.channelEtag);e&&$this.callback(a,e.date,e.etag,e.data,!0,t.callback)},this.listenMainCacheIntervalCallback(),this.listenMainCacheInterval=setInterval(this.listenMainCacheIntervalCallback,500)),null==this.started[a]||!this.started[a]){if(this.started[a]=!0,null==i&&(i=!1),i||"main"!=a||RPC.post("listenStart",{}),"main"==a){if(e)var r="/WS_cometUserListen?cid="+encodeURIComponent(a)+"&org="+encodeURIComponent(chat.siteParams.orgID)+"&site="+encodeURIComponent(chat.siteParams.id)+"&talkid="+encodeURIComponent(chat.siteParams.talkID)+"&siteID="+encodeURIComponent(chat.siteParams.id);else var r="/cometUserListen?id=KJ8sa0",n={"X-Metalk-Org":chat.siteParams.orgID,"X-Metalk-Site":chat.siteParams.id,"X-Metalk-Talkid":chat.siteParams.talkID,"X-Who-Knows":a};var s=chat.siteParams.channelDate,o=chat.siteParams.channelEtag}else{if(e)var r="/WS_cometListen?cid="+encodeURIComponent(a);else var r="/cometListen?id=sau822j",n={"X-Who-Knows":a};if(null!=$this.currentChannelDate[a])var s=$this.currentChannelDate[a];else var s=supportStorage.get(a+"::date");if(null!=$this.currentChannelEtag[a])var o=$this.currentChannelEtag[a];else var o=supportStorage.get(a+"::etag")}s||(s=0),r+="&time="+encodeURIComponent(s),o||(o=0),r+="&tag="+encodeURIComponent(o);
var c=e?4e3:3e4;$this.setListenNow(a,c,function(i){if(i)if(e){c=3e3;var l=setInterval(function(){chat.listen.setListenNow(a,c,null,!0)},c-1500),h="https:"==window.location.protocol?"wss":"ws";if("8088"==window.location.port)var d=":8088";else var d="";chat.listen.ws=new WebSocket(h+"://"+window.location.hostname+d+r),RPC.post("websocketStarted",{url:r}),chat.listen.ws.onmessage=function(e){supportStorage.set("ws_works",1,!0);var i=$.parseJSON(e.data),r=i.text;null==r[0]&&(r=[r]),$this.callback(a,i.time,i.tag,r,!1,t.callback)},chat.listen.ws.onclose=function(){var e=parseInt(chat.rand(1e4,3e4));clearInterval(l),supportStorage.get("ws_works")||storeWithExpiration.set("disallowWebsocket",1,36e5),setTimeout(function(){$this.stop(a),$this.start(t)},e)},chat.listen.ws.onerror=function(t){chat.listen.ws.close(),clearInterval(l)}}else{var u={url:r,method:"GET",timeout:c,headers:n,dataType:"html"};RPC.post("longPollingStart",u),u.success=function(e,i,r){if($this.stop(a),null!=e&&e.length){e=e.split("\n");var n=[];for(var s in e)if(0==e[s].indexOf("[")){e[s]=$.parseJSON(e[s]);for(var o in e[s])n.push(e[s][o])}else n.push(e[s]);etag=r.getResponseHeader("Etag"),date=r.getResponseHeader("Last-Modified"),$this.callback(a,date,etag,n,!1,t.callback),t.once=!1}$this.stop(a),$this.start(t)},u.error=function(e,i,r){var n=parseInt(chat.rand(1e4,3e4));$this.setListenNow(a,n-500,null,!0),setTimeout(function(){$this.stop(a),$this.start(t)},n)},$.ajax(u)}else if(!$this.isMainListener()){$this.stop(a,!0);var p=500;if("main"!=a){var f=$this.getCometFromCache(a,s,o);f&&$this.callback(a,f.date,f.etag,f.data,!0,t.callback)}setTimeout(function(){$this.start(t)},p)}})}},receiveMessage:function(t){null!=t.action&&(null!=this.actions[t.action]?this.actions[t.action](t):chat.log(JSON.stringify(t)))},actions:{ajaxResponse:function(t){chat.nodeAjax.callback(t.callbackID,t.data)||chat.nodeAjax.notifyAboutCallback(t.callbackID,t.data)},geoip:function(t){if(t.geoip)for(var e=["city","country","region"],a=0;a<e.length;a++){var i=e[a];if(t.geoip[i]){var r=[];for(var n in t.geoip[i])r.push(t.geoip[i][n]);chat.actions.filters.set(i,r),r.length&&(null!=t.geoip[i][chat.siteParams.lang]?chat.actions.filters.set(i+"_lang",t.geoip[i][chat.siteParams.lang]):chat.actions.filters.set(i+"_lang",t.geoip[i].en))}}t.ip&&chat.actions.filters.set("ip",t.ip)},showTab:function(t){chat.openSupport(),chat.tabs.showTab({id:t.tabID})},snippet:function(t){var e=$("a.snippet_"+t.id+".waitingForSnippet").removeClass("waitingForSnippet");if(e.length){var a="";if("image"==t.type){var i=$("<img />");i.attr("onload","chat.messages.scrollBottom();"),i.attr("src",t.snipurl),a=$("<a></a>"),a.attr("target","_blank"),a.attr("href",e.attr("href")),a.html(i),e.hide()}a.length&&e.after($("<div class='snippet "+t.type+"'></div>").html(a)),chat.messages.scrollBottom()}},disableWidget:function(){RPC.post("disableWidget",{}),window.location="about:blank"},browser:function(t){chat.browser.comet(t.data.action,t.data)},message:function(t){var e=function(){chat.messages.receive({dt:t.dt,text:t.text,operator:t.from,id:t.id,type:t.messageType,silent:t.silent,sound:!t.fromCache,deliveryReport:!t.fromCache,other:t.other})};null!=t.simulateTyping&&t.simulateTyping?(this.typing({operator:t.from,real:!1}),setTimeout(function(){e()},1e3*parseInt(t.simulateTyping))):e()},deleteMessage:function(t){t.id&&chat.messages.history.remove(t.id)},selectOperator:function(t){chat.operators.balancer.disable(),chat.operators.setTalkWithOperator(t.operator),chat.operators.select({operator:t.operator,force:!0,remember:!0})},typing:function(t){null==t.real&&(t.real=!0),chat.messages.operatorTyping(t.operator,t.real)},trySimulateMessageForAskContacts:function(){setTimeout(function(){if(!chat.operatorAway.getActivity()){var t=!0;"online"==chat.chatMode?chat.operatorAway.start(t):chat.onlineSimulation.start()}},3e3)},requestRate:function(t){chat.siteParams.refuseSendRate=null,chat.messages.showRateNotification(!0),chat.openSupport()},removeAutoMessage:function(t){},operatorsOnlineUpdatedTimeout:null,operatorsOnlineUpdated:function(t){clearTimeout(this.operatorsOnlineUpdatedTimeout),this.operatorsOnlineUpdatedTimeout=setTimeout(function(){chat.operators.refresh(t.data)},2e3)},changeOperator:function(t){chat.operators.setTalkWithOperator(t.operator),chat.operators.select({operator:t.operator,group:t.group})},editMessage:function(t){var e=chat.messages.formatText(t.text,"operator");$("#text_"+t.id).html(e.text),chat.messages.history.edit(t.id,t.text)},setOperatorActivity:function(t){chat.operatorAway.setActivity()},setBan:function(t){RPC.post("setBan",{ban:t.ban?1:0})}}},getVisitsKey:function(){return"visits::"+chat.siteParams.id},getVisits:function(){var t=supportStorage.get(this.getVisitsKey());return t=t?parseInt(t):0},initVisitID:function(){var t=chat.generateCode(10);return supportStorage.set("visitID",t),t},incrVisits:function(){chat.actions.filters.set("visitStartTime"),chat.actions.filters.set("autoMessageToClientCountAtVisit",0),this.initVisitID(),supportStorage.set(this.getVisitsKey(),chat.getVisits()+1)},getVisitedPagesCount:function(){var t=supportStorage.get("pages_"+chat.siteParams.id);return null==t?0:parseInt(t)},incrVisitedPagesCount:function(){supportStorage.set("pages_"+chat.siteParams.id,this.getVisitedPagesCount()+1)},lastReceiveMessageID:{key:function(){return chat.siteParams.id+"::last::messid"},get:function(){var t=supportStorage.get(this.key());return t||(t=0),parseInt(t)},set:function(t){supportStorage.set(this.key(),t)}},activity:{pageID:!1,start:function(t,e){var a=!this.pageID;this.pageID=chat.generateCode(20),chat.incrVisitedPagesCount(),chat.actions.listeners.disable(),chat.actions.run.clearRunAtThisPage(),chat.actions.filters.set("timeOnPage"),null==chat.actions.filters.get("isTargetClient")&&chat.actions.filters.set("isTargetClient","0");var i="desktop";chat.device.tablet()?i="tablet":chat.device.mobile()&&(i="smartphone"),chat.actions.filters.set("device",i),chat.actions.filters.set("newMessageFromClient",null),chat.actions.filters.set("mouseLeavePage",null),chat.actions.filters.set("scrollPX",null),chat.actions.filters.set("scrollToElement",null),chat.actions.filters.set("scrollPercentage",null),a&&chat.actions.filters.set("colOperatorsOnline",null),chat.actions.filters.set("searchKeyword",chat.searchKeyword.get()),chat.actions.filters.set("previousUrl",chat.actions.filters.get("lastLoadURL"));var r=[chat.siteParams.currentUrl],n=document.createElement("a");n.href=r[0];var s=n.host.split(":")[0];if(r.push(chat.siteParams.currentUrl.split(s).join(supportPunycode.ToUnicode(s))),!n.search)for(var o=r.length,c=0;c<o;c++){var l=!1;l="/"==r[c].substr(-1,1)?r[c].substr(0,r[c].length-1):r[c]+"/",r.indexOf(l)==-1&&r.push(l)}var h=[n.pathname];"/"==h[0].substr(-1,1)&&h.push(h[0].substr(0,h[0].length-1));for(var o=h.length,c=0;c<o;c++)0==h[c].indexOf("/")&&h.push(h[c].substr(1));for(var o=h.length,c=0;c<o;c++)"/"!=h[c].substr(-1,1)&&h.push(h[c]+"/");for(var c=0;c<h.length;c++)n.search&&(h[c]+=n.search),r.indexOf(h[c])==-1&&r.push(h[c]);for(var c=0;c<r.length;c++){var d=decodeURI(r[c]);r.indexOf(d)==-1&&r.push(d)}chat.actions.filters.set("url",r),chat.actions.filters.set("lastLoadURL",r),chat.actions.filters.set("referer",chat.siteParams.referrer),chat.actions.filters.set("currentPageTitle",chat.siteParams.currentTitle),chat.actions.filters.set("pageVisited",chat.getVisitedPagesCount()),chat.actions.filters.set("visits",chat.getVisits()),chat.actions.listeners.enable();var u=!chat.actions.filters.get("city",!1)&&!chat.actions.filters.get("country",!1)&&!chat.actions.filters.get("region",!1),p=chat.siteParams.windowSize,f=chat.getHeaders("startActivity",{lastMessageID:e?chat.lastReceiveMessageID.get():0,geoip:u?1:0,device:i,wW:p.width,wH:p.height});if(chat.isLiteModeEnabled())null!=t&&t();else{var r="/writeMetalkQueue";chat.nodeAjax.send({url:r,method:"GET",headers:f},function(e){null!=t&&t()})}},close:function(){},update:function(){}},operators:{online:[],current:!1,currentGroup:!1,changeDialog:!1,firstTime:!0,isInited:function(){return!this.firstTime},getCurrent:function(){return this.current},getCurrentGroup:function(){return this.currentGroup},getOnlineList:function(){return this.online},get:function(t){if(null!=t)var e=chat.siteParams.operators[t];else var e=chat.siteParams.operators;return null==e&&(e=!1),e},getOperatorsOfGroup:function(t){var e=this.get(),a=[];for(var i in e)e[i].groupID&&e[i].groupID.indexOf(t)>-1&&a.push(e[i]);return a},getGroup:function(t){return chat.siteParams.operatorsGroups[t]},canViewOperator:function(t,e){if(null!=this.getTalkWithOperator(t))return!0;var a=this.get(t);if(!e&&a.tempHidden)return!1;var i=a.groupID;if(i)for(var r=0;r<i.length;r++){var n=this.getGroup(i[r]);if(n&&n.hidden)return!1}return!a.hiddenOnThisPage},isOnlineAndVisible:function(t){return this.isOnline(t)&&this.canViewOperator(t)},getTalkWithOperator:function(t){return storeWithExpiration.get("canTalkWith::"+t)},setTalkWithOperator:function(t,e){if(null==e&&(e=!0),"online"==chat.chatMode){e&&this.setRememberOperator(t);var a=3;storeWithExpiration.set("canTalkWith::"+t,1,36e5*a),this.lastRefreshData[t]=1,this.refreshWithLastData()}},lastRefreshData:{},isOnline:function(t){var e=this.get(t);return!!e&&e.online},setOffline:function(t){chat.siteParams.operators[t]&&(chat.siteParams.operators[t].online=!1)},setOnline:function(t){chat.siteParams.operators[t]&&(chat.siteParams.operators[t].online=!0)},setTempHidden:function(t,e){chat.siteParams.operators[t]&&(chat.siteParams.operators[t].tempHidden=e)},getOperatorDisplayParams:function(t){var e=chat.operators.get(t);e||(e={}),e.avatar||(e.avatar=chat.defaultAvatar);var a=chat.staticDomain+e.avatar;return{username:t,avatar:a,name:e.fio}},offlineModeIfOperatorNotExists:!1,refreshWithLastDataTimeout:null,refreshWithLastData:function(){var t=this;this.firstTime?(clearTimeout(this.refreshWithLastDataTimeout),this.refreshWithLastDataTimeout=setTimeout(function(){t.refreshWithLastData()},100)):this.refresh(this.lastRefreshData)},refresh:function(t){this.firstTime=!1;this.current;if(this.online=[],"string"==typeof t&&(t=t.split("\n"),t=null!=t[2]?JSON.parse(t[2]):null),chat.operatorAway.away||null==t)chat.showOfflineSupport(),RPC.post("listenOperatorsStatus",{online:this.online});else{var e=this.get();for(username in e)this.setOffline(username);this.lastRefreshData=JSON.parse(JSON.stringify(t));for(username in t){var a=parseInt(t[username]);this.offlineModeIfOperatorNotExists&&this.offlineModeIfOperatorNotExists.indexOf(username)==-1&&(t[username]=0),1!=a||this.canViewOperator(username,!0)||(t[username]=a=-1),a==-1?this.setTempHidden(username,1):this.setTempHidden(username,0),this.canViewOperator(username)||(t[username]=!1)}var i=!1;for(username in t)if(t[username]){i=!0;break}i?chat.showOnlineSupport():chat.showOfflineSupport();for(username in t){var r=this.get(username);if(r){var a=parseInt(t[username]);1==a?(this.setOnline(username),this.online.push(username)):a==-1?(this.setOnline(username),chat.operators.canViewOperator(username)&&this.online.push(username)):0==a&&(this.setOffline(username),this.current==username&&"online"==chat.chatMode&&this.setCurrent(!1,!1))}}chat.actions.filters.set("colOperatorsOnline",this.online.length),chat.actions.filters.set("operatorOnline",this.online);var n=this.getRememberOperator();this.current!=n.operator&&this.isOnline(n.operator)&&this.select({operator:n.operator,group:n.group}),RPC.post("listenOperatorsStatus",{online:this.online}),$(".operatorsGroup").addClass("none");for(username in e){var s=$(".operators").find(".operator_"+username.replace(/\W/g,""));this.isOnline(username)?(s.show(),s.parent().parent(".operatorsGroup").removeClass("none")):s.hide()}if(this.detectLastGroup(),!this.current||!this.get(this.current)||!this.isOnline(this.current)){if(!this.online.length)return chat.showOfflineSupport();var o=chat.siteParams.defaultOperator;if(!this.current&&chat.siteParams.params.operators.allowChange&&$(".operatorsGroup:not(.none)").length>1&&chat.operators.change(),o&&this.get(o)&&this.isOnline(o))this.select({operator:o,force:!1,remember:!1}),this.closeChangeDialog();else{var c=Math.floor(Math.random()*this.online.length);this.select({operator:this.online[c],force:!1,remember:!1})}}var l=$(".changeOperator");this.online.length>1&&chat.siteParams.params.operators.allowChange?l.removeClass("none"):l.addClass("none")}},init:function(){var t=this;chat.siteParams.operatorsGroups[!1]={id:!1,descr:"Другие консультанты",hidden:0};var e=0;for(groupID in chat.siteParams.operatorsGroups){e++;var a=chat.operators.getGroup(groupID);a.operators=[];var i=t.get();for(username in i){var r=t.get(username);(a.id&&r.groupID&&r.groupID.indexOf(a.id)!=-1||!a.id&&!r.groupID)&&a.operators.push(r)}}e&&(chat.siteParams.operatorsGroups[!1].descr="Online");var n=$(".operators");n.append("<table style='height:100%; width:100%;' cellpadding='0' cellspacing='0'><tr><td style='height:1px;'><div class='mb15 operatorsGroupSelectTitle'></div></td></tr><tr><td class='relative'><div class='operatorsInner' style='overflow:auto; position:absolute; top:0; left:0; right:0;'></div></td></tr></table>");var s=n.find(".operatorsInner"),o=n.find(".operatorsGroupSelectTitle");e>1?o.text("Выберите отдел и оператора, к которому Вы хотите обратиться:"):o.text("Выберите оператора, к которому Вы хотите обратиться:"),chat.windowResizeFunctions.push(function(){s.height(s.parent().height())});for(groupID in chat.siteParams.operatorsGroups)!function(){var e=chat.operators.getGroup(groupID);if(e.operators.length){var a=$("<div></div>").attr("class","operatorsGroup ha").attr("data-id",e.id),i=($("<div></div>").attr("class","groupTitle").html("<span class='icon icon-caret-right'></span> ").append($("<span></span>").text(e.descr)).bind("click",function(){$(this).parent().toggleClass("opened")}).appendTo(a),$("<div></div>").attr("class","operatorsOfGroup").appendTo(a));for(r in e.operators){var r=e.operators[r].username,n=$("<div />").attr("operator",r).attr("class","operator_"+r.replace(/\W/g,"")).bind("click",function(){if(chat.operators.changeDialog){chat.operators.currentGroup=e.id;var t=chat.siteParams.params.operators.balance.type;chat.operators.select({operator:$(this).attr("operator"),group:e.id}),"smart"==t?chat.operators.balancer.disable():"all"==t&&e.id&&chat.operators.balancer.isEnabled(function(t){t&&$(".operatorNameString","#currentOperatorDiv").html(e.descr)})}}).addClass("operator");if(t.get(r).avatar)var o=t.get(r).avatar;else var o=chat.defaultAvatar;var c=($("<img />").addClass("avatar delayed-src").attr("delayed-src",chat.staticDomain+o).appendTo(n),$("<div />").html("<div class='operatorNameString'>"+t.get(r).fio+"</div>").addClass("operatorNameDisplay").appendTo(n),$("<div />").addClass("operatorStatus").html("<span class='operatorStatusDescr'>Online</span><span class='changeOperator none'>, </span>").appendTo(n));$("<a />").html("сменить оператора").addClass("ajax").attr("onclick","chat.operators.change()").appendTo(c.find(".changeOperator"));n.appendTo(i)}a.appendTo(s)}}()},closeChangeDialog:function(){this.changeDialog=!1,$b.removeClass("changeOperatorOpened");var t=$(".operatorDiv");if(t.not(":visible")&&($(".operators").hide(),t.show(),0==$(".askForContacts:visible").length)){$(".onlineSupportChatArea,.me-talk-copyright-chat").show();var e=$("#chatTextarea").data("resize");null!=e&&e()}},balancer:{disabled:!1,params:function(){return chat.siteParams.params.operators.balance},cookie:function(){return"s_b_d"},disable:function(){if("smart"==this.params().type||"all"==this.params().type){var t=new Date;this.disabled=!0,t.setTime(t.getTime()+36e5);var e=t.toGMTString();chat.cookie.set(this.cookie(),1,e),chat.operators.select({operator:chat.operators.current})}},isEnabled:function(t){var e=!(chat.siteParams.free||"smart"!=this.params().type&&"all"!=this.params().type||this.disabled);e?chat.cookie.get(this.cookie(),function(e){t(!e)}):t(!1)}},setCurrent:function(t,e){if(this.current=t,!e){var a=this.getCurrentGroup();e=this.getOperatorGroup(t,a)}this.currentGroup=e},getOperatorGroup:function(t,e){var a=[],i=chat.siteParams.operatorsGroups;for(var r in i)for(var n=i[r],s=0;s<n.operators.length;s++)if(n.operators[s].username==t){if(r==e)return r;a.push(r)}return!!a.length&&a[0]},select:function(t){var e=this;null==t&&(t={});var a={operator:"",force:!1,remember:!0,group:!1};if($.extend(a,t),a.operator){var e=this;if(e.isOnline(a.operator)||a.force){if(e.current&&e.operatorWasChanged(e.current,a.operator),!a.group){var i=this.getCurrentGroup();a.group=this.getOperatorGroup(a.operator,i)}if(a.group&&chat.operators.getGroup(a.group))var r=chat.operators.getGroup(a.group).descr;else var r="Online";e.setCurrent(a.operator,a.group),e.balancer.isEnabled(function(t){$(".operatorDiv").empty();var i="operator_"+a.operator.replace(/\W/g,""),n=$("."+i).first().clone().attr("id","currentOperatorDiv").removeClass(i);if(t){n.find(".operatorNameString").html(e.balancer.params().smart.descr);var s=e.balancer.params().smart.avatar;s||(s=chat.defaultAvatar),s=chat.staticDomain+s,n.find(".avatar").attr("src",s),n.removeAttr("operator")}else n.find(".operatorStatusDescr").html(r);n.appendTo(".operatorDiv").unbind("click").show(),e.isOnline(a.operator)&&chat.showOnlineSupport(),a.remember&&(e.setRememberOperator(a.operator,a.group),e.closeChangeDialog());var o=$(".onlineChatTextarea").find(".upload");parseInt(e.get(a.operator).canReceiveLinks)>0?o.myShow():o.myHide(),chat.operators.avatarUpdated()})}}},avatarUpdated:function(){var t=!1;if(chat.onlineChatDisplayed()){var t=$("#currentOperatorDiv").find(".avatar").attr("src");if(t){var e=document.createElement("a");e.href=t,t=e.href}}RPC.post("setCurrentOperatorAvatar",{avatar:t})},getRememberOperator:function(){return{operator:chat.siteParams.operator,group:chat.siteParams.group}},setRememberOperator:function(t,e){if(!e){var a=this.getCurrentGroup();e=this.getOperatorGroup(t,a)}chat.siteParams.operator=t,chat.siteParams.group=e,RPC.post("selectOperator",{operator:t,group:e})},detectLastGroup:function(){var t=$(".operatorsGroup");t.removeClass("last").filter(":visible:last").addClass("last"),1==$(".operatorsGroup:visible").length&&t.removeClass("opened").filter(":visible").addClass("opened")},change:function(){var t=this;chat.notifications.close(),$b.addClass("changeOperatorOpened"),$(".operatorDiv, .onlineSupportChatArea, .askForContacts, .me-talk-copyright-chat").hide(),$(".operators").css({display:"block"}),t.detectLastGroup(),this.changeDialog=!0,chat.windowResize()},operatorWasChanged:function(t,e){}},drawCollectContactsForms:function(){var t=chat.siteParams.params.clientDataKeys;$.each($(".contacts_place:not(.ready)"),function(){var e=$(this),a=e.addClass("ready"),i=$("<form onSubmit='return false;'></form>").bind("click",function(){$(this).addClass("clickedOnce")});a.before(i);var r=e.data("collectContacts"),n=e.data("class"),s=n,o=e.data("button"),c=e.data("button-click"),l=e.data("type");if(r&&n){n+=" collectContactField","form"==l&&(n+=" disallowAutoFill");for(var h in r){var d=r[h],u=t[h];if(u&&"0"!=d){var p=$("<div class='inputContainer contacts'></div>");u.icon&&["text","select"].indexOf(u.type)>-1&&p.append('<span class="icon '+u.icon+'"></span>');var f=u.placeholder?u.placeholder:u.descr;if("textarea"==u.type)var m=$("<textarea name='"+h+"' class='customTextarea "+n+"'></textarea>").attr("placeholder",f);else if("select"==u.type){var m=$("<select class='"+n+"' name='"+h+"'></select>"),g=$("<option value=''></option>").text(f);g.appendTo(m);for(var v in u.values){var g=$("<option></option>").text(u.values[v].value).attr("value",u.values[v].value);parseInt(u.values[v].selected)&&g.attr("selected","selected"),g.appendTo(m)}m.bind("change",function(){var t=$(this);""==t.val()?t.addClass("notFilled"):t.removeClass("notFilled")}).change()}else if("date"==u.type){var m=$("<div class='"+u.type+"Field'></div>");m.append($("<div class='fieldTitle'></div>").html(f));for(var y=$("<span class='input-group'></span>"),b="<select class='"+n+"' name='"+h+"_day'><option value='00'>День</option>",v=1;v<=31;v++){var w=v;w<10&&(w="0"+v),b+="<option value='"+w+"'>"+w+"</option>"}b+="</select>",b=$(b),y.append(b);var C="<select class='"+n+"' name='"+h+"_month'><option value='00'>Месяц</option>",k=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];for(var v in k){var w=parseInt(v)+1;w<10&&(w="0"+w),C+="<option value='"+w+"'>"+k[v]+"</option>"}C+="</select>",C=$(C),y.append(C);for(var T="<select class='"+n+"' name='"+h+"_year'><option value='0000'>Год</option>",P=(new Date).getUTCFullYear()+1,v=P;v>=P-100;v--)T+="<option value='"+v+"'>"+v+"</option>";T+="</select>",T=$(T),y.append(T);var S=$("<input type='hidden' name='"+h+"' class='"+n+"' />");m.append(S),$(y).find("select").bind("change click",function(){S.val(b.val()+"."+C.val()+"."+T.val())}).change(),y.appendTo(m)}else if("checkbox"==u.type||"radio"==u.type){var m=$("<div class='"+u.type+"Field'></div>");m.append($("<div class='fieldTitle'></div>").html(f));for(var v in u.values){var I=$("<label class='fieldValue'></label>"),x=$("<input name='"+u.name+"' class='"+n+"' type='"+u.type+"' />");x.attr("value",u.values[v].value),parseInt(u.values[v].selected)&&x.attr("checked","checked"),I.append(x),I.append(" "+u.values[v].value),I.appendTo(m)}}else var m=$("<input class='text "+n+"' name='"+h+"' type='text' />").attr("placeholder",f);p.append(m),i.append(p)}}if($(this).data("drawCaptcha")&&2==parseInt(r.captcha)&&chat.captcha.append(i,n),o&&(i.append(chat.eulaString(o,s)),i.append("<div class='alert-form'><div class='none'><div class='alert-text'></div></div></div>"),i.append("<div><button class='b'>"+o+"</button></div>"),c)){var D=i.find("button");"string"==typeof c?D.attr("onClick",c):D.bind("click",c)}}})},eulaString:function(t,e){if(parseInt(chat.siteParams.params.siteChatOptions.rknShow)&&("ru"==chat.siteParams.lang||chat.actions.filters.check("country","=",["Russia"]))){var a="<a class='nobr linkEula'  onClick='chat.tabs.eula();'>";return $.form.str_replace(["[button]","[a]","[/a]"],[t,a,"</a>"],"<div class='fs11' style='line-height:1.2em;'><label><input style='width:auto;' type='checkbox' class='"+e+"' name='eulaAgreement' value='1' /><input type='hidden' class='"+e+"' name='needEulaAgreement' value='1' />Я соглашаюсь с [a]правилами пользования сервисом[/a] и даю согласие на хранение и обработку моих персональных данных.</label></div>")}},tabs:{eula:function(){"support"==chat.type?chat.tabs.showTab({id:"eula"}):RPC.post("showTab",{id:"eula"})},ajaxTabDrawed:{},ajaxTab:function(t,e,a){if(this.ajaxTabDrawed[t])chat.tabs.showTab({id:t});else{this.ajaxTabDrawed[t]=!0;var i={id:t,title:e,type:"html",content:{html:"",link:a},visible:1};chat.siteParams.tabs.push(i),this.drawTab(i),chat.initMinSize(),chat.tabs.showTab({id:t})}},scrollable:{init:!1,timeout:null,check:function(){var t=this;clearTimeout(this.timeout),this.timeout=setTimeout(function(){var e=$("ul.supportTabs"),a=$(".supportMenu");if(e.length){var i=0,r=0;$.each(e.children(":visible"),function(){r+=$(this).outerWidth()}),a.is(".scrollable")&&(i+=2*$(".scrollTabsBtnLeft").outerWidth());var n=r>e.outerWidth()+i;n?(a.addClass("scrollable"),this.init||(this.init=!0,$(".scrollTabsBtnLeft").unbind("click touchend").bind("click touchend",function(){t.update(-1)}),$(".scrollTabsBtnRight").unbind("click touchend").bind("click touchend",function(){t.update(1)}),t.update(0))):a.removeClass("scrollable")}},100)},update:function(t){var e=$("ul.supportTabs"),a=$(".scrollTabsBtnLeft"),i=$(".scrollTabsBtnRight"),r="disabled";e.length&&e.animate({scrollLeft:e.scrollLeft()+$(".supportMenu").width()/2*t},200,function(){var t=e.scrollLeft();0==t?a.addClass(r):a.removeClass(r),t>=e[0].scrollWidth-e.width()-2?i.addClass(r):i.removeClass(r)})}},inited:!1,list:{},openByType:function(t){null!=this.list[t]&&this.open(this.list[t][0])},currentType:!1,getTabParams:function(t){for(var e=null,a=0;a<chat.siteParams.tabs.length;a++)chat.siteParams.tabs[a].id==t&&(e=chat.siteParams.tabs[a]);return e},showTab:function(t){if(t.id){var e=this.getTabParams(t.id);if(e){var a=$("li.tab_"+t.id),i=$(a.data("div")),r=i.children(".tabInner");if("payment"==e.type){var n=JSON.parse(JSON.stringify(e));t.paymentSum&&(n.content.sumFixed=parseFloat(t.paymentSum.toString().split(" ").join("")),n.content.sumType="fixed"),r.html($("#paymentTab .tabInner").html()),chat.payment.draw(i,n)}else"html"==e.type&&e.content.link&&!e.content.loaded&&(r.html('<div class="c" style="position: absolute; top: 50%; bottom: 0px; left: 0px; right: 0px; margin-top: -.5em;"><span class="icon-spin icon-circle-o-notch" style="font-size:30px;"></span></div>'),$.post(e.content.link,function(t){r.html(t)},"html"),e.content.loaded=!0);if("payment"==e.type||"form"==e.type)for(var s in t)$(".form_"+t.id+"[name='"+s+"']:not([readonly])").length&&$.form.set("form_"+t.id,s,t[s]);this.open("tab_"+t.id)}}},hideCurrentInvisibleTab:function(){var t=$("li.invisibleTab.current");t.length&&this.setTabVisible(t.data("id"),0)},setTabVisible:function(t,e){var a=$("ul.supportTabs li.tab_"+t);if(a.length){var i=a.hasClass("none")==e;if(i&&(e?a.removeClass("none"):a.addClass("none"),chat.initMinSize(),!e&&a.is(".current"))){var r=$("ul.supportTabs li:not(.none)").first();r.length&&this.open(r)}}},open:function(t){if("object"==typeof t)var e=t;else var e=$("ul.supportTabs li."+t.split(" ").join("."));if(e.length){this.setTabVisible(e.data("id"),1);var a=e.data("type");this.currentType=a,"reviews"==a&&chat.rate.drawTab(),e.parent("ul").children(".current").removeClass("current"),e.addClass("current"),$("div.supportTabs div.current").removeClass("current");var i=e.data("div").addClass("current");chat.windowResize(),chat.fixFeedbackFormHeight(),i.find("input[placeholder],textarea[placeholder]").placeholder(),chat.resizeFeedbackTables(),chat.messages.updatePaddings(),$("input:visible,textarea:visible").blur(),"chat"==a&&$(".onlineSupportChatArea .chat").scrollTop(1e6)}chat.captcha.fix()},loadClientFeedbackInfo:function(t){var e=this;chat.client.updated?null!=t&&t(chat.client):$.post("/LAPI/me-talk/api.php",chat.getPostParams("getClientFeedbackInfo",{}),function(a){1!=a.code&&(a={}),e.loadClientFeedbackInfoCallback(a),null!=t&&t(chat.client)},"json");var a=chat.siteParams.params.leadGen.questionCategories;if(a.ask&&a.list.length){$("div.questionCategory").show();for(var i=$("select[name=questionCategory]").html('<option value="">Укажите категорию вопроса</option>'),r=0;r<a.list.length;r++){var n=$("<option />").html(a.list[r]).attr("value",a.list[r]);n.appendTo(i)}var n=$("<option />").html("Другой вопрос").attr("value","Другой вопрос");n.appendTo(i)}},loadClientFeedbackInfoCallback:function(t){chat.client.update(t),null!=t.haveNoAnswer&&0==parseInt(t.haveNoAnswer)&&chat.onlineSimulation.resetStoreKey()},clientInfoKey:function(t){return chat.siteParams.id+"::"+chat.siteParams.talkID+"::clientInfo"},getClientInfoCache:function(){return supportStorage.get(this.clientInfoKey())},insertClientFeedbackInfo:function(){var t=chat.client.get("descr");if(t||(t=""),$.each($(".collectContactField:not(.disallowAutoFill)"),function(){var t=$(this),e=t.attr("type"),a=t.attr("name"),i=chat.client.get(a);if(i)if("checkbox"==e||"radio"==e){"undefined"==typeof i.indexOf&&(i=i.toString());var r=i.indexOf(t.attr("value"))>=0;r?t.attr("checked",!0):"checkbox"==e&&t.removeAttr("checked")}else t.val(i).change()}),$(".offlinePmLoading").hide(),chat.client.get("inLcab"))var e=".offlinePmLcab";else var e=".offlinePmMetalk";"html"==chat.siteParams.params.leadGen.mode&&$(e).html(chat.prepareHTML(chat.siteParams.params.leadGen.yourOfflineHTML)),$(e).removeClass("none"),chat.fixFeedbackFormHeight()},drawPmUserHTML:function(t){if(t.length&&"html"!=chat.siteParams.params.leadGen.mode){t=$("<div></div>").html(t).html(),t=t.split("%html%").join("");var e="message pmFormUserHTML",a=t.indexOf("%block%")>-1;a?t=t.split("%block%").join(""):e+=" from_operator";var i=$(".pmFormUserHTML").removeClass("none").html(t);"classic"!=chat.siteParams.style&&(i.attr("class",e).children("div").addClass("text first"),$(".askForContactsInfo").addClass("message from_operator")),chat.fixFeedbackFormHeight()}},drawTab:function(t){var e=$("ul.supportTabs");t.visible=parseInt(t.visible);var a=e.children(":not(.invisibleTab)").length;if(t.visible)var i="tab"+a;else var i="tab_"+t.id;var r=t.type,n=t.id;null==this.list[r]&&(this.list[r]=[]),this.list[r].push(i);var s=null;if("chat"==r?s=chat.siteParams.params.leadGen.pmForm.text:null!=t&&null!=t.content&&(s=t.content.html),null==s&&(s=""),s=chat.prepareHTML(s),null!=s&&s.length){for(var o in chat.siteParams.userDataParams)s=s.split("["+chat.siteParams.userDataParams[o].name+"]").join(chat.siteParams.userDataParams[o].value);s=$("<div />").append(s),s.find("a[href][target!=_blank]").attr("target","_parent"),t.content.html=s.html()}if("chat"==r){var c=$("#chatTab").attr("id",i);s.length||(s="<p>Оставьте свой вопрос в этой форме и мы обязательно ответим!</p>"),this.drawPmUserHTML(s),2==parseInt(chat.siteParams.params.leadGen.collectContacts.captcha)&&chat.captcha.append($("#leadgenCaptcha").myShow(),"meTalkPM")}else if("reviews"==r){var c=$("#reviewsTab").attr("id",i),l=!1;for(var h in chat.siteParams.params.rate.collectContacts){l=!0;break}if(l||$(".rateOperator.contacts").hide(),chat.siteParams.params.rate.askName?$(".rateOperator.name").show():$(".rateOperator.name").hide(),2==parseInt(chat.siteParams.params.rate.collectContacts.captcha)&&chat.captcha.append($("#reviewsCaptcha").myShow(),"rateOperator"),chat.form.drawUserHTML(c,t),5==chat.siteParams.params.rate.values){var d={5:"Ставлю оценку «Отлично»",4:"Ставлю оценку «Хорошо»",3:"Ставлю оценку «Нормально»",2:"Ставлю оценку «Плохо»",1:"Ставлю оценку «Очень плохо»"},u=$(".rateOperator[name=rate]").empty();for(var p in d)u.prepend('<option value="'+p+'/5">'+d[p]+"</option>");u.val(u.children(":first").attr("value"))}}else if("html"==r){var c=$("#htmlTab").clone().attr("id",i).appendTo("div.supportTabs");c.find(".tabInner").html(s)}else if("form"==r){var c=$("#formTab").clone().attr("id",i).appendTo("div.supportTabs");chat.form.draw(c,t)}else if("payment"==r){var c=$("#paymentTab").clone().attr("id",i).appendTo("div.supportTabs");chat.payment.draw(c,t)}var f=$("<div />").addClass("tabTitleInner");if("chat"!=r)c.find(".tabTitle").html(f.html(t.title));else{chat.siteParams.triggerParams;f.html(chat.siteParams.params.leadGen.tabTitle),$(".tabTitleForOffline").html(f)}0==a&&t.visible&&(i+=" current",c.addClass("current"),this.currentType=r),t.visible||(i+=" none",c.addClass("hiddenTab")),1==parseInt(t.hideWhenOffline)&&(i+=" hideWhenOffline");var m=$("<li></li>").data("type",r).data("id",n).addClass(i);$("<a></a>").attr("class","a_"+r).html("<span class='descr'>"+t.title+"</span>").appendTo(m);if("chat"==r){$(".download-chat").attr("title","Отправить историю чата на Email").bind("mouseover",function(){var t=$(this),e=t.data("color");if(!e){var a=$("<span class='likeLink none'></span>").appendTo("body");e=a.css("color"),a.remove(),t.data("color",e)}t.attr("style","color:"+e)}).bind("mouseout",function(){$(this).removeAttr("style")}).bind("click",function(){var t=chat.client.get("email");t||(t="");var e=$("<button class='b'></button>").text("Отправить").bind("click",function(){var t=$(this);t.attr("disabled","disabled"),$.post("/LAPI/me-talk/api.php",chat.getPostParams("exportChatForClient",{email:$(".download-chat[name=email]").val()}),function(e){t.removeAttr("disabled"),1==e.code?(chat.alert.show(e),chat.client.get("email")||chat.client.update({email:e.email})):$(".download-chat-error").fadeIn().html(e.descr)},"json")}),a=$("<div></div>").append($("<input type='text' name='email' class='text download-chat' />").css("width","100%").val(t).attr("placeholder","Укажите Ваш Email")).append("<div class='mt5 redText download-chat-error none'></div>").append(e);
e.wrap("<div class='mt10 right'></div>"),chat.alert.show({hideOnClick:!1,title:"Выгрузить историю общения",descr:a})})}m.addClass("tab_"+n),m.data("div",c),m.appendTo(e),t.visible||m.addClass("invisibleTab")},draw:function(){if(!this.inited){this.inited=!0,$("#leadGenEula").html(chat.eulaString("Отправить","meTalkPM")),$.each($(".contacts_place"),function(){var t=$(this);t.data("class");t.data("collectContacts",chat.siteParams.params[t.data("params")].collectContacts)}),chat.siteParams.tabs.push({id:"eula",title:"Правила сервиса",type:"html",content:{html:"",link:"/support/eula.php?oid="+chat.siteParams.id+"&org="+chat.siteParams.orgID},visible:0});for(var t in chat.siteParams.tabs)this.drawTab(chat.siteParams.tabs[t]);var e=5;if(chat.messages.showHistory({last:e}),chat.messages.history.getIdList().length>e){var a=$("<div class='userHTML c' />").html('<a class="ajax" onClick="chat.messages.showHistory();">Загрузить</a> всю историю общения');$(".chatInner > .newNotification").after(a)}chat.drawCollectContactsForms()}}},rate:{refuseSendRate:function(){chat.siteParams.refuseSendRate=1,RPC.post("refuseSendRate",{})},count:0,list:[],page:0,limit:0,isTabDraw:!1,drawTab:function(){this.isTabDraw||($("#reviewsEula").html(chat.eulaString("Отправить отзыв","rateOperator")),parseInt(chat.siteParams.params.rate.loadInTab)?(this.isTabDraw=!0,$d.ready(function(){chat.siteParams.reviewsParams={paginationType:"expand",limit:10,pagination:1,autoWidth:0,description:0,displayNames:1,displayCity:0},chat.rate.load(0);var t=8;"classic"!=chat.siteParams.style&&(t=11),$("#reviewsContainerWrapper").css({overflow:"hidden"}).perfectScrollbar({includePadding:!0,suppressScrollX:!0,marginTop:t,minScrollbarLength:20})})):(this.hideCancelButton(),this.showForm(!0)))},cancelButtonHidden:!1,hideCancelButton:function(){this.cancelButtonHidden=!0,$("#hideReviewForm").hide()},showForm:function(t){var e=$("#reviewsList"),a=$("#reviewsForm");t?(e.hide(),a.show()):e.fadeOut(300,function(){var t=setInterval(function(){chat.fixFeedbackFormHeight()},50);a.fadeIn(300,function(){$d.ready(function(){chat.fixFeedbackFormHeight(),clearInterval(t)})})})},hideForm:function(){$("#reviewsForm").fadeOut(300,function(){$("#reviewsList").fadeIn(300,function(){})})},send:function(t){var e=this;t=$(t);var a=$.form.get("rateOperator",!1);return $(".allowSms:visible").length&&!a.allowSms?void chat.alert.show({code:1,descr:"Пожалуйста, подтвердите возможность отправки сообщений для Вас"}):(t.attr("disabled","disabled"),a.chatMode=chat.chatMode,a.operator=chat.operators.getCurrent(),chat.disableLiteMode(),void $.post("/LAPI/me-talk/api.php",chat.getPostParams("sendRate",a),function(i){if(1!=i.code)t.removeAttr("disabled"),i.retry=function(){e.send(t)},chat.alert.show(i);else{if(chat.captcha.reset(),chat.client.update(i.info),"bad"==a.rate)var r=chat.siteParams.params.rate.afterRateMessage.bad;else var r=chat.siteParams.params.rate.afterRateMessage.good;chat.alert.show({code:1,descr:r}),RPC.post("rateSended",a),t.removeAttr("disabled"),$(".rateOperator[name=comment]").val(""),e.cancelButtonHidden||chat.rate.hideForm()}},"json"))},openReviewsTab:function(){RPC.actions.openReviewsTab(),RPC.post("openReviewsTab",{form:!0})},load:function(t){var e=this;e.page=t;var a=chat.siteParams.reviewsParams,i={"X-Metalk-Org":chat.siteParams.orgID};"1"==a.allSites?i["X-Metalk-Siteid"]="all":i["X-Metalk-Siteid"]=chat.siteParams.id,a.limit=parseInt(a.limit),(a.limit<1||a.limit>50)&&(a.limit=10),e.limit=a.limit,i["X-Metalk-From"]=t*a.limit,i["X-Metalk-To"]=i["X-Metalk-From"]+a.limit-1,$.ajax({url:"/metalkLoadRates",headers:i,method:"GET",dataType:"html",success:function(t){e.count=0,e.list=[],t=t.split("\n");for(key in t)0==key?(e.count=parseInt(t[key].substr(1)),isNaN(e.count)&&(e.count=0)):0==t[key].indexOf("{")&&e.list.push(JSON.parse(t[key]));if(1==parseInt(a.description)&&0==e.page){if(e.count){var i=e.count,r=chat.getSclon(e.count,"отзыв","отзыва","отзывов");if(a.withReviewsDescription)var n=a.withReviewsDescription;else{var n="<p><span>Наши посетители оставили уже</span> <span class='reviewsCount'>{num}</span> {word}.</p>";n+="<p><span>Присоединяйтесь к ним</span>,  <a class='ajax' onClick='chat.rate.openReviewsTab(); return false;' href='#'>оставьте свой отзыв или пожелание</a>!</p>"}n=n.split("{num}").join(i).split("{word}").join(r)}else if(a.withoutReviewsDescription)var n=a.withoutReviewsDescription;else{var n=$("<div><p>Пока что наши посетители не оставили ни одного отзыва.</p></div>"),s=$("<p>Вы можете <a class='ajax' onClick='chat.rate.openReviewsTab(); return false;' href='#'>стать первым</a>!</p>");n.append(s)}$("#reviewsContainer").html("<div class='mb15'></div>").html(n)}0!=e.page||e.count||(chat.rate.hideCancelButton(),chat.rate.showForm()),e.draw()}})},cutText:function(t,e){return t.length>e&&(t="<div>"+t.substring(0,e)+"... <a onClick='$(this).parentsUntil(\".review\").parent().css({height:\"auto\"}); $(this).parent().hide(); $(this).parent().next().show(); chat.rate.changeReviewsHeight();'>Читать далее</a></div><div class='none'>"+t+"</div>"),t},draw:function(){$("#reviewsLoading").remove(),"classic"==chat.siteParams.reviewsParams.paginationType&&$(".review").remove();var t=this,e="",a=chat.messages.timeOffset(),i=chat.siteParams.reviewsParams.maxLength,r=1==parseInt(chat.siteParams.reviewsParams.displayNames),n=1==parseInt(chat.siteParams.reviewsParams.displayCity);for(key in t.list){var s=t.list[key].rate,o=!1;if("good"==s)var c="greenAjax";else if("bad"==s)var c="redAjax";else if(o=s.split("/").join(" <span>из</span> "),s=s.split("/"),2==s.length)if(s=s[0]/s[1],s>.5)var c="greenAjax";else var c="redAjax";var l=emojione.unicodeToImage($("<div />").text(t.list[key].comment.split("<br />").join("\n")).html()),h=t.list[key].adminComment;if(null==h&&(h=""),h=$("<div />").text(h.split("<br />").join("\n")).html(),i>0&&(l=t.cutText(l,i),h=t.cutText(h,i)),l=l.split("\n").join("<br />"),h=h.split("\n").join("<br />"),r&&null!=t.list[key].descr&&t.list[key].descr)var d=t.list[key].descr.split(", 8000")[0].split("@")[0]+" ";else var d=!1;var u=chat.messages.dateFromString(t.list[key].dt);u.setHours(u.getHours()+a),u=chat.messages.formatDate(u,!0),e+="<div class='review ajax "+c+"'><div class='inner'>",e+="<div class='reviewAuthor'><div>";var p="date";d?e+="<span class='name'>"+d+"</span>":(p+=" withoutName",u="<span>Отзыв от</span> "+u),e+="<span class='"+p+"'>"+u+"</span></div>",n&&null!=t.list[key].city&&t.list[key].city&&(e+="<div><span class='city'><span>г.</span> "+t.list[key].city+"</span></div>"),e+="</div>",e+="<div class='text'>"+l,o&&(e+="<div class='mt10'><span>Оценка</span>: "+o+"</div>"),null!=h&&h.length&&(e+="<div class='mt15 adminAnswer'><div class='bold mb5 adminAnswerTitle'>"+chat.siteParams.params.rate.adminCommentTitle+"</div><div class='adminAnswerText'>"+h+"</div></div>"),e+="</div></div></div>"}if(e+="<div class='clear delimiter'></div>",1==chat.siteParams.reviewsParams.pagination){e+="<div class='c rateButtons mt15'>","classic"==chat.siteParams.reviewsParams.paginationType&&t.page&&(e+="<button onClick='$(this).parent().fadeOut(); chat.rate.load("+(t.page-1)+")'><span class=''>← Назад</span></button> ");var f=$("#reviewsInChatExpand");t.count>t.limit*(t.page+1)?"expand"==chat.siteParams.reviewsParams.paginationType?f.length?f.unbind("click").bind("click",function(){$(this).fadeIn(),chat.rate.load(t.page+1)}):e+="<button id='reviewsExpand' onClick='$(this).parent().fadeOut(); chat.rate.load("+(t.page+1)+")'>Загрузить ещё</button>":e+=" <button onClick='$(this).parent().fadeOut(); chat.rate.load("+(t.page+1)+")'><span>Вперёд →</span></button>":f.remove(),e+="</div>"}$("#reviewsContainer > .delimiter").remove(),$("#reviewsContainer").append(e);var m=$("#reviewsContainerWrapper").scrollTop();if(m&&$("#reviewsContainerWrapper").animate({scrollTop:$("#reviewsContainerWrapper").scrollTop()+$("#reviewsContainerWrapper").height()}),$(".review").css({width:"auto",height:"auto"}),$(".review.last").removeClass("last"),$(".review:last").addClass("last"),1==chat.siteParams.reviewsParams.autoWidth){var g=[],v=$(".review:first").position();if(null!=v){var y=v.top,b=$("#reviewsContainer").width(),w=17,C=210+w,k=Math.floor(b/C),T=b-C*k;C+=Math.floor(T/k),C-=w;var P=0,S=0;$.each($(".review"),function(){var t=$(this).position().top;t!=y&&(S!=k?$(this).width(C*(k-S)):($.each(g,function(){$(this).height(P)}),y=$(this).position().top,g=[],P=0,S=0)),g.push($(this));var e=parseInt($(this).width()),a=Math.ceil(e/C);k<a&&(a=k),a+S>k&&(a=k-S),e=a*C+w*(a-1),S+=a,$(this).css("width",e);var i=$(this).height();P<i&&(P=i)})}}else $(".review").css({float:"none",marginLeft:0,marginRight:0});t.changeReviewsHeight(),$(".review").animate({opacity:1},200)},changeReviewsHeight:function(){RPC.post("changeReviewsHeight",{height:$("#reviewsContainer").height()+5})}},resizeFeedbackTables:function(){$d.ready(function(){$.each($(".feedbackTable:visible"),function(){var t=$(this),e=!1,a=t.find(".fieldDescr");for(var i in a)if($(a[i]).text().length>20){e=!0;break}e||t.parent().width()<265?t.addClass("narrow").removeClass("wide"):t.removeClass("narrow").addClass("wide")}),chat.form.resize();var t=$("#chatTextarea");$(".autoresizeDiv").width(t.width());var e=t.data("resize");null!=e&&e()})},minHeight:250,initMinSizeAllowed:!1,getTestDopWidth:function(){if("classic"==chat.siteParams.style)var t=65;else if("flat"==chat.siteParams.style)var t=70;else var t=50;return t},heightWithoutPadding:!1,initMinSize:function(t){if(this.initMinSizeAllowed){var e=this;t||(t={}),null==t.store&&(t.store=!0),$d.ready(function(){if(t.height?t.store&&(e.minHeight=t.height):t.height=e.minHeight,t.heightWithoutPadding?t.store&&(e.heightWithoutPadding=t.heightWithoutPadding):t.heightWithoutPadding=e.heightWithoutPadding,!t.width){t.width=0,$.each($("ul.supportTabs li:not(.none) a"),function(){t.width+=$(this).width()+17});var a=$("<span class='nobr'></span>").html("Введите Ваш вопрос и нажмите Enter").appendTo("body"),i=e.getTestDopWidth(),r=a.width()+i;a.remove(),t.width<r&&(t.width=r),$(".subscribe_date").length&&(t.width+=30),t.width+=14}t.type=chat.type,RPC.post("initMinSize",t)})}},loading:{loadStyle:function(t,e){if(1==chat.siteParams.useLess)$("head").append('<link rel="stylesheet/less" type="text/css" href="/engine/less/Templates/supportTemplateSample.less?18" /><script type="text/javascript">less = {env: "development"};</script><script type="text/javascript" src="/engine/javascript/less-1.3.3.min.js?44"></script>'),e();else{var a=document.createElement("link");a.type="text/css",a.rel="stylesheet";var i=0,r=document.styleSheets.length,n=setInterval(function(){document.styleSheets.length>r&&(i++,3==i&&(clearInterval(n),e(),e=function(){}))},500);a.readyState?a.onreadystatechange=function(){"loaded"!=a.readyState&&"complete"!=a.readyState||(a.onreadystatechange=null,clearInterval(n),e(),e=function(){})}:a.onload=function(){clearInterval(n),e(),e=function(){}},a.href=t,document.getElementsByTagName("head")[0].appendChild(a),setInterval(function(){chat.captcha.selectImgDisplayed()?RPC.post("hideResize",{}):RPC.post("showResize",{})},1e3)}},loadScript:function(t,e){var a=document.createElement("script");a.type="text/javascript",a.readyState?a.onreadystatechange=function(){"loaded"!=a.readyState&&"complete"!=a.readyState||(a.onreadystatechange=null,e())}:a.onload=function(){e()},a.src=t,document.getElementsByTagName("head")[0].appendChild(a)},started:!1,getDirByID:function(t){var e="",a=t.length;a>2&&(a=2);for(var i=0;i<a;i++)e+=t.substr(i,1)+"/";return e+=t+"/"},updateVisits:function(){var t="last::online::"+chat.siteParams.id,e=function(){storeWithExpiration.set(t,1,12e4,!0)};setInterval(e,1e3);var a=storeWithExpiration.get(t),i=!1;return a||(chat.incrVisits(),i=!0),e(),i},start:function(t){var e=this;return!this.started&&(this.started=!0,chat.siteParams=t,void("support"==t.type?(supportStorage.init(function(){e.startContinue(t)}),chat.emoji.init()):supportStorage.init(function(){e.startContinue(t)})))},startContinue:function(t){if(chat.client.init(),null==t.dopStyle&&(t.dopStyle=""),t.dopStyle+="html.support body #reviewsContainer div.ajax.greenAjax{ background:"+t.params.rate.display.good.background+"; color:"+t.params.rate.display.good.color+"; } html.support body #reviewsContainer div.ajax.redAjax{ background:"+t.params.rate.display.bad.background+"; color:"+t.params.rate.display.bad.color+"; }",$b.append("<style id='additionalStyles'>"+t.dopStyle+"</style>"),null!=supportStorage.get(chat.siteParams.id+"::etag")&&null!=supportStorage.get(chat.siteParams.id+"::date")&&(chat.siteParams.channelEtag=supportStorage.get(chat.siteParams.id+"::etag"),chat.siteParams.channelDate=supportStorage.get(chat.siteParams.id+"::date")),chat.siteParams.params.leadGen.questionCategories.ask=parseInt(chat.siteParams.params.leadGen.questionCategories.ask),chat.siteParams.params.rate.askName=parseInt(chat.siteParams.params.rate.askName),$h.addClass(t.style),chat.siteParams.mobile&&$h.addClass("mobile"),"support"==t.type){var e=chat.siteParams.id+"::currentTalkID";chat.siteParams.talkID!=supportStorage.get(e)&&(supportStorage.clearBySite(chat.siteParams.orgID,chat.siteParams.id),supportStorage.set(e,chat.siteParams.talkID)),chat.listen.start({cid:"main"}),RPC.actions.updateActivityAction(),chat.tabs.draw();var a=chat.operators.getRememberOperator();null!=a.operator&&a.operator&&chat.operators.select({operator:a.operator,group:a.group}),chat.operators.init();var i=this.updateVisits();setInterval(chat.activity.update,13e3),chat.actions.init(),chat.activity.start(null,i),chat.targetClient.checkIfTarget(),supportStorage.setListener(function(t){if(t.newValue){if(supportStorage.checkStoreByThisTab(t.key,t.newValue))return;if("websocketAjaxSended"==t.key)chat.nodeAjax.wasSended(JSON.parse(t.newValue));else if("websocketAjaxResult"==t.key){var e=JSON.parse(t.newValue);chat.nodeAjax.callback(e.callbackID,e.data)}else if("websocketAjax"==t.key){var a=JSON.parse(t.newValue);a&&chat.nodeAjax.sendIfMainListener(a)}}"sendMessage"==t.key?chat.messages.history.showOneMoreMessage():"removeMessage"==t.key?chat.messages.history.removeFromHTML(t.newValue):t.key=="fv::"+chat.siteParams.id&&chat.actions.filters.getFiltersFromStorage()}),setInterval(function(){RPC.actions.updateActivityAction()},5e4)}var r=this.getDirByID(t.design);chat.loading.loadStyle(chat.staticDomain+"/API/DOCS/onlineChatAssets/styles/"+r+t.design+".css?r="+(t.dtChange+1),function(){if(chat.loading.live(),"reviews"==t.type)setTimeout(function(){chat.rate.load(0)},100);else if("support"==t.type){var e=function(t){for(var e in chat.listen.started)chat.listen.stop(e)};$(window).bind("beforeunload unload",e),$d.ready(function(){window.location.search.indexOf("type=inline")!=-1&&($h.addClass("inlineSupportWindow"),RPC.actions.open()),window.location.search.indexOf("payment-success")!=-1&&(chat.alert.show({descr:"Ваш платёж успешно принят"}),chat.openSupport()),window.location.search.indexOf("payment-fail")!=-1&&(chat.alert.show({descr:"Процедура оплаты завершилась неудачно"}),chat.openSupport());var t=$(".me-talk-copyright"),e=t.innerHeight();if(chat.copyrightDisplayed()){var a=chat.getInnerCopyrightImage();t.find("img").addClass("delayed-src").attr("delayed-src",a),t.find("a").attr("href",chat.siteParams.params.copyright.url)}else chat.siteParams.params.siteChatOptions.exportByClientAllowed?(t=$(".me-talk-copyright:not(.me-talk-copyright-chat)"),$(".me-talk-copyright-chat").children(".copyright-content").css({visibility:"hidden"})):e=5,t.remove(),$h.removeClass("showCopyright");$(".chat").css({overflow:"hidden"}).perfectScrollbar({includePadding:!0,marginTop:e,minScrollbarLength:20,wheelPropagation:!0}),chat.triggerBadge.updated()})}else"form"==t.type?(chat.form.draw($("#formContainer"),chat.siteParams.formTab),chat.drawCollectContactsForms(),chat.form.resize()):"payment"==t.type&&(chat.payment.draw($("#formContainer"),chat.siteParams.formTab),chat.form.resize())})},live:function(){$d.ready(function(){function t(){chat.messages.chatTextareaValue().length?$("#onlineChatSend").removeClass("disabled"):$("#onlineChatSend").addClass("disabled");var t=$("#chatTextarea").data("resize");null!=t&&t()}$("ul.supportTabs li a").live("click",function(){var t=$(this).parent();t.hasClass("current")||chat.tabs.open(t)}),$(".linkEula").live("click",function(t){t.stopPropagation(),t.preventDefault()}),$(".alert-title").click(function(){chat.alert.hide()}),$(".selectOperator[name=operator]").bind("change",function(){var t=$(this).val(),e=chat.operators.get(t);$(".operatorNameDisplay").html(e.fio),$(".avatar").attr("src",chat.staticDomain+e.avatar)}),$("#onlineChatSend").bind("click",function(){chat.messages.send()}),$("#chatTextarea").bind("keypress",function(e){13==e.keyCode&&(e.preventDefault?e.preventDefault():e.returnValue=!1,chat.messages.send()),t()}).bind("keyup",function(e){chat.triggerBadge.empty();var a=chat.operators.get(chat.operators.getCurrent());a&&a.canViewTyping&&(null!=chat.messages.cometTypePublishTimeout||chat.siteParams.free||(chat.messages.cometTypePublishTimeout=setTimeout(function(){chat.messages.clearTyping();var t=chat.messages.chatTextareaValue(),e=$("#chatTextarea");t!=e.attr("placeholder")&&t!=e.data("prev-typing")&&(e.data("prev-typing",t),chat.operators.balancer.isEnabled(function(e){parseInt(chat.siteParams.params.operators.typingNotifications)||(e=1);var a={action:"typing",talkID:chat.siteParams.talkID,siteID:chat.siteParams.id,orgID:chat.siteParams.orgID,text:t,balancer:e?1:0},i="/cometTypePublish?op="+chat.operators.getCurrent(),a=JSON.stringify(a);chat.nodeAjax.send({url:i,method:"POST",data:a},function(t){}),RPC.post("cometPublish",{url:i,data:a})}))},1e3))),t()}),chat.windowResizeFunctions.push(function(){chat.messages.updatePaddings(),chat.resizeFeedbackTables(),chat.textareaHasScrollbar($("textarea")),chat.fixFeedbackFormHeight(),chat.tabs.scrollable.check()}),$("textarea, #chatTextarea").bind("keyup",function(){chat.textareaHasScrollbar(this)}),$(".ha").live("mouseover",function(){$(this).addClass("h")}).live("mouseout",function(){$(this).removeClass("h")}),chat.initMinSizeAllowed=!0,chat.initMinSize(),$(".mute").bind("click",function(){chat.makeMute()}),chat.initMute()})}},payment:{drawed:{},currency:function(t){return t.content.currency?t.content.currency:{id:"rub",short_descr:"руб",icon:"rub"}},draw:function(t,e){var a=this;if("undefined"!=typeof e){this.drawed[e.id]=!0;var i=e.content.button;e.content.button=!1,$(".paymentSteps",t).data("formID",e.id).data("object",e).data("button",i);chat.form.draw(t,e);t.find(".eula").html(chat.eulaString("Продолжить","collectContactField")),chat.drawCollectContactsForms(),$(".sumForm_"+e.content.sumType,t).removeClass("none");for(var r=0;r<e.content.sumList.length;r++){var n=e.content.sumList[r][0];$("select[name=sum_list]",t).append($("<option></option>").attr("value",n).text(e.content.sumList[r][1]+" ("+n+" "+a.currency(e).short_descr+")"))}t.find(".sumIcon").addClass("icon-"+a.currency(e).icon),t.find("[name=sum_client]").attr("placeholder","Введите сумму платежа ("+a.currency(e).short_descr+")");var s=$(".paymentMethodsList",t),o=$("button.sample",s);for(var c in e.content.paymentTypes){var i=o.clone().removeClass("none sample");if(i.children("img").addClass("delayed-src").attr("delayed-src","/images/paymentSystems/"+c+".png"),i.children("span").text(chat.siteParams.paymentSystemTypes[c]),s.append(i),e.content.paymentTypes[c].length>1){for(var l=$(".paymentSystemList.sample",s).clone().removeClass("sample"),h=l.find("ul"),r=0;r<e.content.paymentTypes[c].length;r++){var d=e.content.paymentTypes[c][r],u=$("<li></li>").data("psID",d).data("psType",c);$("<img class='delayed-src' delayed-src='/images/paymentSystems/"+d+"_square.png' />").appendTo(u),$("<a></a>").text(chat.siteParams.paymentSystems[d].descr).appendTo(u);u.bind("click",function(){a.step3($(this).data("psID"),$(this).data("psType"),this)}),u.appendTo(h)}i.bind("click",function(){l.is(":visible")?(l.slideUp(200,function(){chat.windowResize()}),$(this).removeClass("selected")):($(this).addClass("selected"),l.slideDown(200,function(){chat.windowResize()}))}),s.append(l)}else i.data("psID",e.content.paymentTypes[c][0]).data("psType",c).bind("click",function(){a.step3($(this).data("psID"),$(this).data("psType"),this)})}$(".sumInput",t).detach().prependTo($(".feedbackFormStep2",t).children("form")),$("input[name=sum_fixed]",t).val(e.content.sumFixed),$(".sumForm_fixed .sum",t).html(e.content.sumFixed+" "+a.currency(e).short_descr),chat.windowResize(),chat.loadDelayedSrc()}},getDivBySender:function(t){return $(t).parentsUntil(".paymentSteps").last().parent()},step2:function(t){var e=this,a=this.getDivBySender(t),i=$(".sumForm > .sumType:not(.none)",a).data("type"),r=parseFloat($("[name='sum_"+i+"']",a).val());r?r>0?($(t).attr("disabled","disabled"),chat.disableLiteMode(),$.post("/LAPI/me-talk/api.php",chat.getPostParams("createBillByClient",{sum:r}),function(i){if(1==i.code){a.data("billID",i.id),$(".step1",a).slideUp();var r=$(".step2",a);r.slideDown(function(){chat.windowResize()}),$("[name=sum]",r).val("Cумма платежа: "+i.sum+" "+e.currency(a.data("object")).short_descr)}else i.retry=function(){e.step2(t)},chat.alert.show(i);$(t).removeAttr("disabled")},"json")):chat.alert.show({code:0,descr:"Сумма платежа должна быть больше 0"}):chat.alert.show({code:0,descr:"Не удалось получить сумму платежа"})},step3:function(t,e,a){var i=this,r=this.getDivBySender(a),n=r.data("billID"),s=r.data("formID");chat.overlay.show(),$.post("/LAPI/me-talk/api.php",chat.getPostParams("loadFormForBill",{billID:n,formID:s,psID:t,psType:e,contacts:$.form.get("collectContactField",!1,!1,r),currentUrl:chat.siteParams.currentUrl}),function(n){if(chat.overlay.hide(),1==n.code){chat.captcha.reset(),$(".step2",r).slideUp();var s=$(".step3",r);"cloud_payments"==t?RPC.post("appendScript",{script:n.form}):s.append(n.form);var o=r.data("button"),c=s.find(".submit");o&&c.text(o),c.length?($(".step3Button",s).show(),$(".step3NoButton",s).hide()):($(".step3Button",s).hide(),$(".step3NoButton",s).show()),s.slideDown(function(){chat.windowResize()})}else n.retry=function(){i.step3(t,e,a)},chat.alert.show(n)},"json")}},overlay:{show:function(){$b.addClass("overlay")},hide:function(){$b.removeClass("overlay")}},form:{drawed:{},draw:function(t,e){if("undefined"!=typeof e){this.drawed[e.id]=!0,this.drawUserHTML(t,e);var a="form_"+e.id,i=$("<div class='contacts_place'></div>");return i.data("class",a),i.data("type","form"),i.data("drawCaptcha",1),i.data("collectContacts",e.content.form),i.data("button",e.content.button),i.data("button-click",function(){chat.form.make($(this),e)}),t.find(".feedbackForm").append(i),{className:a}}},drawUserHTML:function(t,e){var a=[["html","userHTMLTop"],["html_footer","userHTMLFooter"]];for(var i in a){var r=chat.prepareHTML(e.content[a[i][0]]);if(r)var n=$("<div />").html(r).text().length;else var n=0;var s=$("."+a[i][1],t);n?s.removeClass("none").html(r).show():s.hide()}},make:function(t,e){var a=this,i=$.form.get(".form_"+e.id,!1);t.attr("disabled","disabled"),i.tabID=e.id,i.currentPage={url:chat.siteParams.currentUrl,title:chat.siteParams.currentTitle},chat.disableLiteMode(),$.post("/LAPI/me-talk/api.php",chat.getPostParams("sendForm",i),function(r){t.removeAttr("disabled"),r.code!=-1?(1==r.code&&(supportStorage.remove("subscribe::"+i.id),chat.client.update(r.info),$("select.form_"+e.id+", input.form_"+e.id+"[type=text], textarea.form_"+e.id).val("").change()),r.retry=function(){a.make(t,e)},chat.alert.show(r),1==r.code&&(chat.captcha.reset(),chat.tabs.hideCurrentInvisibleTab(),RPC.post("clientMakeSubscribe",i))):(supportStorage.set("subscribe::"+e.id,i),chat.form.sendVerifyCode=!0,$(".form_"+e.id).attr("disabled","disabled"),$(".form_"+e.id+"[name=verifyCode]").removeAttr("disabled"),$(".verifyCode_"+e.id).removeClass("none"),setTimeout(function(){chat.form.resize()},200)),chat.form.resize()},"json")},resize:function(){var t=$("#formContainer").position(),e=null==t?0:t.top;RPC.post("changeFormHeight",{height:$("#formContainer").outerHeight()+e+5})}},searchKeyword:{cache:null,get:function(){if(null!=this.cache)return this.cache;var t=!1,e=chat.siteParams.referrer;if(e.length&&null!=chat.siteParams.searchEngines)for(var a in chat.siteParams.searchEngines){var i=chat.siteParams.searchEngines[a];if(e.indexOf(i.host)!=-1){var r=getQueryStringParams(e);null!=r[i.key]&&(t=r[i.key]);break}}return this.cache=t,t},escapeFromOtherCharacters:function(t){return t||(t=""),t.replace(/[^a-zA-ZА-Яа-я0-9\s]/g,"")},check:function(t){var e=this.get();if(e){e=chat.searchKeyword.escapeFromOtherCharacters(e).split(/\s/);var t=chat.searchKeyword.escapeFromOtherCharacters(t.replace(/\+/g," ")).split(/\s/),a=!0;for(var i in t){var r=!1;for(var n in e)if(e[n]==t[i]||0==e[n].indexOf(t[i])||e[n].indexOf(" "+t[i])!=-1){r=!0;break}if(!r){a=!1;break}}return a}return!1}},targetClient:{checkIfTarget:function(){var t=this,e=[],a=chat.siteParams.targetParams;if(null!=a.referer){var i=this.prepareUrl(chat.siteParams.referrer);if(i.length)for(var r in a.referer){var n=this.prepareUrl(a.referer[r]);0==i.indexOf(n)&&e.push({param:"referer",value:a.referer[r],search:a.referer[r]})}}if(null!=a.url){var s=this.prepareUrl(chat.siteParams.currentUrl);for(var r in a.url){var n=this.prepareUrl(a.url[r]);n==s&&e.push({param:"url",value:a.url[r],search:a.url[r]})}}if(null!=a.urlSubstring){var s=chat.siteParams.currentUrl;for(var r in a.urlSubstring)s.indexOf(a.urlSubstring[r])!=-1&&e.push({param:"urlSubstring",value:a.urlSubstring[r],search:a.urlSubstring[r]})}if(null!=a.searchKeyword&&null!=chat.siteParams.searchEngines){var o=chat.searchKeyword.get();if(o)for(var r in a.searchKeyword){var c=chat.searchKeyword.check(a.searchKeyword[r]);c&&e.push({param:"searchKeyword",value:o,search:a.searchKeyword[r]})}}if(null!=a.city)for(var r in a.city)e.push({param:"city",value:encodeURIComponent(a.city[r]),search:encodeURIComponent(a.city[r])});null!=a.all&&e.push({param:"all",value:"",search:""}),e.length&&t.send(e)},send:function(t,e){if(!chat.isLiteModeEnabled()){var a=[];for(var i in t){"string"==typeof t[i]&&(t[i]={param:"custom",value:t[i],search:t[i]});var r=t[i].value;"city"==t[i].param&&(r=r.substr(0,10));var n=chat.siteParams.id+"::"+chat.siteParams.talkID+"::targetClient::"+t[i].param+"::"+r;null==supportStorage.get(n)&&(a.push(t[i]),supportStorage.set(n,1))}if(e)return!!a.length;if(a.length)return chat.actions.filters.set("isTargetClient","1"),setTimeout(function(){var t="/writeMetalkQueue";chat.nodeAjax.send({url:t,method:"GET",headers:chat.getHeaders("notifyTargetClient",{why:a})},function(t){chat.listen.start({cid:"main"})})},500),!0}return!1},prepareUrl:function(t){return t=t.replace(/\\\?/gi,"?").replace(/\:\/\/www./gi,"://").replace(/http\:\/\//gi,"").replace(/https\:\/\//gi,""),t=t.split("#"),t=t[0],"/"==t.substr(t.length-1,1)&&(t=t.substr(0,t.length-1)),t.indexOf("?")!=-1&&t.indexOf("index.php?")==-1&&t.replace(/\\?/gi,"index.php?"),t}},setClientInfo:function(t){var e="programmaticlyChangedContacts::"+chat.siteParams.id,a=storeWithExpiration.get(e),i="cache value is "+JSON.stringify(t);null!=a&&a==i||$.post("/LAPI/me-talk/api.php",chat.getPostParams("setClientInfo",t),function(t){1==t.code&&(chat.client.update(t.info),storeWithExpiration.set(e,i,36e5))},"json")},changeContacts:function(t,e,a,i){if(null==a&&(a=1),t||(t=""),t&&t.length||!a){var r="programmaticlyChangedContacts::"+chat.siteParams.id,n=storeWithExpiration.get(r),s=t+e;i&&(s+=JSON.stringify(i)),null!=n&&n==s||$.post("/LAPI/me-talk/api.php",chat.getPostParams("changeClientContacts",{contact:t,descr:e,important:a,custom:i}),function(e){1==e.code&&(chat.client.update(e.info),$("input[name=contact]").attr("value",t),storeWithExpiration.set(r,s,36e5))},"json")}},setCustomData:function(t){var e="programmaticlyChangedCustomData::"+chat.siteParams.id,a=supportStorage.get(e),i=JSON.stringify(t);null!=a&&a==i||$.post("/LAPI/me-talk/api.php",chat.getPostParams("changeClientCustomData",{data:t}),function(t){1==t.code&&supportStorage.set(e,i)},"json")},alert:{visible:!1,show:function(t){t=$.extend({hideOnClick:!0},t);var e=this;null==t.title&&(t.title="Системное сообщение",801==t.code&&(t.title="Внимание"));var a=$("#alert-message"),i=!0;if(a.length||(a=$(".alert-form > div"),i=!1),!a.length)return RPC.post("alert",{text:t.descr});if(this.visible=!0,1==t.code)var r="success";else if(t.code==-1)var r="warning";else var r="error";if($(".alert-title > span",a).html(t.title),$(".alert-text",a).addClass("relative").html(t.descr),801==t.code&&t.retry){var n=$("<div class='mt20'></div>"),s=$("<button class='b'>Я согласен</button>").bind("click",function(){$("[name=eulaAgreement]:visible").attr("checked","checked"),t.retry()}),o=$("<button class='fr'>Отмена</button></div>");n.append(s).append(o).appendTo($(".alert-text",a))}if($(a).attr("class",r),i){$(a).css({top:$(".wrapper").height()/2-$("#alert-message").height()/2}),$("#alert-background, #alert-message").fadeIn(300).unbind("click");var c="#alert-background";t.hideOnClick&&(c+=", #alert-message"),$(c).bind("click",function(){e.hide()})}else $(a).slideDown()},hide:function(){this.visible&&(this.visible=!1,$("#alert-background, #alert-message").fadeOut(300))}},textareaHasScrollbar:function(t){t=$(t),$.each($(t),function(){var t=$(this),e=!1;if(null!=t[0]){if(Math.ceil(t[0].clientHeight)<t[0].scrollHeight)var e=!0;if(e!=t.hasClass("hasScrollbar")){var a=chat.getScrollbarWidth,i=t.parent().children(".uploadIcon"),r=t.parent().children("#onlineChatSend");e?(t.addClass("hasScrollbar"),i.css({marginRight:a}),r.css({right:a})):(t.removeClass("hasScrollbar"),i.css({marginRight:0}),r.css({right:0}))}}})},getScrollbarWidthCache:null,getScrollbarWidth:function(){if(null!=chat.getScrollbarWidthCache)return chat.getScrollbarWidthCache;var t=document.createElement("div");return t.innerHTML='<div style="width:50px;height:50px;position:absolute;left:-50px;top:-50px;overflow:auto;"><div style="width:1px;height:100px;"></div></div>',t=t.firstChild,document.body.appendChild(t),width=t.offsetWidth-t.clientWidth,document.body.removeChild(t),chat.getScrollbarWidthCache=width,width},loadedSounds:[],playSound:function(t){chat.mute||"off"==t||(this.loadedSounds.indexOf(t)==-1&&(this.loadedSounds.push(t),$.ionSound({sounds:[t],path:"/support/sounds/",multiPlay:!1,volume:"0.3"})),$.ionSound.play(t))},initMute:function(){var t=supportStorage.get("mute");null==t&&(t=0),chat.mute=!t,chat.makeMute()},makeMute:function(){chat.mute=!chat.mute;var t=$(".mute").removeClass("icon-volume-up icon-volume-off");if(chat.mute){var e=1;t.addClass("icon-volume-off").attr("title","Звук выключен")}else{var e=0;t.addClass("icon-volume-up").attr("title","Звук включен")}var e=parseInt(e);supportStorage.get("mute")!=e&&supportStorage.set("mute",e)},getSclon:function(t,e,a,i){var r=!1,n=this.substr(t,-1,1);return r=t>20?n>1&&n<5?a:1==n?e:i:1==t?e:t>4&&t<=20||0==t?i:a},substr:function(t,e,a){return t=t.toString(),e<0&&(e+=t.length),void 0==a?a=t.length:a+=a<0?t.length:e,a<e&&(a=e),t.substring(e,a)},cookie:{set:function(t,e,a){RPC.post("setCookie",{name:t,value:e,expires:a})},get:function(t,e){var a=" "+document.cookie,i=" "+t+"=",r=null,n=0,s=0;if(a.length>0&&(n=a.indexOf(i),n!=-1&&(n+=i.length,s=a.indexOf(";",n),s==-1&&(s=a.length),r=unescape(a.substring(n,s)))),r)e(r);else{var o=chat.generateCode(20);this.callbacks[o]=e,RPC.post("getCookie",{name:t,code:o})}},callbacks:{}},rand:function(t,e){return Math.random()*(e-t)+t},generateCode:function(t){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";if(null==t)var t=32;for(var a="",i=0;i<t;i++){var r=Math.floor(Math.random()*e.length);a+=e.substring(r,r+1)}return a},shuffle:function(t){for(var e,a,i=t.length;i;e=Math.floor(Math.random()*i),a=t[--i],t[i]=t[e],t[e]=a);return t},showUploadFile:function(t,e){var a='<input type="file" name="file[]" multiple class="'+t+'" />';chat.alert.show({
code:1,descr:a,title:"Загрузка файла",hideOnClick:!1}),$d.ready(function(){var a=$("."+t+'[name="file[]"]');$.form.makeUpload(a,{name:"file",autoLoad:!0,form:t,onComplete:function(i){a.parent().parent().find("iframe")[0];$.post("/LAPI/misc/fileShare.php?action=getLastUpload",{},function(a){a.length&&chat.onUploadFile(t,e,$.parseJSON(a))},"html")},progress:!1,upload:"https://static.me-talk.ru/LAPI/misc/fileShare.php?action=upload&org="+chat.siteParams.orgID})})},onUploadFile:function(t,e,a){if(chat.alert.hide(),1==a.code){if("onlineChat"==t)var i=chat.messages.chatTextareaValue();else var r=$("."+t+"[name="+e+"]"),i=r.val();i.length&&(i+="\n");for(var n="<p>Передача файлов:</p>",s=0;s<a.multiple.length;s++){var o=a.multiple[s];if(o){i.length&&(i+="\n");var e=o.filename,c=$.form.fsize(o.size),l=a.domain+o.url;"https://me-talk.ru"+o.url;i+=l+" ("+e+", "+c+")";var h="<a href='"+l+"' target='_blank'>";n+="<p class='ellipsis nobr'>"+h+e+"</a> ("+c+")</p>",o.imageSize&&o.imageSize.width&&(n+="<p>"+h+"<img src='"+l+"' style='max-height:60px; max-width:100%;' /></a></p>")}}a.multiple.length>1&&(i+="\n\nСкачать одним архивом: "+a.domain+a.multipleUrl);var d=function(){chat.alert.hide(),"onlineChat"==t?(chat.messages.chatTextareaValue(i),chat.messages.send()):r.val(i).change().keyup()};n=$("<div><div id='uploadPreview' style='height:180px; overflow:hidden; position:relative;'>"+n+"</div><hr class='mt20 mb20'></div>"),n.append($("<button class='b' style='margin-right:5px;'>Продолжить</button>").bind("click",function(){d()})),n.append($("<button>Отмена</button>").bind("click",function(){chat.alert.hide()})),chat.alert.show({code:1,hideOnClick:!1,descr:n}),$d.ready(function(){$("#uploadPreview").perfectScrollbar({includePadding:!1,minScrollbarLength:0,marginTop:0})})}else chat.alert.show(a)},onReady:function(t,e){var a=this;if(e||(e="siteParams"),"siteParams"==e&&(!supportStorage.isInit()||!chat.siteParams||!chat.siteParams.id)||"liteMode"==e&&chat.isLiteModeEnabled()){var i="liteMode"==e?1e3:5;return setTimeout(function(){a.onReady(t,e)},i)}t()}};chat.instanceID=chat.generateCode(20),function(){var t,e,a,i,r,n,s,o,c,l;t=chat.device,chat.device={},a=window.document.documentElement,l=window.navigator.userAgent.toLowerCase(),chat.device.ios=function(){return chat.device.iphone()||chat.device.ipod()||chat.device.ipad()},chat.device.iphone=function(){return i("iphone")},chat.device.ipod=function(){return i("ipod")},chat.device.ipad=function(){return i("ipad")},chat.device.android=function(){return i("android")},chat.device.androidPhone=function(){return chat.device.android()&&i("mobile")},chat.device.androidTablet=function(){return chat.device.android()&&!i("mobile")},chat.device.blackberry=function(){return i("blackberry")||i("bb10")||i("rim")},chat.device.blackberryPhone=function(){return chat.device.blackberry()&&!i("tablet")},chat.device.blackberryTablet=function(){return chat.device.blackberry()&&i("tablet")},chat.device.windows=function(){return i("windows")},chat.device.windowsPhone=function(){return chat.device.windows()&&i("phone")},chat.device.windowsTablet=function(){return!1},chat.device.fxos=function(){return(i("(mobile;")||i("(tablet;"))&&i("; rv:")},chat.device.fxosPhone=function(){return chat.device.fxos()&&i("mobile")},chat.device.fxosTablet=function(){return chat.device.fxos()&&i("tablet")},chat.device.meego=function(){return i("meego")},chat.device.cordova=function(){return window.cordova&&"file:"===location.protocol},chat.device.nodeWebkit=function(){return"object"==typeof window.process},chat.device.mobile=function(){return chat.device.androidPhone()||chat.device.iphone()||chat.device.ipod()||chat.device.windowsPhone()||chat.device.blackberryPhone()||chat.device.fxosPhone()||chat.device.meego()},chat.device.tablet=function(){return chat.device.ipad()||chat.device.androidTablet()||chat.device.blackberryTablet()||chat.device.windowsTablet()||chat.device.fxosTablet()},chat.device.desktop=function(){return!chat.device.tablet()&&!chat.device.mobile()},chat.device.portrait=function(){return window.innerHeight/window.innerWidth>1},chat.device.landscape=function(){return window.innerHeight/window.innerWidth<1},chat.device.noConflict=function(){return window.chat.device=t,this},i=function(t){return-1!==l.indexOf(t)},n=function(t){var e;return e=new RegExp(t,"i"),a.className.match(e)},e=function(t){return n(t)?void 0:a.className+=" "+t},o=function(t){return n(t)?a.className=a.className.replace(t,""):void 0},chat.device.ios()?chat.device.ipad()?e("ios ipad tablet"):chat.device.iphone()?e("ios iphone mobile"):chat.device.ipod()&&e("ios ipod mobile"):e(chat.device.android()?chat.device.androidTablet()?"android tablet":"android mobile":chat.device.blackberry()?chat.device.blackberryTablet()?"blackberry tablet":"blackberry mobile":chat.device.windows()?chat.device.windowsTablet()?"windows tablet":chat.device.windowsPhone()?"windows mobile":"desktop":chat.device.fxos()?chat.device.fxosTablet()?"fxos tablet":"fxos mobile":chat.device.meego()?"meego mobile":chat.device.nodeWebkit()?"node-webkit":"desktop"),chat.device.cordova()&&e("cordova"),r=function(){return chat.device.landscape()?(o("portrait"),e("landscape")):(o("landscape"),e("portrait"))},c="onorientationchange"in window,s=c?"orientationchange":"resize",window.addEventListener?window.addEventListener(s,r,!1):window.attachEvent?window.attachEvent(s,r):window[s]=r,r()}.call(this),chat.ie=function(){for(var t,e=3,a=document.createElement("div");a.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->",a.getElementsByTagName("i")[0];);return e>4?e:t}(),chat.server=window.location.protocol+"//"+window.location.hostname;var RPC={callbacks:{list:{},add:function(t){var e=chat.generateCode(20);return this.list[e]=t,e}},socket:null,post:function(t,e){this.socket.postMessage(JSON.stringify({action:t,data:e}))},get:function(t){t=JSON.parse(t),null!=RPC.actions[t.action]&&RPC.actions[t.action](t.data)},actions:{callback:function(t){t&&t.callbackID&&RPC.callbacks.list[t.callbackID]&&(RPC.callbacks.list[t.callbackID](t.data),delete RPC.callbacks.list[t.callbackID])},parentLocalStorageChanged:function(t){supportStorage.parentLocalStorageChanged(t.key,t.value)},getStorageValue:function(t){chat.onReady(function(){var e=storeWithExpiration.get(t.key+"::"+chat.siteParams.id);RPC.post("getStorageValueCallback",{value:e,callbackKey:t.callbackKey})})},setStorageValue:function(t){chat.onReady(function(){storeWithExpiration.set(t.key+"::"+chat.siteParams.id,t.value,t.expiration),t.callbackKey&&RPC.post("getStorageValueCallback",{callbackKey:t.callbackKey})})},init:function(t){chat.loading.start(t)},getCookieCallback:function(t){chat.cookie.callbacks[t.code](t.value)},close:function(){$h.removeClass("supportOpened").addClass("supportClosed")},alert:function(t){chat.openSupport(),chat.alert.show({descr:t.text})},loadInfoInt:null,loadInfoIntFunc:function(){$(".collectContactField:visible, .offlinePmLoading:visible").length&&(clearInterval(this.loadInfoInt),chat.tabs.loadClientFeedbackInfo())},open:function(){var t=this;if(chat.loadDelayedSrc(),chat.triggerBadge.empty(),$h.addClass("supportOpened").removeClass("supportClosed"),"reviews"==chat.tabs.currentType&&chat.rate.drawTab(),$("#inititalStyles").remove(),clearInterval(this.loadInfoInt),this.loadInfoInt=setInterval(function(){t.loadInfoIntFunc()},1e3),t.loadInfoIntFunc(),chat.windowResize(),!$("#chatTextarea").hasClass("init")){var e=function(t){var e=parseInt($(".chat").css("bottom")),a=$(".onlineChatTextarea").height()+3+parseInt($(".onlineChatTextarea").css("bottom")),i=$(".chat").scrollTop(),r=i+a-e;$(".chat").css("bottom",a).scrollTop(r)};$("#chatTextarea").addClass("init").placeholder().data("resize",e).trigger("textchange")}chat.messages.scrollBottom(),chat.ie&&setTimeout(function(){var t=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css",e.styleSheet.cssText=":before,:after{content:none !important}",t.appendChild(e),setTimeout(function(){t.removeChild(e)},0)},200);for(var a=1;a<10;a++)setTimeout(function(){$("#chatTextarea").keyup().trigger("textchange")},200*a);$("#chatTextarea").keyup().trigger("textchange"),chat.tabs.scrollable.update(),$("textarea:visible, #chatTextarea:visible").focus()},loadNewPage:function(t){chat.activity.close(),chat.siteParams.currentUrl=t.url,chat.siteParams.currentTitle=t.title,chat.activity.start()},getActivityActionUrl:function(t,e){var a="/"+t+"?",i=[];for(var r in e)i.push(r+"="+encodeURIComponent(e[r]));return a+=i.join("&")},queryActivityAction:function(t,e){var a=this;$("<img />").attr("src",a.getActivityActionUrl(t,e))},updateActivityAction:function(t){var e=this;if(chat.siteParams){null==t&&(t={});var a=chat.generateCode(5);chat.nodeAjax.send({simpleQuery:t.simpleQuery,url:this.getActivityActionUrl("writeMetalkUpdateActivityQueue",{random:a,orgID:chat.siteParams.orgID,siteID:chat.siteParams.id,pageID:chat.activity.pageID,talkID:chat.siteParams.talkID})},function(t){chat.operators.refresh(t)})}else setTimeout(function(){e.updateActivityAction(t)},5)},openReviewsTab:function(t){chat.tabs.openByType("reviews"),!t||t.form?chat.rate.showForm(!0):chat.rate.hideForm()},openByType:function(t){chat.tabs.openByType(t.type)},openTab:function(t){chat.tabs.open("tab"+parseInt(t.index))},showTab:function(t){chat.tabs.showTab(t)},setName:function(t){chat.onReady(function(){chat.client.get("descr")!=t.name&&$.post("/LAPI/me-talk/api.php",chat.getPostParams("setClientName",{name:t.name}),function(t){1==t.code&&chat.tabs.loadClientFeedbackInfoCallback(t.info)})})},setClientInfo:function(t){chat.onReady(function(){chat.setClientInfo(t)})},changeContacts:function(t){chat.onReady(function(){chat.changeContacts(t.contacts,t.name,t.important,t.custom)})},setCustomData:function(t){chat.onReady(function(){chat.setCustomData(t.data)})},lastUsedLess:{},updateLess:function(t){var e=this;if(null!=window.less){var a={"@triggerBackground":t.triggerBackground,"@triggerColor":t.triggerColor,"@triggerTextShadow":t.triggerTextShadow,"@font":t.font,"@defaultFontSize":t.defaultFontSize,"@linkColor":t.linkColor,"@linkHoverColor":t.linkHoverColor,"@buttonSaveBg":t.buttonSaveBg,"@buttonSaveColor":t.buttonSaveColor,"@operatorMessageBackground":t.operatorMessageBackground,"@operatorMessageColor":t.operatorMessageColor};for(var i in a)a[i]?e.lastUsedLess[i]=a[i]:e.lastUsedLess[i]?a[i]=e.lastUsedLess[i]:delete a[i];less.modifyVars(a);var r=$("#advancedStyles");0==r.length&&(r=$("<style id='advancedStyles'>").appendTo("body")),r.html(t.advanced)}else setTimeout(function(){e.updateLess(t)},5)},getContacts:function(t){chat.onReady(function(){var e=chat.client,a={name:e.get("descr"),phone:e.get("phone"),email:e.get("email"),skype:e.get("skype"),custom:e.get("customData")};RPC.post("getContactsCallback",a),t&&RPC.post("contactsUpdatedCallback",a)})},clearHistory:function(){chat.messages.history.clear()},setOperator:function(t){"object"!=typeof t.login&&(t.login=[t.login]),chat.onReady(function(){t.offlineModeIfOperatorNotExists?chat.operators.offlineModeIfOperatorNotExists=t.login:chat.operators.offlineModeIfOperatorNotExists=!1;for(var e=0;e<t.login.length;e++)if(chat.operators.isOnline(t.login[e])){chat.operators.setTalkWithOperator(t.login[e]),chat.operators.balancer.disable(),chat.operators.select({operator:t.login[e],group:t.group});break}chat.operators.refreshWithLastData()})},cometPublish:function(t){t.cid&&(null==cometPublish.stack[t.cid]&&(cometPublish.stack[t.cid]=[],cometPublish.cids.push(t.cid)),cometPublish.stack[t.cid].push(JSON.stringify(t.content)))},cometListen:function(t){chat.listen.start({cid:t.cid,callback:function(e){RPC.post("cometListen",{cid:t.cid,data:e})}})},sendMessage:function(t){t.text&&("online"==chat.chatMode?chat.messages.send(t.text,t.messageType,!0):($(".meTalkPM[name=text],.lcabPM[name=text]").val(t.text),chat.pm.metalk.send(!0)))},getBalancedOperator:function(t){chat.onReady(function(){$.post("/LAPI/me-talk/api.php",chat.getPostParams("getBalancedOperator",{exclude:t.exclude}),function(e){RPC.post("getStorageValueCallback",{value:e,callbackKey:t.callbackKey})})})},receiveMessage:function(t){if(t.text&&("online"==chat.chatMode||"simulation"==chat.siteParams.params.leadGen.mode)&&(t.operator&&(chat.operators.isOnline(t.operator)||(t.operator=!1)),t.operator||(t.operator=chat.operators.getCurrent()),t.operator)){var e=100;t.simulateTyping>0&&(e=t.simulateTyping,chat.messages.operatorTyping(t.operator,!1,e)),setTimeout(function(){$.post("/LAPI/me-talk/api.php",chat.getPostParams("sendMessageToClientBySupportAPI",{operator:t.operator,text:t.text,silent:t.simulateTyping==-1}),function(t){})},e)}},setTarget:function(t){chat.onReady(function(){chat.targetClient.send(t)})},mouseLeavePage:function(t){chat.actions.filters.set("mouseLeavePage",t.edge),setTimeout(function(){chat.actions.filters.get("mouseLeavePage")==t.edge&&chat.actions.filters.set("mouseLeavePage",null)},2e3)},setActionFilterValue:function(t){chat.onReady(function(){chat.actions.filters.set(t.name,t.value)})},browser:function(t){null!=chat.browser.rpcActions[t.action]?chat.browser.rpcActions[t.action](t):chat.log(t.action+" is unknown browser rpc action")}}},cometPublish={active:!1,stack:{},cids:[],postDone:function(){cometPublish.active=!1},send:function(){if(!cometPublish.active)for(var t in cometPublish.cids){var e=cometPublish.cids[t];if(cometPublish.stack[e].length){cometPublish.active=!0;var a="["+cometPublish.stack[e].join(",")+"]";cometPublish.stack[e]=[];var i="/cometPublish?cid="+e;$.post(i,a,cometPublish.postDone,"html").always(cometPublish.postDone).done(cometPublish.postDone).error(cometPublish.postDone),RPC.post("cometPublish",{url:i,data:a})}}}};setInterval(cometPublish.send,2e3);var Url={encode:function(t){return escape(this._utf8_encode(t))},decode:function(t){return this._utf8_decode(unescape(t)).replace(/\+/g," ")},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",a=0;a<t.length;a++){var i=t.charCodeAt(a);i<128?e+=String.fromCharCode(i):i>127&&i<2048?(e+=String.fromCharCode(i>>6|192),e+=String.fromCharCode(63&i|128)):(e+=String.fromCharCode(i>>12|224),e+=String.fromCharCode(i>>6&63|128),e+=String.fromCharCode(63&i|128))}return e},_utf8_decode:function(t){for(var e="",a=0,i=c1=c2=0;a<t.length;)i=t.charCodeAt(a),i<128?(e+=String.fromCharCode(i),a++):i>191&&i<224?(c2=t.charCodeAt(a+1),e+=String.fromCharCode((31&i)<<6|63&c2),a+=2):(c2=t.charCodeAt(a+1),c3=t.charCodeAt(a+2),e+=String.fromCharCode((15&i)<<12|(63&c2)<<6|63&c3),a+=3);return e}};if(function(t){function e(e){this.input=e,"password"==e.attr("type")&&this.handlePassword(),t(e[0].form).submit(function(){e.hasClass("placeholder")&&e[0].value==e.attr("placeholder")&&(e[0].value="")})}e.prototype={show:function(t){if(""===this.input[0].value||t&&this.valueIsPlaceholder()){if(this.isPassword)try{this.input[0].setAttribute("type","text")}catch(t){this.input.before(this.fakePassword.show()).hide()}this.input.addClass("placeholder"),this.input[0].value=this.input.attr("placeholder")}},hide:function(){if(this.valueIsPlaceholder()&&this.input.hasClass("placeholder")&&(this.input.removeClass("placeholder"),this.input[0].value="",this.isPassword)){try{this.input[0].setAttribute("type","password")}catch(t){}this.input.show(),this.input[0].focus()}},valueIsPlaceholder:function(){return this.input[0].value==this.input.attr("placeholder")},handlePassword:function(){var e=this.input;if(e.attr("realType","password"),this.isPassword=!0,t.browser.msie&&e[0].outerHTML){var a=t(e[0].outerHTML.replace(/type=(['"])?password\1/gi,"type=$1text$1"));this.fakePassword=a.val(e.attr("placeholder")).addClass("placeholder").focus(function(){e.trigger("focus"),t(this).hide()}),t(e[0].form).submit(function(){a.remove(),e.show()})}}};var a=!!("placeholder"in document.createElement("input"));t.fn.placeholder=function(){return a?this:this.each(function(){var a=t(this),i=new e(a);i.show(!0),a.focus(function(){i.hide()}),a.blur(function(){i.show(!1)}),t.browser.msie&&(t(window).load(function(){a.val()&&a.removeClass("placeholder"),i.show(!0)}),a.focus(function(){if(""==this.value){var t=this.createTextRange();t.collapse(!0),t.moveStart("character",0),t.select()}}))})}}(jQuery),$d.ready(function(){$d.bind("keyup",function(t){27==t.keyCode&&chat.overlay.hide()})}),$.ajaxSetup({cache:!1,retryLimit:100,tryCount:0,beforeSend:function(t,e){e.data&&e.data.indexOf("postuid")!=-1||e.url.indexOf("api.php")>-1&&(e.data+="&returnDataType="+e.dataType+"&postuid="+chat.generateCode(30))},error:function(t,e,a){if(("timeout"==e||200!=t.status)&&(this.tryCount++,this.tryCount<=this.retryLimit)){var i=this;setTimeout(function(){$.ajax(i)},5e3)}}}),jQuery.form={get:function(t,e,a,i){if(null==a&&(a=!1),null==e&&(e=!0),null==t||0==t.length)return e?JSON.stringify({}):{};var r="input."+t+":radio:checked,input."+t+":checkbox:checked,input."+t+":text,input."+t+":hidden,input."+t+":file,input."+t+":password,textarea."+t+",select."+t;if(null==i)var n=$(r);else var n=$(i).find(r);var s={};return $.each(n,function(){var t=$(this).attr("name"),e=$(this).attr("value");if(!($.isArray(e)&&null==e[0]||null==e)){if($(this).is("select")){var i=$(this).children("optgroup");if(0==i.length&&(i=$(this)),$(this).attr("multiple")){var e=[];$.each(frm.children("option[selected]"),function(){e[e.length]=$(this).attr("value")})}}if(a||$(this).is(":checkbox")){if($(this).is(":checkbox")&&!$(this).is(":checked"))return;null==s[t]&&(s[t]=new Array),s[t][s[t].length]=e}else s[t]=e}}),0==e?s:JSON.stringify(s)},uploadChange:function(t,e,a){$("input[key='"+t+"'][name='"+e+"']").attr("value",a)},removeUpload:function(t){$.each($(t),function(){var t=$(this).parent();t.is("form")&&($(this).removeAttr("key").unbind("click change").detach().appendTo(t.parent()),t.remove())})},makeUpload:function(t,e,a){var i=$(t);$.each(i,function(){var i={upload:"/upload.php",progress:"/progress",serverFileName:"%real%",directory:"",userParam:"",autoUpload:!0,multi:!1,wasMulti:!1,onSelect:function(){},onStart:function(){},onComplete:function(){},name:$(t).attr("name")};if(null==$(this).attr("key")){var r=new Date,n=r.getMilliseconds().toString()+r.getMinutes().toString()+r.getSeconds().toString()+Math.round(1e6*Math.random()).toString();i=$.extend(i,e),null==a?i.wasMulti=i.multi:i.wasMulti=!0,i.selector="[type=file][key="+n+"]",i.upload.indexOf("?")==-1?i.upload+="?":i.upload+="&",i.upload+="X-Progress-ID="+n,i.key=n,i.serverFileName_def=i.serverFileName,$(this).attr("key",n).change(function(){0==$("#submit_"+n).length&&($.form.intervals[n].onSelect($.form.intervals[n]),$(this).after("<input type=submit value='Загрузить' id=submit_"+n+" style='display:none;'>"),1==$.form.intervals[n].autoUpload&&$("#submit_"+n).click())}),$(this).wrap("<form key='"+n+'\' onsubmit="return $.form.uploadSelectedFile(this);" name=wfUpload_'+n+" action='"+i.upload+"' target=iframe_"+n+" enctype='multipart/form-data' method=post></form>"),$(this).parent().append("<input type=hidden name=key value='"+n+"'>"),$(this).before('<input type="hidden" name="UPLOAD_IDENTIFIER" value="'+n+'">');var s=$(this).parent(),o="<input type=hidden name='"+i.name+"_directory' key='"+n+"' value='"+i.directory+"'><input type=hidden name='"+i.name+"_serverFileName' key='"+n+"' value='"+i.serverFileName+"'><input type=hidden name='"+i.name+"_serverFileName_def' key='"+n+"' value='"+i.serverFileName_def+"'><input type=hidden name='"+i.name+"_path' key='"+n+"' value=''><input type=hidden name='inputName' key='"+n+"' value='"+i.name+"'><input type=hidden name='userParam' key='"+n+"' value='"+i.userParam+"'><input type=hidden name='"+i.name+"_isUploaded' key='"+n+"' value='0'><input type=hidden name='"+i.name+"_size' key='"+n+"' value=''><div uploaded=0 class=uploadDescr style='display:none' key='"+n+"'></div><iframe style='display:none;' onLoad=$.form.uploadComplete('"+n+"') name=iframe_"+n+" id=iframe_"+n+"></iframe>";$(s).append(o),null==$.form.intervals[n]&&($.form.intervals[n]=i)}})},uploadSelectedFile:function(t,e){var a={width:100,height:15};a=$.extend(a,e);var i=$(t).attr("key");$("#submit_"+i).attr("disabled","disabled");var r=$(t).children(".uploadDescr"),n={margin:"15px 0px"};$(r).html("<div class='progressbar ui-progressbar ui-widget ui-widget-content ui-corner-all' role='progressbar'><div class='ui-progressbar-value ui-widget-header ui-corner-left' style='display: block; width: 0%;'></div></div> <span style='text-align:right;' class=uploadedFileDetailInfo>Загрузка началась. Пожалуйста, подождите...</span>").css(n);var s=$(r).children("div.progressbar"),o=$($.form.intervals[i].selector).attr("value");o=o.split("\\"),$.form.intervals[i].realFileName=o[o.length-1],$.form.intervals[i].key=i,$.form.intervals[i].bar=s,$.form.intervals[i].span=r,r.show(),$($.form.intervals[i].span).attr("uploaded",0),$.form.intervals[i].onStart($.form.intervals[i]),$.form.intervals[i].interval=setInterval('$.form.uploadProgress("'+i+'")',1e3)},uploadProgress:function(key){$.form.intervals[key].progress&&$.ajax({error:function(t,e,a){},start:function(){},beforeSend:function(t){},url:$.form.intervals[key].progress,data:{"X-Progress-ID":key},dataType:"html",type:"get",success:function(data){if(data=eval(data),"uploading"==data.state){var total=data.size,bytes=data.received,percents=Math.round(100*bytes/total);$.form.intervals[key].size=total,$($.form.intervals[key].span).children(".uploadedFileDetailInfo").html("<b>"+percents+"%</b>, <i>загружено</i> <b>"+$.form.fsize(bytes)+"</b> <i>из</i> <b>"+$.form.fsize(total)+"</b>"),$.form.intervals[key].bar.children(".ui-progressbar-value").css("width",percents+"%")}data.result==-1&&($.form.intervals[key].size=data.size),0==data.result&&($.form.intervals[key].size=data.size,0==$($.form.intervals[key].span).attr("uploaded")&&$($.form.intervals[key].span).html("Сервер не поддерживает отображение процесса загрузки. Подождите завершения загрузки файла...")),$($.form.intervals[key].span).slideDown()}})},uploadCompleteAfterTimer:function(t){clearInterval($.form.intervals[t].interval);var e="false";$($.form.intervals[t].span).attr("uploaded",1),$("#submit_"+t).remove(),$(".uploadDescr[key="+t+"]").html("Загрузка завершена!");var a={size:e};$.form.intervals[t].onComplete(a),$(".customField").length>0&&core.customFieldChanged($(".customField").eq(0))},uploadComplete:function(t){setTimeout("$.form.uploadCompleteAfterTimer('"+t+"')",500)},intervals:{},fsize:function(t){return t=Math.round(t/1024),t<1e3?t+" Кб":(t=Math.round(100*t/1024)/100,t+" Мб")},speeds:function(t){return t=Math.round(t/1024),t<1e3?t+" Кб/сек":(t=Math.round(100*t/1024)/100,t+" Мб/сек")},str_replace:function(t,e,a,i){var r=0,n=0,s="",o="",c=0,l=0,h=[].concat(t),d=[].concat(e),u=a,p=d instanceof Array,f=u instanceof Array;for(u=[].concat(u),i&&(this.window[i]=0),r=0,c=u.length;r<c;r++)if(""!==u[r])for(n=0,l=h.length;n<l;n++)s=u[r]+"",o=p?void 0!==d[n]?d[n]:"":d[0],u[r]=s.split(h[n]).join(o),i&&u[r]!==s&&(this.window[i]+=(s.length-u[r].length)/h[n].length);return f?u:u[0]},set:function(t,e,a,i){if(null!=a){if($("."+t+"[name="+e+"][type=checkbox]").removeAttr("checked"),$("select."+t+"[name="+e+"]").children().removeAttr("selected"),$("."+t+"[name="+e+"][type=radio]").removeAttr("checked"),"object"!=typeof a&&(a=[a]),a.length<2)$("."+t+"[name="+e+"][type=text]").attr("value",a[0]),$("."+t+"[name="+e+"][type=password]").attr("value",a[0]),$("."+t+"[name="+e+"][type=hidden]").attr("value",a[0]),$("textarea."+t+"[name="+e+"]").attr("value",a[0]),$("select."+t+"[name="+e+"]").length>0&&$("select."+t+"[name="+e+"]").attr("value",a[0]);else for(var r=0;r<a.length;r++)$("."+t+"[name="+e+"][type=text]").eq(r).attr("value",a[r]),$("."+t+"[name="+e+"][type=password]").eq(r).attr("value",a[r]),$("."+t+"[name="+e+"][type=hidden]").eq(r).attr("value",a[r]),$("textarea."+t+"[name="+e+"]").eq(r).attr("value",a[r]),$("select."+t+"[name="+e+"]").length>0&&$("select."+t+"[name="+e+"]").eq(r).children("[value='"+a[r]+"']").attr("selected","selected");if($("input."+t+"[name="+e+"][type=radio]").length>0&&$("input."+t+"[name="+e+"][type=radio][value="+a[0]+"]").attr("checked","checked"),$("input."+t+"[name="+e+"][type=checkbox]").length>0)for(var r=0;r<=a.length;r++)$("input."+t+"[name="+e+"][type=checkbox][value='"+a[r]+"']").attr("checked","checked");i&&$("."+t+"[name="+e+"]").change()}}},function(){function t(){try{return o in n&&n[o]}catch(t){return!1}}function e(t){return function(){var e=Array.prototype.slice.call(arguments,0);e.unshift(i),l.appendChild(i),i.addBehavior("#default#userData"),i.load(o);var a=t.apply(r,e);return l.removeChild(i),a}}function a(t){return t.replace(d,"___")}var i,r={},n=window,s=n.document,o="localStorage",c="__storejs__";if(r.disabled=!1,r.set=function(t,e){},r.get=function(t){},r.remove=function(t){},r.clear=function(){},r.transact=function(t,e,a){var i=r.get(t);null==a&&(a=e,e=null),"undefined"==typeof i&&(i=e||{}),a(i),r.set(t,i)},r.getAll=function(){},r.serialize=function(t){return JSON.stringify(t)},r.deserialize=function(t){if("string"==typeof t)try{return JSON.parse(t)}catch(e){return t||void 0}},t())i=n[o],r.set=function(t,e){return void 0===e?r.remove(t):(i.setItem(t,r.serialize(e)),e)},r.get=function(t){return r.deserialize(i.getItem(t))},r.remove=function(t){i.removeItem(t)},r.clear=function(){i.clear()},r.getAll=function(){for(var t={},e=0;e<i.length;++e){var a=i.key(e);t[a]=r.get(a)}return t};else if(s.documentElement.addBehavior){var l,h;try{h=new ActiveXObject("htmlfile"),h.open(),h.write('<script>document.w=window</script><iframe src="/favicon.ico"></frame>'),h.close(),l=h.w.frames[0].document,i=l.createElement("div")}catch(t){i=s.createElement("div"),l=s.body}var d=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");r.set=e(function(t,e,i){return e=a(e),void 0===i?r.remove(e):(t.setAttribute(e,r.serialize(i)),t.save(o),i)}),r.get=e(function(t,e){return e=a(e),r.deserialize(t.getAttribute(e))}),r.remove=e(function(t,e){e=a(e),t.removeAttribute(e),t.save(o)}),r.clear=e(function(t){var e=t.XMLDocument.documentElement.attributes;t.load(o);for(var a,i=0;a=e[i];i++)t.removeAttribute(a.name);t.save(o)}),r.getAll=e(function(t){for(var e,i=t.XMLDocument.documentElement.attributes,n={},s=0;e=i[s];++s){var o=a(e.name);n[e.name]=r.deserialize(t.getAttribute(o))}return n})}try{r.set(c,c),r.get(c)!=c&&(r.disabled=!0),r.remove(c)}catch(t){r.disabled=!0}r.enabled=!r.disabled,"undefined"!=typeof module&&"function"!=typeof module?module.exports=r:"function"==typeof define&&define.amd?define(r):this.store=r}(),!store.disabled)try{var key="__test";localStorage.setItem(key,1),localStorage.removeItem(key)}catch(t){store.disabled=!0}var supportStorage={data:{},isTemporary:function(){if(store.disabled)return!0;document.cookie="cookietest=1";var t=document.cookie.indexOf("cookietest=")!=-1;return document.cookie="cookietest=1; expires=Thu, 01-Jan-1970 00:00:01 GMT",!t},localStorageAcessible:function(){var t=!0;try{null==window.localStorage&&(t=!1)}catch(e){t=!1}return t},_isInited:!1,isInit:function(){return this._isInited},fromParent:!1,init:function(t){var e=this,a=!1;if("function"!=typeof t&&(t=function(){}),this.isTemporary()||!this.localStorageAcessible()){var i=RPC.callbacks.add(function(i){if(1==i.code)store.disabled=!1,e.fromParent=!0,e.data=i.values,e._isInited=!0,t();else{store.disabled=!0,chat.nodeAjax.send({url:"/loadLocalStorage",method:"POST",data:JSON.stringify({talkID:chat.siteParams.talkID,orgID:chat.siteParams.orgID,siteID:chat.siteParams.id})},function(i){if(i&&(i=JSON.parse(i)))for(var r in i)var n=e.set(r,i[r],!0);e._isInited=!0,a=!0,t()});var r=3e4;setTimeout(function(){a||(t(),t=function(){})},r)}});RPC.post("localStorage_getAll",{callbackID:i,key:key})}else e._isInited=!0,t()},get:function(t){if(this.fromParent||store.disabled){var e=this.data[t];return"object"==typeof e&&null!=e?JSON.parse(JSON.stringify(e)):e}return store.get(t)},setTimeout:!1,setData:[],_rememberStoreByThisTab:{},rememberStoreByThisTab:function(t,e){this._rememberStoreByThisTab[t]=e},checkStoreByThisTab:function(t,e){return this._rememberStoreByThisTab[t]==e},saveToServerTimeout:null,saveToServer:function(t,e){if(this.isTemporary()&&(!store.disabled&&JSON.stringify(store.get(t))!=JSON.stringify(e)||store.disabled&&JSON.stringify(this.data[t])!=JSON.stringify(e))){var a=this;a.setData.push([t,e]),a.saveToServerTimeout||(clearTimeout(a.saveToServerTimeout),a.saveToServerTimeout=setTimeout(function(){a.saveToServerTimeout=null,a.makeSet()},500))}},parentLocalStorageChanged:function(t,e){null==e?(this.data[t]=null,delete this.data[t]):this.data[t]=e;for(var a=0;a<this.listeners.length;a++)this.listeners[a]({key:t,newValue:null==e?null:JSON.stringify(e)})},set:function(t,e,a){if(a||this.saveToServer(t,e),store.disabled)this.data[t]=e;else{if(this.rememberStoreByThisTab(t,e),!this.fromParent)return store.set(t,e);var i=RPC.callbacks.add(function(t){});this.data[t]=e,RPC.post("localStorage_set",{callbackID:i,key:t,value:e})}},makeSet:function(){var t=this,e=t.setData.length;if(e){for(var a={},i=0;i<e;i++){var r=t.setData.shift();a[r[0]]=r[1]}a=JSON.stringify(a),a.length&&"{}"!=a&&chat.nodeAjax.send({url:"/setLocalStorage",method:"POST",data:JSON.stringify({talkID:chat.siteParams.talkID,orgID:chat.siteParams.orgID,siteID:chat.siteParams.id,data:JSON.parse(a)})},function(t){})}},remove:function(t,e){if(e||this.saveToServer(t,null),store.disabled)null!=this.data[t]&&(this.data[t]=null,delete this.data[t]);else{if(!this.fromParent)return store.remove(t);this.data[t]=null,delete this.data[t];var a=RPC.callbacks.add(function(t){});RPC.post("localStorage_remove",{callbackID:a,key:t})}},getAll:function(){return store.disabled?this.data:store.getAll()},clearBySite:function(t,e){var a=e,i=this.getAll();for(var r in i)r.indexOf(a)!=-1&&this.remove(r)},listeners:[],setListener:function(t){"function"!=typeof window.addEventListener||this.fromParent||window.addEventListener("storage",t),this.listeners.push(t)}},storeWithExpiration={set:function(t,e,a,i){supportStorage.set(t,{val:e,exp:a,time:chat.now(),l:i},i)},get:function(t){var e=supportStorage.get(t);return e?null!=e.exp&&null!=e.time&&null!=e.val&&parseInt(e.exp)>0&&chat.now()-e.time>parseInt(e.exp)?(this.remove(t,e.l),null):null==e.val?e:e.val:null},remove:function(t,e){supportStorage.remove(t,e)}};!function(t){if(!t.ionSound){var e,a,i,r,n={},s={},o=!1,c=function(e){s[e]=new Audio,a=s[e].canPlayType("audio/ogg"),i="probably"===a||"maybe"===a?n.path+e+".ogg":n.path+e+".mp3",t(s[e]).prop("src",i),s[e].load(),s[e].volume=n.volume},l=function(t){var e,a=s[t];if("object"==typeof a&&null!==a)if(n.multiPlay||o){if(n.multiPlay){if(!a.ended)try{a.currentTime=0}catch(t){}a.play()}}else a.play(),o=!0,e=setInterval(function(){a.ended&&(clearInterval(e),o=!1)},250)};t.ionSound=function(a){if(n=t.extend({sounds:["water_droplet"],path:"static/sounds/",multiPlay:!0,volume:"0.5"},a),e=n.sounds.length,"function"==typeof Audio||"object"==typeof Audio)for(r=0;r<e;r+=1)c(n.sounds[r]);t.ionSound.play=function(t){l(t)}},t.ionSound.destroy=function(){for(r=0;r<e;r+=1)s[n.sounds[r]]=null;e=0,t.ionSound.play=function(){}}}}(jQuery),function(t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):t("object"==typeof exports?require("jquery"):jQuery)}(function(t){"use strict";function e(t){return"string"==typeof t?parseInt(t,10):~~t}var a={wheelSpeed:1,wheelPropagation:!1,swipePropagation:!0,minScrollbarLength:null,maxScrollbarLength:null,useBothWheelAxes:!1,useKeyboard:!0,suppressScrollX:!1,suppressScrollY:!1,scrollXMarginOffset:0,scrollYMarginOffset:0,includePadding:!1,marginTop:0},i=0,r=function(){var t=i++;return function(e){var a=".perfect-scrollbar-"+t;return"undefined"==typeof e?a:e+a}},n="WebkitAppearance"in document.documentElement.style;t.fn.perfectScrollbar=function(i,s){var o=t(this);return chat.ie&&chat.ie<9?o.css({overflowY:"auto"}):this.each(function(){function c(t,a){var i=t+a,r=x-_;E=i<0?0:i>r?r:i;var n=e(E*(O-x)/(x-_));o.scrollTop(n);
}function l(t,a){var i=t+a,r=I-A;R=i<0?0:i>r?r:i;var n=e(R*(D-I)/(I-A));o.scrollLeft(n)}function h(t){return P.minScrollbarLength&&(t=Math.max(t,P.minScrollbarLength)),P.maxScrollbarLength&&(t=Math.min(t,P.maxScrollbarLength)),t}function d(){var t={width:L};j?t.left=o.scrollLeft()+I-D:t.left=o.scrollLeft(),z?t.bottom=G-o.scrollTop():t.top=V+o.scrollTop(),B.css(t);var e={top:o.scrollTop(),height:N};Q?j?e.right=D-o.scrollLeft()-Y-q.outerWidth():e.right=Y-o.scrollLeft():j?e.left=o.scrollLeft()+2*I-D-Z-q.outerWidth():e.left=Z+o.scrollLeft(),X.css("margin-top",P.marginTop),X.css(e),U.css({left:R,width:A-K}),q.css({top:E,height:_-tt})}function u(){o.removeClass("ps-active-x"),o.removeClass("ps-active-y"),I=P.includePadding?o.innerWidth():o.width(),x=P.includePadding?o.innerHeight():o.height(),D=o.prop("scrollWidth"),O=o.prop("scrollHeight"),!P.suppressScrollX&&I+P.scrollXMarginOffset<D?(M=!0,L=I-J,A=h(e(L*I/D)),R=e(o.scrollLeft()*(L-A)/(D-I))):(M=!1,A=0,R=0,o.scrollLeft(0)),!P.suppressScrollY&&x+P.scrollYMarginOffset<O?(F=!0,N=x-et-P.marginTop,_=h(e(N*x/O)),E=e(o.scrollTop()*(N-_)/(O-x))):(F=!1,_=0,E=0,o.scrollTop(0)),R>=L-A&&(R=L-A),E>=N-_&&(E=N-_),d(),M&&o.addClass("ps-active-x"),F&&o.addClass("ps-active-y")}function p(){var e,a,i=function(t){l(e,t.pageX-a),u(),t.stopPropagation(),t.preventDefault()},r=function(e){B.removeClass("in-scrolling"),t(H).unbind(W("mousemove"),i)};U.bind(W("mousedown"),function(n){a=n.pageX,e=U.position().left,B.addClass("in-scrolling"),t(H).bind(W("mousemove"),i),t(H).one(W("mouseup"),r),n.stopPropagation(),n.preventDefault()}),e=a=null}function f(){var e,a,i=function(t){c(e,t.pageY-a),u(),t.stopPropagation(),t.preventDefault()},r=function(e){X.removeClass("in-scrolling"),t(H).unbind(W("mousemove"),i)};q.bind(W("mousedown"),function(n){a=n.pageY,e=q.position().top,X.addClass("in-scrolling"),t(H).bind(W("mousemove"),i),t(H).one(W("mouseup"),r),n.stopPropagation(),n.preventDefault()}),e=a=null}function m(t,e){var a=o.scrollTop();if(0===t){if(!F)return!1;if(0===a&&e>0||a>=O-x&&e<0)return!P.wheelPropagation}var i=o.scrollLeft();if(0===e){if(!M)return!1;if(0===i&&t<0||i>=D-I&&t>0)return!P.wheelPropagation}return!0}function g(t,e){var a=o.scrollTop(),i=o.scrollLeft(),r=Math.abs(t),n=Math.abs(e);if(n>r){if(e<0&&a===O-x||e>0&&0===a)return!P.swipePropagation}else if(r>n&&(t<0&&i===D-I||t>0&&0===i))return!P.swipePropagation;return!0}function v(){function t(t){var e=t.originalEvent.deltaX,a=-1*t.originalEvent.deltaY;return"undefined"!=typeof e&&"undefined"!=typeof a||(e=-1*t.originalEvent.wheelDeltaX/6,a=t.originalEvent.wheelDeltaY/6),t.originalEvent.deltaMode&&1===t.originalEvent.deltaMode&&(e*=10,a*=10),e!==e&&a!==a&&(e=0,a=t.originalEvent.wheelDelta),[e,a]}function e(e){if(n||!(o.find("select:focus").length>0)){var i=t(e),r=i[0],s=i[1];a=!1,P.useBothWheelAxes?F&&!M?(s?o.scrollTop(o.scrollTop()-s*P.wheelSpeed):o.scrollTop(o.scrollTop()+r*P.wheelSpeed),a=!0):M&&!F&&(r?o.scrollLeft(o.scrollLeft()+r*P.wheelSpeed):o.scrollLeft(o.scrollLeft()-s*P.wheelSpeed),a=!0):(o.scrollTop(o.scrollTop()-s*P.wheelSpeed),o.scrollLeft(o.scrollLeft()+r*P.wheelSpeed)),u(),a=a||m(r,s),a&&(e.stopPropagation(),e.preventDefault())}}var a=!1;"undefined"!=typeof window.onwheel?o.bind(W("wheel"),e):"undefined"!=typeof window.onmousewheel&&o.bind(W("mousewheel"),e)}function y(){var e=!1;o.bind(W("mouseenter"),function(t){e=!0}),o.bind(W("mouseleave"),function(t){e=!1});var a=!1;t(H).bind(W("keydown"),function(i){if((!i.isDefaultPrevented||!i.isDefaultPrevented())&&e){for(var r=document.activeElement?document.activeElement:H.activeElement;r.shadowRoot;)r=r.shadowRoot.activeElement;if(!t(r).is(":input,[contenteditable]")){var n=0,s=0;switch(i.which){case 37:n=-30;break;case 38:s=30;break;case 39:n=30;break;case 40:s=-30;break;case 33:s=90;break;case 32:case 34:s=-90;break;case 35:s=i.ctrlKey?-O:-x;break;case 36:s=i.ctrlKey?o.scrollTop():x;break;default:return}o.scrollTop(o.scrollTop()-s),o.scrollLeft(o.scrollLeft()+n),a=m(n,s),a&&i.preventDefault()}}})}function b(){function t(t){t.stopPropagation()}q.bind(W("click"),t),X.bind(W("click"),function(t){var a=e(_/2),i=t.pageY-X.offset().top-a,r=x-_,n=i/r;n<0?n=0:n>1&&(n=1),o.scrollTop((O-x)*n)}),U.bind(W("click"),t),B.bind(W("click"),function(t){var a=e(A/2),i=t.pageX-B.offset().left-a,r=I-A,n=i/r;n<0?n=0:n>1&&(n=1),o.scrollLeft((D-I)*n)})}function w(){function e(){var t=window.getSelection?window.getSelection():document.getSlection?document.getSlection():{rangeCount:0};return 0===t.rangeCount?null:t.getRangeAt(0).commonAncestorContainer}function a(){r||(r=setInterval(function(){return S()?(o.scrollTop(o.scrollTop()+n.top),o.scrollLeft(o.scrollLeft()+n.left),void u()):void clearInterval(r)},50))}function i(){r&&(clearInterval(r),r=null),B.removeClass("in-scrolling"),X.removeClass("in-scrolling")}var r=null,n={top:0,left:0},s=!1;t(H).bind(W("selectionchange"),function(a){t.contains(o[0],e())?s=!0:(s=!1,i())}),t(window).bind(W("mouseup"),function(t){s&&(s=!1,i())}),t(window).bind(W("mousemove"),function(t){if(s){var e={x:t.pageX,y:t.pageY},r=o.offset(),c={left:r.left,right:r.left+o.outerWidth(),top:r.top,bottom:r.top+o.outerHeight()};e.x<c.left+3?(n.left=-5,B.addClass("in-scrolling")):e.x>c.right-3?(n.left=5,B.addClass("in-scrolling")):n.left=0,e.y<c.top+3?(c.top+3-e.y<5?n.top=-5:n.top=-20,X.addClass("in-scrolling")):e.y>c.bottom-3?(e.y-c.bottom+3<5?n.top=5:n.top=20,X.addClass("in-scrolling")):n.top=0,0===n.top&&0===n.left?i():a()}})}function C(e,a){function i(t,e){o.scrollTop(o.scrollTop()-e),o.scrollLeft(o.scrollLeft()-t),u()}function r(t){y=!0}function n(t){y=!1}function s(t){return t.originalEvent.targetTouches?t.originalEvent.targetTouches[0]:t.originalEvent}function c(t){var e=t.originalEvent;return!(!e.targetTouches||1!==e.targetTouches.length)||!(!e.pointerType||"mouse"===e.pointerType||e.pointerType===e.MSPOINTER_TYPE_MOUSE)}function l(t){if(c(t)){b=!0;var e=s(t);p.pageX=e.pageX,p.pageY=e.pageY,f=chat.now(),null!==v&&clearInterval(v),t.stopPropagation()}}function h(t){if(!y&&b&&c(t)){var e=s(t),a={pageX:e.pageX,pageY:e.pageY},r=a.pageX-p.pageX,n=a.pageY-p.pageY;i(r,n),p=a;var o=chat.now(),l=o-f;l>0&&(m.x=r/l,m.y=n/l,f=o),g(r,n)&&(t.stopPropagation(),t.preventDefault())}}function d(t){!y&&b&&(b=!1,clearInterval(v),v=setInterval(function(){return S()?Math.abs(m.x)<.01&&Math.abs(m.y)<.01?void clearInterval(v):(i(30*m.x,30*m.y),m.x*=.8,void(m.y*=.8)):void clearInterval(v)},10))}var p={},f=0,m={},v=null,y=!1,b=!1;e&&(t(window).bind(W("touchstart"),r),t(window).bind(W("touchend"),n),o.bind(W("touchstart"),l),o.bind(W("touchmove"),h),o.bind(W("touchend"),d)),a&&(window.PointerEvent?(t(window).bind(W("pointerdown"),r),t(window).bind(W("pointerup"),n),o.bind(W("pointerdown"),l),o.bind(W("pointermove"),h),o.bind(W("pointerup"),d)):window.MSPointerEvent&&(t(window).bind(W("MSPointerDown"),r),t(window).bind(W("MSPointerUp"),n),o.bind(W("MSPointerDown"),l),o.bind(W("MSPointerMove"),h),o.bind(W("MSPointerUp"),d)))}function $(){o.bind(W("scroll"),function(t){u()})}function k(){o.unbind(W()),t(window).unbind(W()),t(H).unbind(W()),o.data("perfect-scrollbar",null),o.data("perfect-scrollbar-update",null),o.data("perfect-scrollbar-destroy",null),U.remove(),q.remove(),B.remove(),X.remove(),o=B=X=U=q=M=F=I=x=D=O=A=R=G=z=V=_=E=Y=Q=Z=j=W=null}function T(){u(),$(),p(),f(),b(),w(),v(),(at||it)&&C(at,it),P.useKeyboard&&y(),o.data("perfect-scrollbar",o),o.data("perfect-scrollbar-update",u),o.data("perfect-scrollbar-destroy",k)}var P=t.extend(!0,{},a);o.bind("touchmove",function(t){t.preventDefault()});var S=function(){return!!o};if("object"==typeof i?t.extend(!0,P,i):s=i,"update"===s)return o.data("perfect-scrollbar-update")&&o.data("perfect-scrollbar-update")(),o;if("destroy"===s)return o.data("perfect-scrollbar-destroy")&&o.data("perfect-scrollbar-destroy")(),o;if(o.data("perfect-scrollbar"))return o.data("perfect-scrollbar");o.addClass("ps-container");var I,x,D,O,M,A,R,L,F,_,E,N,j="rtl"===o.css("direction"),W=r(),H=this.ownerDocument||document,B=t("<div class='ps-scrollbar-x-rail'>").appendTo(o),U=t("<div class='ps-scrollbar-x'>").appendTo(B),G=e(B.css("bottom")),z=G===G,V=z?null:e(B.css("top")),K=e(B.css("borderLeftWidth"))+e(B.css("borderRightWidth")),J=e(B.css("marginLeft"))+e(B.css("marginRight")),X=t("<div class='ps-scrollbar-y-rail'>").appendTo(o),q=t("<div class='ps-scrollbar-y'>").appendTo(X),Y=e(X.css("right")),Q=Y===Y,Z=Q?null:e(X.css("left")),tt=e(X.css("borderTopWidth"))+e(X.css("borderBottomWidth")),et=e(X.css("marginTop"))+e(X.css("marginBottom")),at="ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,it=null!==window.navigator.msMaxTouchPoints;return T(),o})}}),$.fn.hasParent=function(t){t=$(t);var e=!1;return $(this[0]).parents().andSelf().each(function(){if($.inArray(this,t)!=-1)return e=!0,!1}),e},$(window).resize(function(){chat.windowResize()}),$d.ready(function(){$("[contenteditable]").live("paste",function(t){function e(t){window.document.execCommand("insertText",!1,t)}if(t.clipboardData||t.originalEvent&&t.originalEvent.clipboardData){t.preventDefault();var a=($(this),(t.clipboardData||t.originalEvent.clipboardData).items),i=[];for(index in a){var r=a[index];"file"===r.kind&&0==r.type.indexOf("image/")&&i.push(r)}var n=(t.originalEvent||t).clipboardData.getData("text/plain");if(n&&!i.length)e(n);else for(index in i){var r=i[index];if("file"===r.kind&&0==r.type.indexOf("image/")){var s="image.jpg",o=r.getAsFile(),c=new FileReader;c.onload=function(t){if(t.target.result){var a=$("<img />").attr("src",t.target.result);$("#uploadingImage").attr("src",t.target.result),$("#uploadingImages").fadeIn(),a.bind("load",function(){var t=convertImageToCanvas(this,1200),a=convertCanvasToImage(t,"jpeg",.5);a&&a.src&&(setTimeout(function(){$("#uploadingImages").fadeOut()},6e4),setTimeout(function(){$.post("/LAPI/misc/fileShare.php?action=upload",{filename:s,org:chat.siteParams.orgID,base64:a.src.split("base64,")[1]},function(t){if($("#uploadingImages").fadeOut(),1==t.code){var a=t.fullURL;e(a)}else chat.alert.show(t)},"json")},1e3))})}},c.readAsDataURL(o)}}}}),$(".dropdown-toggle").live("click",function(t){var e=$(this).data("dropdown");e?"string"==typeof e&&(e=$("#"+$(this).data("dropdown"))):e=$(this).next(".dropdown");var a=e.hasClass("dropdown-show");$(".dropdown-show").removeClass("dropdown-show").trigger("dropdown-hide"),a||(e.parent().hasClass("dropdown-toggle")?(e.hasClass("dropdown-right")?e.css("left",$(this).outerWidth()-e.outerWidth()):e.css("left",0),e.hasClass("dropdown-top")?e.css("bottom",$(this).outerHeight()+1):e.css("top",$(this).outerHeight()+1)):(e.hasClass("dropdown-right")?e.css("left",$(this).position().left+$(this).outerWidth()-e.outerWidth()):e.css("left",$(this).position().left),e.hasClass("dropdown-top")?e.css("bottom",$(this).position().top+$(this).outerHeight()+1):e.css("top",$(this).position().top+$(this).outerHeight()+1)),e.toggleClass("dropdown-show").trigger("dropdown-show")),t.stopPropagation()}),$("*").live("click",function(t){!$(this).not(".dropdown-toggle")||$(this).hasParent(".dropdown-toggle")||$(this).hasParent(".dropdown")?$(this).parent().is(".dropdown")&&t.stopPropagation():$(".dropdown-show").removeClass("dropdown-show").trigger("dropdown-hide")}),$(".bottom-tabs > ul > li").live("click",function(){$(this).hasClass("selected")||($(this).parent().children(".selected").removeClass("selected"),$(this).addClass("selected"),interfaceTabs.select($(this).data("id")))})});var interfaceTabs={select:function(t){var e=$("#"+t);if(e.length){var a=e.parent().children(".selected:not(#"+t+")");a.removeClass("selected"),$.each(a,function(){$(this).data("clear")&&$(this).empty()}),e.addClass("selected")}}};if(Date.prototype.toMysqlFormat=function(){return this.getFullYear()+"-"+twoDigits(1+this.getMonth())+"-"+twoDigits(this.getDate())+" "+twoDigits(this.getHours())+":"+twoDigits(this.getMinutes())+":"+twoDigits(this.getSeconds())},null==window.emojione)var emojione={unicodeToImage:function(t){return t},toShort:function(t){return t},toImage:function(t){return t},shortnameToUnicode:function(t){return t}};$.fn.calculateFirstVisible=function(t){return $.each(this,function(){t||(t=":not(.none)");var e=$(this).parent().children();if(e.length){e.removeClass("firstVisible lastVisible");var a=e.filter(t);a.length?(a.first().addClass("firstVisible"),a.last().addClass("lastVisible")):$(this).parent().addClass("none")}}),this},$.fn.myShow=function(){return $(this).removeClass("none").parent().removeClass("none"),$.each(this,function(){$(this).calculateFirstVisible()}),this},$.fn.myHide=function(){return $(this).addClass("none"),$.each(this,function(){$(this).calculateFirstVisible()}),this},$.fn.myToggle=function(){return $(this).toggleClass("none"),$.each(this,function(){$(this).calculateFirstVisible()}),this},window.emojiList=[{id:"smiles",icon:"icon-child",descr:"Смайлики",list:["😀","😬","😁","😂","😃","😄","😅","😆","😇","😉","😊","🙂","🙃","☺️","😋","😌","😍","😘","😗","😙","😚","😜","😝","😛","🤑","🤓","😎","🤗","😏","😶","😐","😑","😒","🙄","🤔","😳","😞","😟","😠","😡","😔","😕","🙁","☹️","😣","😖","😫","😩","😤","😮","😱","😨","😰","😯","😦","😧","😢","😥","😪","😓","😭","😵","😲","🤐","😷","🤒","🤕","😴","💤","💩","😈","👿","👍","👊","✊","✌️","👌","💋"]},{id:"nature",icon:"icon-tree",descr:"Животные и природа",list:["🐶","🐱","🐭","🐹","🐰","🐻","🐼","🐨","🐯","🦁","🐮","🐷","🐽","🐸","🐙","🐵","🙈","🙉","🙊","🐒","🐔","🐧","🐦","🐤","🐣","🐥","🐺","🐗","🐴","🦄","🐝","🐛","🐌","🐞","🐜","🕷","🦂","🦀","🐍","🐢","🐠","🐟","🐡","🐬","🐳"]},{id:"food",icon:"icon-glass",descr:"Еда и напитки",list:["🍏","🍎","🍐","🍊","🍋","🍌","🍉","🍇","🍓","🍈","🍒","🍑","🍍","🍅","🍆","🌶","🌽","🍠","🍯","🍞","🧀","🍗","🍖","🍤","🍳","🍔","🍟","🌭","🍕","🍝","🌮","🌯","🍜","🍲","🍥","🍣","🍱","🍛","🍙","🍚","🍘","🍢","🍡","🍧","🍨","🍦","🍰","🎂","🍮","🍬","🍭","🍫","🍿","🍩","🍪","🍺","🍻","🍷","🍸","🍹","🍾","🍶","🍵","☕️","🍼","🍴","🍽"]},{id:"sport",icon:"icon-futbol-o",descr:"Увлечения и спорт",list:["⚽️","🏀","🏈","⚾️","🎾","🏐","🏉","🎱","⛳️","🏌","🏓","🏸","🏒","🏑","🏏","🎿","⛷","🏂","⛸","🏹","🎣","🚣","🏊","🏄","🛀","⛹","🏋","🚴","🚵","🏇","🕴","🏆","🎽","🏅","🎖","🎗","🏵","🎫","🎟","🎭","🎨","🎪","🎤","🎧","🎼","🎹","🎷","🎺","🎸","🎻","🎬","🎮","👾","🎯","🎲","🎰","🎳"]}],!function(t,e,a,i,r,n){function s(t,e){var a=typeof t[e];return"function"==a||!("object"!=a||!t[e])||"unknown"==a}function o(t,e){return!("object"!=typeof t[e]||!t[e])}function c(t){return"[object Array]"===Object.prototype.toString.call(t)}function l(){if(!j){j=!0;for(var t=0;t<W.length;t++)W[t]();W.length=0}}function h(t,e){return j?void t.call(e):void W.push(function(){t.call(e)})}function d(){var t=parent;if(""!==R)for(var e=0,a=R.split(".");e<a.length;e++)t=t[a[e]];return t.easyXDM}function u(e){return t.easyXDM=F,R=e,R&&(_="easyXDM_"+R.replace(".","_")+"_"),L}function p(t){var e=t.toLowerCase().match(O),a=e[2],i=e[3],r=e[4]||"";return("http:"==a&&":80"==r||"https:"==a&&":443"==r)&&(r=""),a+"//"+i+r}function f(t){if(t=t.replace(A,"$1/"),!t.match(/^(http||https):\/\//)){var e="/"===t.substring(0,1)?"":a.pathname;"/"!==e.substring(e.length-1)&&(e=e.substring(0,e.lastIndexOf("/")+1)),t=a.protocol+"//"+a.host+e+t}for(;M.test(t);)t=t.replace(M,"");return t}function m(t,e){var a="",i=t.indexOf("#");-1!==i&&(a=t.substring(i),t=t.substring(0,i));var r=[];for(var s in e)e.hasOwnProperty(s)&&r.push(s+"="+n(e[s]));return t+(E?"#":-1==t.indexOf("?")?"?":"&")+r.join("&")+a}function g(t){return void 0===t}function v(t,e,a){var i;for(var r in e)e.hasOwnProperty(r)&&(r in t?(i=e[r],"object"==typeof i?v(t[r],i,a):a||(t[r]=e[r])):t[r]=e[r]);return t}function y(){var t=e.body.appendChild(e.createElement("form")),a=t.appendChild(e.createElement("input"));a.name=_+"TEST"+x,T=a!==t.elements[a.name],e.body.removeChild(t)}function b(t){g(T)&&y();var a;T?a=e.createElement('<iframe name="'+t.props.name+'"/>'):(a=e.createElement("IFRAME"),a.name=t.props.name),a.id=a.name=t.props.name,delete t.props.name,"string"==typeof t.container&&(t.container=e.getElementById(t.container)),t.container||(v(a.style,{position:"absolute",top:"-2000px",left:"0px"}),t.container=e.body);var i=t.props.src;if(t.props.src="javascript:false",v(a,t.props),a.border=a.frameBorder=0,a.allowTransparency=!0,t.container.appendChild(a),t.onLoad&&P(a,"load",t.onLoad),t.usePost){var r,n=t.container.appendChild(e.createElement("form"));if(n.target=a.name,n.action=i,n.method="POST","object"==typeof t.usePost)for(var s in t.usePost)t.usePost.hasOwnProperty(s)&&(T?r=e.createElement('<input name="'+s+'"/>'):(r=e.createElement("INPUT"),r.name=s),r.value=t.usePost[s],n.appendChild(r));n.submit(),n.parentNode.removeChild(n)}else a.src=i;return t.props.src=i,a}function w(t,e){"string"==typeof t&&(t=[t]);for(var a,i=t.length;i--;)if(a=t[i],a=RegExp("^"==a.substr(0,1)?a:"^"+a.replace(/(\*)/g,".$1").replace(/\?/g,".")+"$"),a.test(e))return!0;return!1}function C(i){var r,n=i.protocol;if(i.isHost=i.isHost||g(B.xdm_p),E=i.hash||!1,i.props||(i.props={}),i.isHost)i.remote=f(i.remote),i.channel=i.channel||"default"+x++,i.secret=Math.random().toString(16).substring(2),g(n)&&(n=p(a.href)==p(i.remote)?"4":s(t,"postMessage")||s(e,"postMessage")?"1":"0");else if(i.channel=B.xdm_c.replace(/["'<>\\]/g,""),i.secret=B.xdm_s,i.remote=B.xdm_e.replace(/["'<>\\]/g,""),n=B.xdm_p,i.acl&&!w(i.acl,i.remote))throw Error("Access denied for "+i.remote);switch(i.protocol=n,n){case"1":r=[new L.stack.PostMessageTransport(i)];break;case"4":r=[new L.stack.SameOriginTransport(i)]}return r.push(new L.stack.QueueBehavior({lazy:i.lazy,remove:!0})),r}function $(t){for(var e,a={incoming:function(t,e){this.up.incoming(t,e)},outgoing:function(t,e){this.down.outgoing(t,e)},callback:function(t){this.up.callback(t)},init:function(){this.down.init()},destroy:function(){this.down.destroy()}},i=0,r=t.length;r>i;i++)e=t[i],v(e,a,!0),0!==i&&(e.down=t[i-1]),i!==r-1&&(e.up=t[i+1]);return e}function k(t){t.up.down=t.down,t.down.up=t.up,t.up=t.down=null}var T,P,S,I=this,x=Math.floor(1e4*Math.random()),D=Function.prototype,O=/^((http.?:)\/\/([^:\/\s]+)(:\d+)*)/,M=/[\-\w]+\/\.\.\//,A=/([^:])\/\//g,R="",L={},F=t.easyXDM,_="easyXDM_",E=!1;if(s(t,"addEventListener"))P=function(t,e,a){t.addEventListener(e,a,!1)},S=function(t,e,a){t.removeEventListener(e,a,!1)};else{if(!s(t,"attachEvent"))throw Error("Browser not supported");P=function(t,e,a){t.attachEvent("on"+e,a)},S=function(t,e,a){t.detachEvent("on"+e,a)}}var N,j=!1,W=[];if("readyState"in e?(N=e.readyState,j="complete"==N||~navigator.userAgent.indexOf("AppleWebKit/")&&("loaded"==N||"interactive"==N)):j=!!e.body,!j){if(s(t,"addEventListener"))P(e,"DOMContentLoaded",l);else if(P(e,"readystatechange",function(){"complete"==e.readyState&&l()}),e.documentElement.doScroll&&t===top){var H=function(){if(!j){try{e.documentElement.doScroll("left")}catch(t){return void i(H,1)}l()}};H()}P(t,"load",l)}var B=function(t){t=t.substring(1).split("&");for(var e,a={},i=t.length;i--;)e=t[i].split("="),a[e[0]]=r(e[1]);return a}(/xdm_e=/.test(a.search)?a.search:a.hash),U=function(){var t={},e={a:[1,2,3]},a='{"a":[1,2,3]}';return"undefined"!=typeof JSON&&"function"==typeof JSON.stringify&&JSON.stringify(e).replace(/\s/g,"")===a?JSON:(Object.toJSON&&Object.toJSON(e).replace(/\s/g,"")===a&&(t.stringify=Object.toJSON),"function"==typeof String.prototype.evalJSON&&(e=a.evalJSON(),e.a&&3===e.a.length&&3===e.a[2]&&(t.parse=function(t){return t.evalJSON()})),t.stringify&&t.parse?(U=function(){return t},t):null)};v(L,{version:"2.4.20.7",query:B,stack:{},apply:v,getJSONObject:U,whenReady:h,noConflict:u}),L.DomHelper={on:P,un:S,requiresJSON:function(a){o(t,"JSON")||e.write('<script type="text/javascript" src="'+a+'"></script>')}},function(){var t={};L.Fn={set:function(e,a){t[e]=a},get:function(e,a){if(t.hasOwnProperty(e)){var i=t[e];return a&&delete t[e],i}}}}(),L.Socket=function(t){var e=$(C(t).concat([{incoming:function(e,a){t.onMessage(e,a)},callback:function(e){t.onReady&&t.onReady(e)}}])),a=p(t.remote);this.origin=p(t.remote),this.destroy=function(){e.destroy()},this.postMessage=function(t){e.outgoing(t,a)},e.init()},L.Rpc=function(t,e){if(e.local)for(var a in e.local)if(e.local.hasOwnProperty(a)){var i=e.local[a];"function"==typeof i&&(e.local[a]={method:i})}var r=$(C(t).concat([new L.stack.RpcBehavior(this,e),{callback:function(e){t.onReady&&t.onReady(e)}}]));this.origin=p(t.remote),this.destroy=function(){r.destroy()},r.init()},L.stack.SameOriginTransport=function(t){var e,r,n,s;return e={outgoing:function(t,e,a){n(t),a&&a()},destroy:function(){r&&(r.parentNode.removeChild(r),r=null)},onDOMReady:function(){s=p(t.remote),t.isHost?(v(t.props,{src:m(t.remote,{xdm_e:a.protocol+"//"+a.host+a.pathname,xdm_c:t.channel,xdm_p:4}),name:_+t.channel+"_provider"}),r=b(t),L.Fn.set(t.channel,function(t){return n=t,i(function(){e.up.callback(!0)},0),function(t){e.up.incoming(t,s)}})):(n=d().Fn.get(t.channel,!0)(function(t){e.up.incoming(t,s)}),i(function(){e.up.callback(!0)},0))},init:function(){h(e.onDOMReady,e)}}},L.stack.PostMessageTransport=function(e){function r(t){if(t.origin)return p(t.origin);if(t.uri)return p(t.uri);if(t.domain)return a.protocol+"//"+t.domain;throw"Unable to retrieve the origin of the event"}function n(t){if("string"==typeof t.data){var a=r(t);a==d&&t.data.substring(0,e.channel.length+1)==e.channel+" "&&o.up.incoming(t.data.substring(e.channel.length+1),a)}}function s(a){a.data==e.channel+"-ready"&&(l="postMessage"in c.contentWindow?c.contentWindow:c.contentWindow.document,S(t,"message",s),P(t,"message",n),i(function(){o.up.callback(!0)},0))}var o,c,l,d;return o={outgoing:function(t,a,i){l.postMessage(e.channel+" "+t,a||d),i&&i()},destroy:function(){S(t,"message",s),S(t,"message",n),c&&(l=null,c.parentNode.removeChild(c),c=null)},onDOMReady:function(){d=p(e.remote),e.isHost?(P(t,"message",s),v(e.props,{src:m(e.remote,{xdm_e:p(a.href),xdm_c:e.channel,xdm_p:1}),name:_+e.channel+"_provider"}),c=b(e)):(P(t,"message",n),l="postMessage"in t.parent?t.parent:t.parent.document,l.postMessage(e.channel+"-ready",d),i(function(){o.up.callback(!0)},0))},init:function(){h(o.onDOMReady,o)}}},L.stack.ReliableBehavior=function(){var t,e,a=0,i=0,r="";return t={incoming:function(n,s){var o=n.indexOf("_"),c=n.substring(0,o).split(",");n=n.substring(o+1),c[0]==a&&(r="",e&&e(!0)),n.length>0&&(t.down.outgoing(c[1]+","+a+"_"+r,s),i!=c[1]&&(i=c[1],t.up.incoming(n,s)))},outgoing:function(n,s,o){r=n,e=o,t.down.outgoing(i+","+ ++a+"_"+n,s)}}},L.stack.QueueBehavior=function(t){function e(){if(t.remove&&0===o.length)return void k(a);if(!c&&0!==o.length&&!s){c=!0;var r=o.shift();a.down.outgoing(r.data,r.origin,function(t){c=!1,r.callback&&i(function(){r.callback(t)},0),e()})}}var a,s,o=[],c=!0,l="",h=0,d=!1,u=!1;return a={init:function(){g(t)&&(t={}),t.maxLength&&(h=t.maxLength,u=!0),t.lazy?d=!0:a.down.init()},callback:function(t){c=!1;var i=a.up;e(),i.callback(t)},incoming:function(e,i){if(u){var n=e.indexOf("_"),s=parseInt(e.substring(0,n),10);l+=e.substring(n+1),0===s&&(t.encode&&(l=r(l)),a.up.incoming(l,i),l="")}else a.up.incoming(e,i)},outgoing:function(i,r,s){t.encode&&(i=n(i));var c,l=[];if(u){for(;0!==i.length;)c=i.substring(0,h),i=i.substring(c.length),l.push(c);for(;c=l.shift();)o.push({data:l.length+"_"+c,origin:r,callback:0===l.length?s:null})}else o.push({data:i,origin:r,callback:s});d?a.down.init():e()},destroy:function(){s=!0,a.down.destroy()}}},L.stack.VerifyBehavior=function(t){function e(){i=Math.random().toString(16).substring(2),a.down.outgoing(i)}var a,i,r;return a={incoming:function(n,s){var o=n.indexOf("_");-1===o?n===i?a.up.callback(!0):r||(r=n,t.initiate||e(),a.down.outgoing(n)):n.substring(0,o)===r&&a.up.incoming(n.substring(o+1),s)},outgoing:function(t,e,r){a.down.outgoing(i+"_"+t,e,r)},callback:function(){t.initiate&&e()}}},L.stack.RpcBehavior=function(t,e){function a(t){t.jsonrpc="2.0",n.down.outgoing(s.stringify(t))}function i(t,e){var i=Array.prototype.slice;return function(){var r,n=arguments.length,s={method:e};n>0&&"function"==typeof arguments[n-1]?(n>1&&"function"==typeof arguments[n-2]?(r={success:arguments[n-2],error:arguments[n-1]},s.params=i.call(arguments,0,n-2)):(r={success:arguments[n-1]},s.params=i.call(arguments,0,n-1)),l[""+ ++o]=r,s.id=o):s.params=i.call(arguments,0),t.namedParams&&1===s.params.length&&(s.params=s.params[0]),a(s)}}function r(t,e,i,r){if(!i)return void(e&&a({id:e,error:{code:-32601,message:"Procedure not found."}}));var n,s;e?(n=function(t){n=D,a({id:e,result:t})},s=function(t,i){s=D;var r={id:e,error:{code:-32099,message:t}};i&&(r.error.data=i),a(r)}):n=s=D,c(r)||(r=[r]);try{var o=i.method.apply(i.scope,r.concat([n,s]));g(o)||n(o)}catch(t){s(t.message)}}var n,s=e.serializer||U(),o=0,l={};return n={incoming:function(t){var i=s.parse(t);if(i.method)e.handle?e.handle(i,a):r(i.method,i.id,e.local[i.method],i.params);else{var n=l[i.id];i.error?n.error&&n.error(i.error):n.success&&n.success(i.result),delete l[i.id]}},init:function(){if(e.remote)for(var a in e.remote)e.remote.hasOwnProperty(a)&&(t[a]=i(e.remote[a],a));n.down.init()},destroy:function(){for(var a in e.remote)e.remote.hasOwnProperty(a)&&t.hasOwnProperty(a)&&delete t[a];n.down.destroy()}}},I.easyXDM=L}(window,document,location,window.setTimeout,decodeURIComponent,encodeURIComponent);
