# Ansible managed
#########################################################
# configuration for https-site:
# site_name:                 default
# site_root:                 /home/bitrix/www
# site_composite:            enable
# site_composite_id:         02
# site_composite_var:        $is_site_composite_02
# site_composite_storage:    files
# web_cluster:               disable
##########################################################
server {
  listen 443 default_server http2;
  server_name _;

  access_log /var/log/nginx/default_access.log main;
  error_log  /var/log/nginx/default_error.log warn;
  
  # Enable SSL connection
  include bx/conf/ssl.conf;

  set $docroot		"/home/bitrix/www";
  root            "/home/bitrix/www";
  proxy_ignore_client_abort off;
  index index.php;
  
  server_name_in_redirect off;

  set $proxyserver	"http://127.0.0.1:8888";
  proxy_set_header	X-Forwarded-For    $proxy_add_x_forwarded_for;
  proxy_set_header	X-Real-IP          $remote_addr;
  proxy_set_header	Host               $host:443;
  proxy_set_header  X-Forwarded-Host   $host;
  proxy_set_header  X-Forwarded-Scheme $scheme;
  proxy_set_header  HTTPS YES;
  
  
  # composite variables
  set $composite_cache    "bitrix/html_pages/${host}${composite_key}/index@${args}.html";
  set $composite_file     "${docroot}/${composite_cache}";
  
  # config file
  set $composite_enabled  "${docroot}/bitrix/html_pages/.enabled";
  # if test pass through general tests:
  set $use_composite_cache "";
  # global site test, the same for all sites on the server
  if ($is_global_composite  = 1) {set $use_composite_cache "A";}
  # personal site tests, generated by site config
  if ($is_site_composite_02 = 1) {set $use_composite_cache "${use_composite_cache}B";}

  # Include parameters common to all websites
  include bx/conf/bitrix_general.conf;

  # main location with processing composite
  location / {
    
    if (-f $composite_enabled)     { set $use_composite_cache "${use_composite_cache}C"; }
    
    # test cache file exists
    if (-f $composite_file)  { set $use_composite_cache "${use_composite_cache}D"; }

    if ($use_composite_cache = "ABCD") { rewrite .* /$composite_cache last; }
    proxy_pass $proxyserver;
  }

  
  # Include munin and nagios web
  include bx/server_monitor.conf;
}
